{% load static %}
<head>
    <link rel="stylesheet" href="{% static 'css/nav.css' %}?v=2.0">
    {% if debug %}
        <script src="https://cdn.tailwindcss.com"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    {% else %}
        <script src="{% static 'vendor/tailwind.full.min.js' %}"></script>
        <script src="{% static 'vendor/jquery.min.js' %}"></script>
    {% endif %}
</head>

<style>
    :root {
        --color-bg: #0F0818;
        --color-surface: rgba(30, 24, 48, 0.5);
        --color-border: rgba(97, 109, 240, 0.2);
        --color-text-primary: #f0f0f0;
        --color-text-secondary: #a0a0b0;
        --color-accent-primary: #616DF0;
        --color-accent-secondary: #70dd60;
        --border-radius: 32px;
    }

    /* --- –°–ù–ï–ì–û–ü–ê–î --- */
    #snow-container {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        pointer-events: none;
        z-index: -1;
        transition: opacity 0.5s ease-in-out;
    }

    #snow-container:not(.snow-active) {
        opacity: 0;
    }

    .snowflake {
        position: absolute;
        top: -10px;
        background: white;
        border-radius: 50%;
        animation: fall linear infinite;
    }

    .layer1 { width: 1px; height: 1px; animation-duration: 20s; }
    .layer2 { width: 2px; height: 2px; animation-duration: 30s; opacity: 0.7; }
    .layer3 { width: 3px; height: 3px; animation-duration: 40s; opacity: 0.5; }

    @keyframes fall {
        to {
            transform: translateY(100vh);
        }
    }
</style>

<div id="snow-container"></div>
<button id="snow-toggle" 
        class="fixed bottom-5 right-5 z-[10000] 
                w-10 h-10 flex items-center justify-center 
                bg-[var(--color-surface)] backdrop-blur-md 
                rounded-full border border-[var(--color-border)] 
                text-[var(--color-text-secondary)] hover:text-white
                transition-all duration-300">
    <i class="fas fa-snowflake"></i>
</button>

<header class="sticky top-4 z-40 max-w-3xl sm:max-w-[80%] mx-auto">
    <div class="relative">
        
        <!-- –û—Å–Ω–æ–≤–Ω–∞—è –ø–∞–Ω–µ–ª—å —Ö–µ–¥–µ—Ä–∞ -->
        <div class="flex items-center justify-between gap-4 
                    bg-[var(--color-surface)]/80 backdrop-blur-xl 
                    rounded-[32px] border border-[var(--color-border)] 
                    pl-4 pr-4 py-2 shadow-2xl shadow-black/50">
            
            <!-- –õ–æ–≥–æ—Ç–∏–ø -->
           <div class="logo-header w-32 h-auto transition-opacity duration-150 hover:opacity-75" id="pulse-trigger">
                <a href="{% url 'create' %}">
                    <img src="{% static 'img/logo-header-alt-pulse.png' %}" alt="">
                </a>
            </div>
            
            <!-- –ö–Ω–æ–ø–∫–∞ –≤—ã–∑–æ–≤–∞ –º–µ–Ω—é -->
            <div class="flex-shrink-0">
                <button id="action-menu-btn" 
                        class="h-12 w-12 flex items-center justify-center bg-black/20 rounded-full 
                               hover:bg-black/40 transition-colors transition-transform active:scale-[.95]">
                    <i class="fas fa-ellipsis-h text-white/80"></i>
                </button>
            </div>
        </div>

        <div id="action-menu" class="hidden absolute top-full right-0 mt-2 w-64
                                    bg-[var(--color-surface)]/90 backdrop-blur-xl 
                                    rounded-3xl border border-[var(--color-border)]
                                    p-2 shadow-2xl shadow-black/50
                                    origin-top-right transition-all duration-200 ease-out 
                                    transform opacity-0 scale-95 z-50">
            <nav class="flex flex-col">
                {% if username %}
                    <a href="{% url 'create' %}" class="menu-item">
                        <i class="fas fa-plus w-5 text-center"></i>
                        <span>–°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç</span>
                    </a>
                    <a href="{% url 'history' %}" class="menu-item">
                        <i class="fas fa-history w-5 text-center"></i>
                        <span>–ò—Å—Ç–æ—Ä–∏—è —Ç–µ—Å—Ç–æ–≤</span>
                    </a>
                    <a href="{% url 'profile_redirect' %}" class="menu-item">
                        <i class="fas fa-user-circle w-5 text-center"></i>
                        <span>–ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å</span>
                    </a>
                    <hr class="border-t border-[var(--color-border)] my-1">
                    <a href="{% url 'arena' %}" class="menu-item">
                        <i class="fa-solid fa-jet-fighter-up w-5 text-center"></i>
                        <span>–°—Ä–∞–∑–∏—Ç—å—Å—è –Ω–∞ –ê—Ä–µ–Ω–µ!</span>
                    </a>

                    {% if subscription_level < 1 or subscription_level == 99 %}
                        <hr class="border-t border-[var(--color-border)] my-1">
                        <a href="{% url 'payment' %}" class="menu-item text-[var(--color-accent-secondary)] font-bold">
                            <i class="fas fa-gem w-5 text-center"></i>
                            <span>–ö—É–ø–∏—Ç—å –ü—Ä–µ–º–∏—É–º</span>
                        </a>
                    {% endif %}

                    <hr class="border-t border-[var(--color-border)] my-1">
                    <a href="{% url 'logout' %}" class="menu-item text-red-400">
                        <i class="fas fa-sign-out-alt w-5 text-center"></i>
                        <span>–í—ã–π—Ç–∏</span>
                    </a>

                {% else %}
                    <!-- –≠—Ç–æ –±–ª–æ–∫ –¥–ª—è –Ω–µ–∑–∞–ª–æ–≥–∏–Ω–µ–Ω–Ω—ã—Ö —é–∑–µ—Ä–æ–≤, –µ—Å–ª–∏ —Ö–µ–¥–µ—Ä –±—É–¥–µ—Ç –∏ –¥–ª—è –Ω–∏—Ö -->
                    <a href="/" class="menu-item"><i class="fas fa-home w-5 text-center"></i><span>–ù–∞ –≥–ª–∞–≤–Ω—É—é</span></a>
                    <a href="{% url 'login' %}" class="block text-center bg-[var(--color-accent-primary)] text-white px-5 py-3 font-bold rounded-3xl mt-1">
                        –í–æ–π—Ç–∏
                    </a>
                {% endif %}
            </nav>
        </div>
    </div>
    <!-- <script src="{% static 'js/nav.js' %}"></script> -->
     <script>
        document.addEventListener('DOMContentLoaded', function () {
            const menuButton = document.getElementById('action-menu-btn');
            const menu = document.getElementById('action-menu');

            if (menuButton && menu) {
                menuButton.addEventListener('click', function (event) {
                    event.stopPropagation();
                    menu.classList.toggle('hidden');
                    // –ü–ª–∞–≤–Ω–æ–µ –ø–æ—è–≤–ª–µ–Ω–∏–µ
                    setTimeout(() => {
                        menu.classList.toggle('opacity-0');
                        menu.classList.toggle('scale-95');
                    }, 10);
                });

                // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–µ–Ω—é –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ –µ–≥–æ
                document.addEventListener('click', function (event) {
                    if (!menu.contains(event.target) && !menuButton.contains(event.target)) {
                        if (!menu.classList.contains('hidden')) {
                            menu.classList.add('opacity-0', 'scale-95');
                            setTimeout(() => menu.classList.add('hidden'), 200);
                        }
                    }
                });
            }
        });
     </script>
</header>

<div class="vision-modal" id="vision-modal">
    <div class="vision-container">
        <div class="vision-header">
            <div class="vision-logo">
                <img src="{% static 'img/icon-sensors.png' %}" alt="">
                <h2>–ü—É–ª—å—Å</h2>
            </div>
            <div class="header-meta">
                <div class="user-badge">
                    {% if username %}
                    <div class="user-avatar">{{ username|make_list|first|upper }}</div>
                    <span>{{ username }}</span>
                    {% else %}
                    <span>–ì–æ—Å—Ç—å</span>
                    {% endif %}
                </div>
                <div class="vision-close">
                    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
                </div>
            </div>
        </div>
        
        <div class="vision-body">
            <div class="vision-nav">
                <div class="nav-section">
                    <div class="section-header">–ù–∞–≤–∏–≥–∞—Ü–∏—è</div>
                    <ul>
                        <li class="vision-nav-item" data-view="dashboard">
                            <div class="nav-icon"><img src="{% static 'img/icon-stat.png' %}" alt=""></div>
                            <div class="nav-content">
                                <div class="nav-title">–ú–æ—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</div>
                                <div class="nav-subtitle">–û–±–∑–æ—Ä –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</div>
                            </div>
                        </li>
                        {% if username %}
                        <li class="vision-nav-item" data-view="tests">
                            <div class="nav-icon"><img src="{% static 'img/icon-history.png' %}" alt=""></div>
                            <div class="nav-content">
                                <div class="nav-title">–ò—Å—Ç–æ—Ä–∏—è</div>
                                <div class="nav-subtitle">–ü—Ä–µ–¥—ã–¥—É—â–∏–µ —Ç–µ—Å—Ç—ã</div>
                            </div>
                        </li>
                        <li class="vision-nav-item" data-view="create">
                            <div class="nav-icon"><img src="{% static 'img/icon-new.png' %}" alt=""></div>
                            <div class="nav-content">
                                <div class="nav-title">–ù–æ–≤—ã–π —Ç–µ—Å—Ç</div>
                                <div class="nav-subtitle">–°–æ–∑–¥–∞—Ç—å —Å –Ω–µ–π—Ä–æ—Å–µ—Ç—å—é</div>
                            </div>
                        </li>
                        {% else %}
                        <li class="vision-nav-item" data-view="home">
                            <div class="nav-icon"><img src="{% static 'img/icon-home.png' %}" alt=""></div>
                            <div class="nav-content">
                                <div class="nav-title">–ù–∞ –≥–ª–∞–≤–Ω—É—é</div>
                                <div class="nav-subtitle">–í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ –ª–µ–Ω–¥–∏–Ω–≥</div>
                            </div>
                        </li>
                        {% endif %}
                    </ul>
                    
                    <div class="section-header" style="margin-top: 30px">–ê–∫–∫–∞—É–Ω—Ç</div>
                    <ul>
                        {% if username %}
                            <li class="vision-nav-item" data-view="profile">
                                <div class="nav-icon"><img src="{% static 'img/icon-pro.png' %}" alt=""></div>
                                <div class="nav-content">
                                    <div class="nav-title">–ê–∫–∫–∞—É–Ω—Ç</div>
                                    <div class="nav-subtitle">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞–∫–∫–∞—É–Ω—Ç–æ–º</div>
                                </div>
                            </li>
                        {% if subscription_level < 2 or subscription_level == 99 %}
                            <li class="vision-nav-item highlight" data-view="upgrade">
                                <div class="nav-icon"><img src="{% static 'img/icon-diamond.png' %}" alt=""></div>
                                <div class="nav-content">
                                    <div class="nav-title">–ü—Ä–µ–º–∏—É–º –¥–æ—Å—Ç—É–ø</div>
                                    <div class="nav-subtitle">–†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏</div>
                                </div>
                            </li>
                        {% endif %}
                        {% else %}
                            <li class="vision-nav-item" data-view="telegram">
                                <div class="nav-icon"><img src="{% static 'img/logo-telegram.png' %}" alt=""></div>
                                <div class="nav-content">
                                    <div class="nav-title">–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –≤ Telegram</div>
                                    <div class="nav-subtitle">–í–æ–π—Ç–∏ –ø–æ –æ–¥–Ω–æ–º—É –∫–ª–∏–∫—É</div>
                                </div>
                            </li>
                            <li class="vision-nav-item" data-view="login">
                                <div class="nav-icon"><img src="{% static 'img/icon-login.png' %}" alt=""></div>
                                <div class="nav-content">
                                    <div class="nav-title">–û–±—ã—á–Ω—ã–π –≤—Ö–æ–¥</div>
                                    <div class="nav-subtitle">Email/–ü–∞—Ä–æ–ª—å</div>
                                </div>
                            </li>
                            <li class="vision-nav-item" data-view="register">
                                <div class="nav-icon"><img src="{% static 'img/icon-register.png' %}" alt=""></div>
                                <div class="nav-content">
                                    <div class="nav-title">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</div>
                                    <div class="nav-subtitle">–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç</div>
                                </div>
                            </li>
                        {% endif %}
                    </ul>
                </div>
                
                <div class="divider"></div>
                
                <div class="nav-section">
                    <div class="section-header">–ü—Ä–æ—á–µ–µ</div>
                    <ul>
                        <li class="vision-nav-item" data-view="support">
                            <div class="nav-icon"><img src="{% static 'img/icon-support.png' %}" alt=""></div>
                            <div class="nav-content">
                                <div class="nav-title">–ü–æ–¥–¥–µ—Ä–∂–∫–∞</div>
                                <div class="nav-subtitle">–ó–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å</div>
                            </div>
                        </li>
                        <li class="vision-nav-item" data-view="docs">
                            <div class="nav-icon"><img src="{% static 'img/icon-docs.png' %}" alt=""></div>
                            <div class="nav-content">
                                <div class="nav-title">–î–æ–∫—É–º–µ–Ω—Ç—ã</div>
                                <div class="nav-subtitle">–ü—Ä–∞–≤–æ–≤–æ–π —Å—Ç–∞—Ç—É—Å –°–µ—Ä–≤–∏—Å–∞</div>
                            </div>
                        </li>
                        <li class="vision-nav-item" data-view="more-info">
                            <div class="nav-icon"><img src="{% static 'img/icon-more.png' %}" alt=""></div>
                            <div class="nav-content">
                                <div class="nav-title">–û –ø—Ä–æ–µ–∫—Ç–µ</div>
                                <div class="nav-subtitle">–ö–æ–º–∞–Ω–¥–∞ –∏ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏</div>
                            </div>
                        </li>
                    </ul>
                </div>
            </div>
            
            <div class="divider vertical"></div>
            <div class="vision-content" id="vision-content"><!-- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π –∫–æ–Ω—Ç–µ–Ω—Ç –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è —Ç—É—Ç --></div>
        </div>
    </div>
</div>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const visionModal = document.getElementById('vision-modal');
        const visionClose = document.querySelector('.vision-close');
        const navItems = document.querySelectorAll('.vision-nav-item[data-view]');
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞
        function createView(viewName) {
            const container = document.getElementById('vision-content');
            container.innerHTML = '';
            
            const content = document.createElement('div');
            content.className = 'content-view active';
            content.id = `view-${viewName}`;
            console.log(viewName);
            
            switch(viewName) {
                case 'dashboard':
                console.log(document.getElementById('view-dashboard'))
                    
                    content.innerHTML = `
                        <h2 class="content-header">–ú–æ—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</h2>
                        <div class="stats-grid">
                            <div class="stat-item">
                                <div>–í—Å–µ–≥–æ —Ç–µ—Å—Ç–æ–≤</div>
                                <div class="stat-value" data-stat="total_tests">‚Äì</div>
                                <div class="stat-label">–∑–∞ –≤—Å—ë –≤—Ä–µ–º—è</div>
                            </div>
                            <div class="stat-item">
                                <div>–ï—â–µ –º–æ–∂–Ω–æ</div>
                                <div class="stat-value" data-stat="tests_remaining_today">‚Äì</div>
                                <div class="stat-label">—Å–æ–∑–¥–∞—Ç—å —Å–µ–≥–æ–¥–Ω—è</div>
                            </div>
                            <div class="stat-item">
                                <div>–†–µ—à–µ–Ω–æ</div>
                                <div class="stat-value" data-stat="passed_tests">‚Äì</div>
                                <div class="stat-label">–∑–∞ –≤—Å—ë –≤—Ä–µ–º—è</div>
                            </div>
                        </div>

                        <div class="content-grid" style="margin-top:40px">
                            <div class="content-card">
                                <div class="card-title">üìä –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div>
                                <ul>
                                    <li><strong>–í–æ–ø—Ä–æ—Å–æ–≤ —Å–æ–∑–¥–∞–Ω–æ:</strong> <span data-stat="total_questions">‚Äì</span></li>
                                    <li><strong>–°—Ä–µ–¥–Ω–µ–µ –≤ —Ç–µ—Å—Ç–µ:</strong> <span data-stat="avg_questions">‚Äì</span></li>
                                    <li><strong>–°—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª:</strong> <span data-stat="avg_correct_answers">‚Äì</span></li>
                                    <li><strong>–ß–∞—â–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è:</strong> <span data-stat="model_most_used">‚Äì</span></li>
                                </ul>
                            </div>

                            <div class="content-card">
                                <div class="card-title">üìà –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ</div>
                                <ul>
                                    <li><strong>–°–æ–∑–¥–∞–Ω–æ —Å–µ–≥–æ–¥–Ω—è:</strong> <span data-stat="today_created">‚Äì</span></li>
                                    <li><strong>–í —ç—Ç–æ–º –º–µ—Å—è—Ü–µ:</strong> <span data-stat="tests_this_month">‚Äì</span></li>
                                    <li><strong>–§–∏–¥–±—ç–∫–∞:</strong> <span data-stat="feedback_count">‚Äì</span></li>
                                    <li><strong>–û—Ö–≤–∞—Ç —Ñ–∏–¥–±—ç–∫–æ–º:</strong> <span data-stat="percent_with_feedback">‚Äì</span></li>
                                </ul>
                            </div>
                        </div>

                        <div class="content-grid" style="margin-top:30px">
                            <div class="content-card">
                                <div class="card-title">üß† –ú–æ–¥–µ–ª—å –∏ –º–µ—Ç—Ä–∏–∫–∏</div>
                                <ul>
                                    <li><strong>–£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π:</strong> <span data-stat="unique_models_count">‚Äì</span></li>
                                    <li><strong>–°—Ä–µ–¥–Ω–µ–µ –∫–æ–ª-–≤–æ —Ç–æ–∫–µ–Ω–æ–≤:</strong> <span data-stat="avg_tokens_used">‚Äì</span></li>
                                    <li><strong>–¢–µ—Å—Ç–æ–≤ —Å –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏–µ–º:</strong> <span data-stat="tests_created_and_passed">‚Äì</span></li>
                                    <li><strong>–õ—É—á—à–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:</strong> <span data-stat="best_result">‚Äì</span></li>
                                </ul>
                            </div>
                        </div>
                    `;

                    loadUserStats();
                    break;
                    
                case 'upgrade':
                    content.innerHTML = `
                        <h2 class="content-header">–ü—Ä–µ–º–∏—É–º –¥–æ—Å—Ç—É–ø</h2>
                        <div class="content-grid">
                            <div class="content-card">
                                <div class="card-title">üíé –ü–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø</div>
                                <ul>
                                    <li>‚úÖ –°–∫–∞—á–∏–≤–∞–Ω–∏–µ –≤ PDF –¥–ª—è –ø–µ—á–∞—Ç–∏ –±–µ–∑ –≤–æ–¥—è–Ω—ã—Ö –∑–Ω–∞–∫–æ–≤</li>
                                    <li>‚úÖ –ú–æ–∂–Ω–æ –ø—Ä–æ–π—Ç–∏ —Ç–µ—Å—Ç—ã –Ω–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º–µ</li>
                                    <li>‚úÖ –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å –æ—Ç –ò–ò</li>
                                    <li>‚úÖ –°–æ–∑–¥–∞–≤–∞–π—Ç–µ –¥–æ 150 —Ç–µ—Å—Ç–æ–≤ –≤ –¥–µ–Ω—å ‚Äî –≤—Å–µ–≥–æ 4 —Ä—É–±–ª—è –∑–∞ —Ç–µ—Å—Ç</li>
                                </ul>
                                <a href="/payment" class="card-action green-action">–ü–µ—Ä–µ–π—Ç–∏ –∫ –æ–ø–ª–∞—Ç–µ</a>
                            </div>

                            <div class="content-card">
                                <div class="card-title">–†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏</div>
                                <ul>
                                    <li>- –ó–∞–≥—Ä—É–∑–∫–∞ —Å–≤–æ–∏—Ö Word –∏ PDF –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ç–µ—Å—Ç–æ–≤</li>
                                    <li>- –≠–∫—Å–ø–æ—Ä—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è –≤ PDF</li>
                                    <li>–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞</li>
                                </ul>
                                <a href="/available-plans/" class="card-action">–ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏</a>
                            </div>
                        </div>
                    `;
                    break;

                case 'tests':
                    content.innerHTML = `
                        <h2 class="content-header">–ò—Å—Ç–æ—Ä–∏—è</h2>
                        <div class="content-grid">
                            <div class="content-card">
                                <div class="card-title">–ü—Ä–µ–¥—ã–¥—É—â–∏–µ —Ç–µ—Å—Ç—ã</div>
                                <ul id="tests-list" class="list">
                                    <li>–ó–∞–≥—Ä—É–∑–∫–∞...</li>
                                </ul>
                                <a class="card-action" href="/history">–û—Å—Ç–∞–ª—å–Ω—ã–µ —Ç–µ—Å—Ç—ã</a>
                            </div>
                        </div>
                    `;

                    setTimeout(() => {
                        loadTestsList();
                    }, 0);
                    break;

                case 'create':
                    content.innerHTML = `
                        <h2 class="content-header">–ù–æ–≤—ã–π —Ç–µ—Å—Ç</h2>
                        <div class="content-grid">
                            <div class="content-card">
                                <div class="card-title">–°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π —Ç–µ—Å—Ç</div>
                                <p>–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π —Ç–µ—Å—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ –í–∞—à–∏—Ö —É—á–µ–±–Ω—ã—Ö –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤</p>
                                <a class="card-action" href='/create'>–°–æ–∑–¥–∞—Ç—å</a>
                            </div>
                        </div>
                    `;
                    break;

                case 'profile':
                    content.innerHTML = `
                        <h2 class="content-header">–ê–∫–∫–∞—É–Ω—Ç</h2>
                        <div class="content-grid">
                            <div class="content-card">
                                <div class="card-title">–ü—Ä–æ—Ñ–∏–ª—å</div>
                                <ul>
                                    <li><strong>Email:</strong> <span data-prof="email">‚Äì</span></li>
                                    <li><strong>–¢–µ–ª–µ—Ñ–æ–Ω:</strong> <span data-prof="phone">‚Äì</span></li>
                                    <li><strong>–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:</strong> <span data-prof="date_join">‚Äì</span></li>
                                    <li><strong>–ü–æ—Å–ª–µ–¥–Ω–∏–π –≤—Ö–æ–¥:</strong> <span data-prof="date_last_login">‚Äì</span></li>
                                    <a class="card-action" href='/profile'>–û—Ç–∫—Ä—ã—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</a>
                                </ul>
                            </div>
                            <div class="content-card">
                                <div class="card-title">üí≥ –ü–æ–¥–ø–∏—Å–∫–∞</div>
                                <ul>
                                    <li><strong>–¢–∞—Ä–∏—Ñ:</strong> <span data-prof="plan_name">‚Äì</span></li>
                                    <li><strong>–ò—Å—Ç–µ–∫–∞–µ—Ç:</strong> <span data-prof="plan_end_date">‚Äì</span></li>
                                    <li><strong>–û—Å—Ç–∞–ª–æ—Å—å –¥–Ω–µ–π:</strong> <span data-prof="days_until_end">‚Äì</span></li>
                                    <a class="card-action green-action" href='/payment'>–î—Ä—É–≥–∏–µ —Ç–∞—Ä–∏—Ñ—ã</a>
                                </ul>
                            </div>
                            <div class="content-card" id="tokens-card">
                                <div class="card-title">üß™ –õ–∏–º–∏—Ç—ã —Å–µ–≥–æ–¥–Ω—è</div>
                                <ul>
                                    <li><strong>–î–æ—Å—Ç—É–ø–Ω–æ —Å–µ–≥–æ–¥–Ω—è:</strong> <span data-prof="tests_remaining_today">‚Äì</span></li>
                                    <li><strong>–î–Ω–µ–≤–Ω–æ–π –ª–∏–º–∏—Ç:</strong> <span data-prof="tokens_limit">‚Äì</span></li>
                                </ul>

                                <div class="token-progress-wrapper">
                                    <div class="token-progress-bar">
                                        <div class="token-progress-fill" id="token-fill" style="width: 0%"></div>
                                    </div>
                                    <div class="token-progress-label"><span id="token-percent-label">0%</span></div>
                                </div>

                                <a class="card-action" href="/premium" id="go-premium-btn" style="display: none;">üöÄ –ü–µ—Ä–µ–π—Ç–∏ –Ω–∞ –ü—Ä–µ–º–∏—É–º</a>
                            </div>
                            <div class="content-card">
                                <div class="card-title">–í—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞</div>
                                    <p>–ó–∞–∫—Ä—ã—Ç—å —Å–µ—Å—Å–∏—é –∏ –ø–µ—Ä–µ–π—Ç–∏ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏</p>
                                    <a class="card-action red-action" href='{% url 'logout' %}'>–í—ã–π—Ç–∏</a>
                                </div>
                            </div>
                        </div>
                    `;
                    loadUserProfile();
                    break;
                
                case 'docs':
                    content.innerHTML = `
                        <h2 class="content-header">–î–æ–∫—É–º–µ–Ω—Ç—ã</h2>
                        <div class="content-grid">
                            <div class="content-card">
                                <div class="card-title">–ü—É–±–ª–∏—á–Ω–∞—è –æ—Ñ–µ—Ä—Ç–∞</div>
                                <p>–£—Å–ª–æ–≤–∏—è –¥–æ—Å—Ç—É–ø–∞ –∫ —Å–µ—Ä–≤–∏—Å—É ¬´–õ–µ—Ç—É—á–∫–∞¬ª ‚Äî –∫—Ç–æ, –∫–∞–∫, –∑–∞ —Å–∫–æ–ª—å–∫–æ –∏ –Ω–∞ –∫–∞–∫–∏—Ö –æ—Å–Ω–æ–≤–∞–Ω–∏—è—Ö –ø–æ–ª—É—á–∞–µ—Ç —É—Å–ª—É–≥–∏. –í—Å—ë –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ.</p>
                                <a class="card-action" href='/docs/public-offer'>–û—Ç–∫—Ä—ã—Ç—å</a>
                            </div>
                            <div class="content-card">
                                <div class="card-title">–ü–æ–ª–∏—Ç–∏–∫–∞ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏</div>
                                <p>–ö–∞–∫ –º—ã —Å–æ–±–∏—Ä–∞–µ–º, —Ö—Ä–∞–Ω–∏–º –∏ –∑–∞—â–∏—â–∞–µ–º –≤–∞—à–∏ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ.</p>
                                <a class="card-action" href='/docs/privacy-policy'>–û—Ç–∫—Ä—ã—Ç—å</a>
                            </div>
                        </div>
                    `;
                    break;
                
                case 'telegram':
                    content.innerHTML = `
                        <h2 class="content-header">–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –≤ Telegram</h2>
                        <div class="content-grid">
                            <div class="content-card">
                                <div class="card-title">–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Telegram</div>
                                <p>–ë—ã—Å—Ç—Ä–∞—è –∏ –±–µ–∑–æ–ø–∞—Å–Ω–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –≤ –æ–¥–∏–Ω –∫–ª–∏–∫ –±–µ–∑ –ø–∞—Ä–æ–ª—è.</p>
                                <a class="card-action" href="https://t.me/LetychkaRobot">–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Telegram</a>
                            </div>
                        </div>
                    `;
                    break;

                case 'login':
                    content.innerHTML = `
                        <h2 class="content-header">–û–±—ã—á–Ω—ã–π –≤—Ö–æ–¥</h2>
                        <div class="content-grid">
                            <div class="content-card">
                                <div class="card-title">–í—Ö–æ–¥ —Å Email –∏ –ø–∞—Ä–æ–ª–µ–º</div>
                                <p>–í–≤–µ–¥–∏—Ç–µ –≤–∞—à email –∏ –ø–∞—Ä–æ–ª—å –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –∞–∫–∫–∞—É–Ω—Ç—É.</p>
                                <a class="card-action" href="/login">–í–æ–π—Ç–∏</a>
                            </div>
                        </div>
                    `;
                    break;

                case 'register':
                    content.innerHTML = `
                        <h2 class="content-header">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
                        <div class="content-grid">
                            <div class="content-card">
                                <div class="card-title">–°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π –∞–∫–∫–∞—É–Ω—Ç</div>
                                <p>–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å, —á—Ç–æ–±—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤—Å–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ —Å–µ—Ä–≤–∏—Å–∞.</p>
                                <a class="card-action" href="/register">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</a>
                            </div>
                        </div>
                    `;
                    break;
                
                case 'support':
                    content.innerHTML = `
                        <h2 class="content-header">–ü–æ–¥–¥–µ—Ä–∂–∫–∞</h2>
                        <div class="content-grid">
                            <div class="content-card">
                                <div class="card-title">–≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∞—è –ø–æ—á—Ç–∞</div>
                                <p>–ù–∞–ø–∏—à–∏—Ç–µ –Ω–∞–º –ø–æ –ª—é–±—ã–º –≤–æ–ø—Ä–æ—Å–∞–º –∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è–º</p>
                                <a class="card-action" href="mailto:support@letychka.ru">support@letychka.ru</a>
                            </div>
                            <div class="content-card">
                                <div class="card-title">Telegram-–±–æ—Ç</div>
                                <p>–û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ –Ω–∞—à –±–æ—Ç –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ –∏ –ø–æ–º–æ—â–∏</p>
                                <a class="card-action" href="https://t.me/LetychkaRobot" target="_blank">–û—Ç–∫—Ä—ã—Ç—å –±–æ—Ç–∞</a>
                            </div>
                        </div>
                    `;
                    break;
                
                case 'home':
                    content.innerHTML = `
                        <h2 class="content-header">–ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞</h2>
                        <div class="content-grid">
                            <div class="content-card">
                                <div class="card-title">–í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ –ª–µ–Ω–¥–∏–Ω–≥</div>
                                <p>–ü–µ—Ä–µ–π—Ç–∏ –Ω–∞ –≥–ª–∞–≤–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å–µ—Ä–≤–∏—Å–∞ ¬´–õ–µ—Ç—É—á–∫–∞¬ª –∏ —É–∑–Ω–∞—Ç—å –±–æ–ª—å—à–µ –æ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—è—Ö</p>
                                <a class="card-action" href='/'>–ù–∞ –≥–ª–∞–≤–Ω—É—é</a>
                            </div>
                        </div>
                    `;
                    break;
                    
                default:
                    content.innerHTML = `
                        <h2 class="content-header">${viewName}</h2>
                        <p>–ö–æ–Ω—Ç–µ–Ω—Ç –¥–ª—è —ç—Ç–æ–π —Å–µ–∫—Ü–∏–∏ –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è</p>
                    `;
            }
            
            container.appendChild(content);
        }

        function formatWithSpaces(number) {
            return number
                .toString()
                .replace(/\B(?=(\d{3})+(?!\d))/g, " ");
        }


        // –û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø–æ –∫–ª–∏–∫—É –Ω–∞ –ª–æ–≥–æ—Ç–∏–ø
        document.querySelector('.logo-header').addEventListener('click', function(e) {
            e.preventDefault();
            visionModal.classList.add('active');
            document.body.style.overflow = 'hidden';
            
            navItems.forEach((item, index) => {
                item.style.transitionDelay = `${index * 0.08}s`;
            });
            
            navItems.forEach(nav => nav.classList.remove('selected'));
            createView('dashboard');
        });
        
        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
        visionClose.addEventListener('click', function() {
            visionModal.classList.remove('active');
            document.body.style.overflow = '';
        });
        
        // –ù–∞–≤–∏–≥–∞—Ü–∏—è
        navItems.forEach(item => {
            item.addEventListener('click', function () {
                const view = this.getAttribute('data-view');
                createView(view);

                document.querySelectorAll('.content-view').forEach(viewEl => {
                    viewEl.classList.remove('active');
                });

                navItems.forEach(nav => nav.classList.remove('selected'));

                setTimeout(() => {
                    document.getElementById(`view-${view}`).classList.add('active');
                    this.classList.add('selected');
                }, 50);
            });
        });

        // –ó–∞–≥—Ä—É–∑–∫–∞ –≤–∏–¥–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤ —Å–∫—Ä—ã—Ç–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏
        window.addEventListener('load', function() {
            createView('dashboard');
            document.getElementById('view-dashboard').classList.remove('active');
        });

        async function loadUserStats() {
            try {
                const res = await fetch('/api/user-stats/');
                if (!res.ok) throw new Error('API error');
                const stats = await res.json();

                for (const key in stats) {
                    const el = document.querySelector(`[data-stat="${key}"]`);
                    if (el) el.textContent = stats[key];
                }
            } catch (err) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:', err);
            }
        }

        async function loadUserProfile() {
            try {
                const res = await fetch('/api/user-profile/');
                if (!res.ok) throw new Error('Profile API error');
                const data = await res.json();

                const flatMap = {
                    'username': data.username,
                    'email': data.email || '‚Äì',
                    'phone': data.phone || '‚Äì',
                    'date_join': data.date_join,
                    'date_last_login': data.date_last_login || '‚Äì',
                    'plan_name': data.subscription.plan_name,
                    'plan_end_date': data.subscription.plan_end_date,
                    'days_until_end': data.subscription.days_until_end,
                    'tests_remaining_today': data.tokens.tests_remaining_today,
                    'tests_daily_limit': data.tokens.tests_daily_limit,
                    'tokens_limit': data.tokens.tests_daily_limit,
                    'tokens_remaining': data.tokens.tests_remaining_today,
                    'tokens_used_percent': data.tokens.used_percent
                };

                // –ü–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–Ω–∞—á–µ–Ω–∏–π
                for (const key in flatMap) {
                    const el = document.querySelector(`[data-prof="${key}"]`);
                    if (el) el.textContent = flatMap[key];
                }

                // –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä
                const usedPercent = parseInt(data.tokens.used_percent);
                const fill = document.getElementById('token-fill');
                const label = document.getElementById('token-percent-label');
                const button = document.getElementById('go-premium-btn');

                if (fill) fill.style.width = `${usedPercent}%`;
                if (label) label.textContent = `${usedPercent}% –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ`;

                if (usedPercent >= 70) {
                    fill?.classList.add('danger');
                    if (button) button.style.display = 'inline-block';
                } else {
                    fill?.classList.remove('danger');
                    if (button) button.style.display = 'none';
                }

            } catch (err) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è:', err);
            }
        }


        async function loadTestsList() {
            const list = document.getElementById('tests-list');
            if (!list) return;

            try {
                const res = await fetch('/load-more-surveys/?page=1', {
                    headers: { 'x-requested-with': 'XMLHttpRequest' }
                });

                if (!res.ok) throw new Error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∏—Å—Ç–æ—Ä–∏–∏');

                const data = await res.json();

                if (!data.surveys || data.surveys.length === 0) {
                    list.innerHTML = '<li>–ù–µ—Ç —Ç–µ—Å—Ç–æ–≤</li>';
                    return;
                }

                list.innerHTML = '';

                for (const survey of data.surveys) {
                    const li = document.createElement('li');

                    li.innerHTML = `
                        <a href="/result/${survey.survey_id}" style="color: #ccc; text-decoration: none;">
                            ${survey.title}
                        </a><span style="opacity: 0.6; font-size: 0.85rem;"> ${survey.create}</span>
                    `;

                    list.appendChild(li);
                }
            } catch (err) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–µ—Å—Ç–æ–≤:', err);
                list.innerHTML = '<li>–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ</li>';
            }
        }
    });
</script>

<!-- –°–ù–ï–ì–û–ü–ê–î -->
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const snowContainer = document.getElementById('snow-container');
        const snowToggle = document.getElementById('snow-toggle');
        const DUST_COUNT = 250;

        let isSnowing = false;

        function createDust() {
            if (!snowContainer || snowContainer.children.length > 0) return;
            
            for (let i = 0; i < DUST_COUNT; i++) {
                const dustParticle = document.createElement('div');
                const layer = Math.ceil(Math.random() * 3);
                dustParticle.className = `snowflake layer${layer}`;
                
                dustParticle.style.left = `${Math.random() * 100}vw`;
                dustParticle.style.animationDelay = `${Math.random() * 40}s`; 
                
                snowContainer.appendChild(dustParticle);
            }
        }

        function enableSnow() {
            localStorage.setItem('snowEffect', 'enabled');
            snowContainer.classList.add('snow-active');
            snowToggle.classList.add('text-white', 'bg-[var(--color-accent-primary)]/20');
            if (!isSnowing) {
                createDust();
                isSnowing = true;
            }
        }

        function disableSnow() {
            localStorage.setItem('snowEffect', 'disabled');
            snowContainer.classList.remove('snow-active');
            snowToggle.classList.remove('text-white', 'bg-[var(--color-accent-primary)]/20');
        }

        snowToggle.addEventListener('click', () => {
            if (snowContainer.classList.contains('snow-active')) {
                disableSnow();
            } else {
                enableSnow();
            }
        });

        if (localStorage.getItem('snowEffect') !== 'disabled') {
            enableSnow();
        }
    });
</script>
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Безопасная оплата | Летучка</title>
    {% load static %}
    <link rel="shortcut icon" href="{% static 'img/favicon.ico' %}" type="image/png" />
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://securepay.tinkoff.ru/html/payForm/js/tinkoff_v2.js"></script>
    <link rel="stylesheet" href="{% static 'css/footer.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Yandex.Metrika counter -->
    <script type="text/javascript">
        (function(m,e,t,r,i,k,a){
            m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
            m[i].l=1*new Date();
            for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}
            k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)
        })(window, document,'script','https://mc.yandex.ru/metrika/tag.js', 'ym');

        ym(98829160, 'init', {webvisor:true, clickmap:true, accurateTrackBounce:true, trackLinks:true});
    </script>
    <noscript><div><img src="https://mc.yandex.ru/watch/98829160" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
    <!-- /Yandex.Metrika counter -->

    <style>
        :root {
          --bg:rgba(15, 8, 24, 1);
          --card-bg:rgba(36, 31, 47, 0.2);
          --stroke:rgba(2, 2, 2, 0.12);
          --accent:#616DF0;
          --accent-green:#79EF66;
          --text:#ffffff;
          --text-dim:rgba(255,255,255,0.6);
          --radius: 16px;
        }
        @font-face {
            font-family: 'Namu Pro';
            src: url(../fonts/NAMU-Pro.woff2);
        }
        html,body{
            margin:0; padding:0;
            color:var(--text);
            font-family: 'Namu Pro', Roboto,Arial,sans-serif;-webkit-font-smoothing: antialiased;
        }
        html {
            background-color: var(--bg);
            background-image: url(../../static/img/bg-gradient-0907.svg);
        }
        *,*:before,*:after{box-sizing:border-box}
        a{color:var(--accent-green);text-decoration:none}
        .fade-in{animation:fade 0.4s ease forwards}
        @keyframes fade{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}
        .container{
            width: 92%; min-width: 600px; max-width: 1000px;
            padding: 16px 16px;margin: 100px auto;
            display:flex;flex-direction:column;gap:20px; 
            background-color: var(--card-bg);border-radius: 32px;
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.12);
        }
        @font-face {
            font-family: 'Unbounded Medium';
            src: url(../../static/fonts/Unbounded-Medium.ttf);
        }
        h2.product-title{
            font-family: 'Unbounded Medium'; font-size:1.4rem;font-weight:700;
        }
        .plans{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:20px}
        .plan{position:relative;padding:24px;border:1px solid var(--stroke);border-radius:var(--radius);background:var(--card-bg);backdrop-filter:blur(24px);cursor:pointer;transition:all 0.25s ease}
        .plan:hover{transform:translateY(-4px);box-shadow:0 8px 16px rgba(40, 38, 43, 0.2)}
        .plan:active{transform:translateY(2px);}
        .plan.selected{border-color:var(--accent-green);box-shadow:0 0 0 2px var(--accent-green)}
        .plan-title{font-weight:600;font-size:1.1rem;margin-bottom:6px;color:var(--accent-green)}
        .plan-desc{font-size:0.88rem;color:var(--text-dim);line-height:1.4;margin:6px 0}
        .plan-price{font-family: 'Unbounded Medium'; font-size:1.6rem;font-weight:700;color:var(--accent-green);margin-top:12px}
        .yearly-label{font-size:0.75rem;color:var(--text-dim)}
        .agreement{display:flex;align-items:center;font-size:0.8rem;gap:8px;margin-top:8px}
        .agreement input{accent-color:var(--accent-green)}
        .agreement{display:flex;align-items:center;font-size:0.8rem;gap:8px;position:relative} .agreement input[type="checkbox"]{position:absolute;opacity:0;width:1px;height:1px;overflow:hidden;clip:rect(0 0 0 0);margin:0;padding:0} .agreement label{position:relative;padding-left:28px;cursor:pointer;color:var(--text)} .agreement label::before{content:"";position:absolute;top:50%;left:0;width:18px;height:18px;border:2px solid var(--stroke);border-radius:var(--radius);background:var(--card-bg);transform:translateY(-50%);transition:border-color .2s,background .2s;box-sizing:border-box} .agreement label::after{content:"";position:absolute;top:50%;left:4px;width:6px;height:10px;border:solid var(--card-bg);border-width:0 2px 2px 0;transform:translateY(-50%) rotate(45deg) scale(0);transition:transform .15s ease-in-out} .agreement input[type="checkbox"]:checked+label::before{background:var(--accent-green);border-color:var(--accent-green)} .agreement input[type="checkbox"]:checked+label::after{transform:translateY(-50%) rotate(45deg) scale(1)} .agreement input[type="checkbox"]:focus+label::before,.agreement label:hover::before{border-color:var(--accent-green)} .agreement a{color:var(--accent-green);text-decoration:none} .agreement a:hover{text-decoration:underline}
        .contact-container{display:flex;flex-wrap:wrap;gap:12px;margin-top:16px}
        .contact{flex:1 1 260px;padding:12px 14px;border:1px solid var(--stroke);border-radius:var(--radius);background:transparent;color:var(--text)}
        .contact::placeholder{color:var(--text-dim)}
        .payment-button{width:100%;margin-top:24px;padding:14px 0;border:none;border-radius:var(--radius);font-size:1rem;font-weight:600;background:var(--accent);color:#fff;cursor:pointer;transition:background 0.25s ease}
        .payment-button:hover{background:var(--accent-green)}
        hr{border:none;height:1px;background:var(--stroke);margin:28px 0}
        .trust-section{display:flex;flex-wrap:wrap;gap:20px;margin:0 auto;max-width:1000px;padding:20px;justify-content:space-between}.trust-card{flex:1 1 280px;background-color:var(--card-bg);border:1px solid var(--stroke);border-radius:var(--radius);padding:24px;backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px);color:var(--text-dim);display:flex;flex-direction:column;gap:12px;text-align:left}.trust-icon{width:36px;height:36px;opacity:0.8}.trust-title{font-weight:600;font-size:1rem;color:var(--accent-green)}.trust-text{font-size:0.88rem;line-height:1.5}.trust-text a{color:var(--accent-green);text-decoration:none}.trust-text a:hover{text-decoration:underline}
        .payment-button.disabled {
            background: var(--stroke);
            color: var(--text-dim);
            cursor: not-allowed;
        }
        .payment-banner {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px 20px;
            background-color: var(--card-bg);
            border: 1px solid var(--stroke);
            border-radius: 20px;
            color: var(--text);
            font-size: 0.95rem;
            line-height: 1.5;
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            margin-bottom: 20px;
        }
        .payment-icon {
            flex-shrink: 0;
            opacity: 0.9;
        }
        .payment-text strong {
            color: var(--accent-green);
        }
        .bottom-banner {
            position: fixed;
            bottom: 16px;
            left: 50%;
            transform: translateX(-50%);
            width: fit-content;
            border-radius: 32px;
            padding: 2px 16px;
            background-color: var(--card-bg);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border-top: 1px solid var(--stroke);
            z-index: 9999;
            text-align: center;
            color: var(--text-dim);
            font-size: 0.72rem;
        }
        .bottom-content {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 6px;
            flex-wrap: nowrap;
        }
        .divider {
            color: var(--stroke);
            font-size: 0.8rem;
        }
        footer {
          margin-bottom: 100px;
        }
        @media(max-width:600px) {
            .plans{
                grid-template-columns:1fr
            }
            .plan{padding:20px}
            .container {
                width: 92%; min-width: 100px; max-width: 580px;
            }
            body {
                background-size: 300%;
            }
            html {
                background-position: center;
            }
            .bottom-banner {
              font-size: .68em;
            }
            .trust-section {
                flex-direction: column;
                padding: 16px;
            }
        }

        /* Акцент на годовых тарифах */
        .yearly-bonus {
            font-size: 0.8rem;
            color: var(--accent);
            background-color: rgba(97, 109, 240, 0.1);
            padding: 6px 10px;
            border-radius: 12px;
            text-align: center;
            margin-top: 8px;
        }
        .change {
            margin-top: 24px;
            margin-bottom: 12px;
            font-size: 1.1rem;
            color: var(--accent-green);
        }
        .plan.popular {
            transform: scale(1.05);
            border-color: var(--accent);
            background: linear-gradient(145deg, rgba(48, 47, 50, 0.5), rgba(97, 109, 240,0.18));
        }
        .plan.popular:hover { transform: scale(1.07) translateY(-4px); }
        .plan-badge {
            position: absolute;
            top: -12px;
            right: 16px;
            background: var(--accent);
            color: #fff;
            padding: 4px 12px;
            font-size: 0.75rem;
            font-weight: 600;
            border-radius: 16px;
            box-shadow: 0 4px 10px rgba(97, 109, 240, 0.3);
        }

        .final-value-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }

        .summary-item {
            display: flex;
            align-items: flex-start;
            gap: 16px;
            background: var(--card-bg);
            padding: 20px;
            border-radius: var(--radius);
            border: 1px solid var(--stroke);
        }

        .summary-item i {
            font-size: 20px;
            color: var(--accent);
            margin-top: 4px;
            width: 24px;
            text-align: center;
        }

        .summary-text h4 {
            font-family: 'Unbounded Medium';
            font-size: 1.05em;
            color: var(--text);
            margin: 0 0 6px 0;
        }

        .summary-text p {
            font-size: 0.9em;
            color: var(--text-dim);
            margin: 0;
            line-height: 1.5;
        }

        /* Удаляем старые стили, чтобы не было конфликтов */
        .universal-feature-promo, .value-proposition {
            display: none !important;
        }
    </style>
</head>
<body>
    {% include 'header.html' %}
    <div class="container fade-in">
        <h2 class="product-title">Инвестируйте в свое время. Освободите его для главного.</h2>
        <p class="plan-desc" style="text-align: center;">При покупке ЛЮБОГО тарифа, Вы гарантированно получаете:</p>

        <div class="final-value-summary">
            <div class="summary-item">
                <i class="fas fa-magic"></i>
                <div class="summary-text">
                    <h4>Мгновенная Генерация</h4>
                    <p>Превращайте лекции, статьи и любой текст в тесты за секунды.</p>
                </div>
            </div>
            <div class="summary-item">
                <i class="fas fa-chart-pie"></i>
                <div class="summary-text">
                    <h4>Аналитика</h4>
                    <p>Отслеживайте свою продуктивность и успеваемость аудитории на графиках.</p>
                </div>
            </div>
            <div class="summary-item">
                <i class="fas fa-file-invoice"></i>
                <div class="summary-text">
                    <h4>Профессиональный Экспорт</h4>
                    <p>Делитесь чистыми онлайн-тестами или скачивайте PDF без нашего брендинга.</p>
                </div>
            </div>
        </div>

        <div class="payment-banner fade-in">
            <svg class="payment-icon" width="24" height="24" viewBox="0 0 24 24" fill="none">
              <path d="M12 1C5.93 1 1 5.93 1 12s4.93 11 11 11 11-4.93 11-11S18.07 1 12 1Zm0 20c-4.96 0-9-4.04-9-9s4.04-9 9-9 9 4.04 9 9-4.04 9-9 9Z" fill="#79EF66"/>
              <path d="M17 9.5 10.5 16 7 12.5" stroke="#79EF66" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <div class="payment-text">
                <strong>Платите, как удобно:</strong> российские карты, <strong>СБП</strong>, <strong>SberPay</strong> и&nbsp;<strong>T-Pay</strong>&nbsp;&mdash; быстро и&nbsp;безопасно.
            </div>
        </div>

        <div class="plans" id="planSelector">
            <div class="plan popular" data-plan="premium-year" data-price="4800" data-desc="Премиум Год">
                <div class="plan-badge">Максимум выгоды! (42% скидка)</div>
                <div class="plan-title">Премиум • Годовой</div>
                <div class="plan-desc">Ваше секретное оружие на весь учебный год.</div>
                <div class="plan-price">400 ₽ <span class="price-period">/ в месяц</span></div>
                <div class="yearly-bonus">4800 ₽ в год • Экономия 3360 ₽</div>
            </div>

            <div class="plan" data-plan="standard-year" data-price="3900" data-desc="Стандартный Год">
                <div class="plan-title">Стандартный • Годовой</div>
                <div class="plan-desc">Надежный помощник для максимальной экономии.</div>
                <div class="plan-price">325 ₽ <span class="price-period">/ в месяц</span></div>
                <div class="yearly-bonus">3900 ₽ в год • Экономия 2700 ₽</div>
            </div>
            
            <div class="plan" data-plan="premium-month-plus" data-price="690" data-desc="Премиум">
                <div class="plan-badge">Хит продаж</div>
                <div class="plan-title">Премиум • Месяц</div>
                <div class="plan-desc">Максимум возможностей для интенсивной работы.</div>
                <div class="plan-price">690 ₽ <span class="price-period">/ в месяц</span></div>
            </div>
            
            <div class="plan" data-plan="standard-month-plus" data-price="550" data-desc="Стандартный">
                <div class="plan-title">Стандартный • Месяц</div>
                <div class="plan-desc">Идеально для регулярной проверки знаний.</div>
                <div class="plan-price">550 ₽ <span class="price-period">/ в месяц</span></div>
            </div>

            <div class="plan" data-plan="premium-3-month" data-price="1860" data-desc="Премиум 3 мес">
                <div class="plan-badge">Выгодно!</div>
                <div class="plan-title">Премиум • 3 Месяца</div>
                <div class="plan-desc">Платите меньше, работайте дольше. Скидка 10%!</div>
                <div class="plan-price">620 ₽ <span class="price-period">/ в месяц</span></div>
                <div class="yearly-bonus">1860 ₽ за 3 месяца • Экономия 210 ₽</div>
            </div>
            
            <div class="plan" data-plan="standard-3-month" data-price="1470" data-desc="Стандартный 3 мес">
                <div class="plan-title">Стандартный • 3 Месяца</div>
                <div class="plan-desc">Идеально для подготовки к сессии. Скидка 10%!</div>
                <div class="plan-price">490 ₽ <span class="price-period">/ в месяц</span></div>
                <div class="yearly-bonus">1470 ₽ за 3 месяца • Экономия 180 ₽</div>
            </div>
        </div>
    
        <p class="trust-text" style="text-align: center; color: #829085">🔒 Разовая защищенная оплата. Без автопродления</p>
    <form name="payform-tbank" id="payform-tbank">
    {% csrf_token %}
    <input type="hidden" name="amount" id="amount_price" />
    <input type="hidden" name="order" value="{{order_id}}" />
    <input type="hidden" name="description" id="description_order" />

    <div class="contact-container">
        <input class="contact" placeholder="E‑mail для чека" name="email" value="{{email}}" required/>
        <input class="contact" placeholder="Телефон" name="phone" value="{{phone}}" type="hidden"/>
    </div>
    
    <button class="payment-button disabled" id="payment-button" type="submit" disabled>Выберите тариф</button>
    </form>

    <p class="trust-text" style="text-align: center; color: #829085">
        Нажимая «Оплатить», Вы соглашаетесь с 
        <a href="/docs/public-offer" target="_blank">условиями оферты</a>.
    </p>

    <p class="plan-desc" style="text-align: center;">Выберите оптимальный План для себя</p>

    <div class="final-value-summary comparison-grid">
        <div class="summary-item standard-tier">
            <i class="fas fa-bolt"></i>
            <div class="summary-text">
                <h4>СТАНДАРТ</h4>
                <p>Скорость, простота и мгновенный результат.</p>
                <ul class="plan-desc">
                    <li>Превращайте любой текст в готовый тест. Создавайте до 20 тестов в сутки.</li>
                    <li>Ваша аудитория проходит тест БЕЗ РЕГИСТРАЦИИ, просто введя имя.</li>
                    <li>Получайте детальную аналитику по каждому отдельному тесту в реальном времени.</li>
                </ul>
            </div>
        </div>
        <div class="summary-item premium-tier">
            <i class="fas fa-crown" style="color: var(--accent);"></i> 
            <div class="summary-text">
                <h4>ПРЕМИУМ</h4>
                <p>Для тех, кто работает вдолгую и принимает решения на основе данных.</p>
                <ul class="plan-desc">
                    <li class="premium-plus"><strong>Все возможности «Стандартного», плюс:</strong></li>
                    <li class="premium-feature">
                        <strong style="color: var(--accent-green);">Загружайте материалы напрямую.</strong>
                        Создавайте тесты из Ваших PDF и Word документов.
                    </li>
                    <li>Создавайте до 50 тестов в сутки.</li>
                </ul>
            </div>
        </div>
    </div>

      <div class="trust-section">
          <div class="trust-card">
              <img src="{% static 'img/icon-secure-bank.png' %}" alt="Иконка TLS" class="trust-icon">
              <div class="trust-title">Безопасная оплата</div>
              <div class="trust-text">Платежи защищены <strong>TLS</strong>-протоколом. Мы не храним данные карты — они передаются банку напрямую.</div>
          </div>

          <div class="trust-card">
              <img src="{% static 'img/icon-quality.png' %}" alt="Иконка Быстро и Качественно" class="trust-icon">
              <div class="trust-title">Гарантии Летучки</div>
              <div class="trust-text">Более 23 000 тестов уже созданы через платформу. <br><br>
                Если в&nbsp;течение 7&nbsp;дней после покупки вы&nbsp;решите, что наш сервис&nbsp;&mdash; шляпа полная, и&nbsp;не&nbsp;сэкономил Вам ни&nbsp;минуты времени, просто напишите мне на&nbsp;личную почту <a href="mailto:kozak187er@yandex.ru">kozak187er@yandex.ru</a>. <br><br>
                Я верну Вам все деньги. <br>Без вопросов.</div>
          </div>

          <div class="trust-card">
              <img src="{% static 'img/icon-support.png' %}" alt="Иконка Поддержки" class="trust-icon">
              <div class="trust-title">Поддержка 24/7</div>
              <div class="trust-text">Отвечаем быстро — в течение часа в рабочее время. Пишите на <a href="mailto:support@letychka.ru">support@letychka.ru</a>, если что-то пошло не так.</div>
          </div>
      </div>
  </div>
  
    {% include 'components/made_in_russia.html' %}

  <script>
    document.addEventListener('DOMContentLoaded', function() {
        const planSelector = document.getElementById('planSelector');
        const amountInput = document.getElementById('amount_price');
        const descInput = document.getElementById('description_order');
        const paymentButton = document.getElementById('payment-button');
        const agreementCheckbox = document.getElementById('agreement-checkbox');
        const payForm = document.getElementById('payform-tbank');
        
        let selectedPlan = null;

        // --- Логика выбора тарифа ---
        planSelector.addEventListener('click', (e) => {
            const planCard = e.target.closest('.plan');
            if (!planCard) return;

            // Снимаем выделение со всех карточек
            planSelector.querySelectorAll('.plan').forEach(c => c.classList.remove('selected'));
            
            // Выделяем нажатую
            planCard.classList.add('selected');
            
            selectedPlan = {
                price: planCard.dataset.price,
                desc: planCard.dataset.desc
            };

            // Обновляем скрытые поля формы
            amountInput.value = selectedPlan.price;
            descInput.value = selectedPlan.desc;
            
            updateButtonState();
        });

        // --- Логика состояния кнопки ---
        //agreementCheckbox.addEventListener('change', updateButtonState);

        function updateButtonState() {
            if (selectedPlan) {
                paymentButton.disabled = false;
                paymentButton.classList.remove('disabled');
                paymentButton.textContent = `Оплатить ${selectedPlan.price} руб`;
            } else {
                paymentButton.disabled = true;
                paymentButton.classList.add('disabled');
                if (!selectedPlan) {
                    paymentButton.textContent = 'Выберите тариф';
                } else {
                    paymentButton.textContent = 'Примите условия оферты';
                }
            }
        }
        
        // --- Логика отправки платежа (твоя оригинальная, но обернутая) ---
        payForm.addEventListener('submit', function(e) {
            e.preventDefault();
            if (paymentButton.disabled) return;

            const email = payForm.querySelector('input[name="email"]').value;
            const phone = payForm.querySelector('input[name="phone"]').value;
            
            if (!email) {
                alert('Пожалуйста, укажите E-mail для отправки чека');
                return;
            }

            const receiptData = {
                EmailCompany: 'support@letychka.ru',
                Taxation: 'patent',
                FfdVersion: '1.2',
                Items: [{
                    Name: descInput.value || 'Оплата',
                    Price: amountInput.value + '00',
                    Quantity: 1.0,
                    Amount: parseFloat(amountInput.value).toFixed(2),
                    PaymentMethod: 'full_prepayment',
                    PaymentObject: 'service',
                    Tax: 'none',
                    MeasurementUnit: 'pc'
                }]
            };

            const data = {
                amount: amountInput.value,
                orderId: payForm.querySelector('input[name="order"]').value,
                description: descInput.value,
                email: email,
                phone: phone,
                receipt: JSON.stringify(receiptData)
            };

            fetch('/api/payment/initiate/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify(data)
            })
            .then(r => r.json())
            .then(resp => {
                if (resp.Success) {
                    window.location.href = resp.PaymentURL;
                } else {
                    alert(resp.Message || 'Ошибка инициации платежа');
                }
            })
            .catch(() => alert('Ошибка сети. Пожалуйста, попробуйте еще раз.'));
        });

        // Инициализируем состояние кнопки при загрузке
        updateButtonState();
    });
  </script>

    {% include 'footer-s.html' %}
</body>
</html>

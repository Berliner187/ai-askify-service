<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Безопасная оплата | Летучка</title>
    {% load static %}
    <link rel="shortcut icon" href="{% static 'img/logo.png' %}" type="image/png" />
    <script src="https://securepay.tinkoff.ru/html/payForm/js/tinkoff_v2.js"></script>
    <link rel="stylesheet" href="{% static 'css/footer.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    {% if debug %}
        <script src="https://cdn.tailwindcss.com"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    {% else %}
        <script src="{% static 'vendor/tailwind.full.min.js' %}"></script>
        <script src="{% static 'vendor/jquery.min.js' %}"></script>
    {% endif %}

    <!-- Yandex.Metrika counter -->
    <script type="text/javascript">
        (function(m,e,t,r,i,k,a){
            m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
            m[i].l=1*new Date();
            for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}
            k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)
        })(window, document,'script','https://mc.yandex.ru/metrika/tag.js', 'ym');

        ym(98829160, 'init', {webvisor:true, clickmap:true, accurateTrackBounce:true, trackLinks:true});
    </script>
    <noscript><div><img src="https://mc.yandex.ru/watch/98829160" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
    <!-- /Yandex.Metrika counter -->

    <style>
        :root {
            --bg: #0F0818;
            --surface: rgba(30, 24, 48, 0.5);
            --border: rgba(97, 109, 240, 0.2);
            --text: #f0f0f0;
            --text-dim: #a0a0b0;
            --accent: #616DF0;
            --color-accent-primary: #616DF0;
            --color-text-secondary: #79EF66;
            --radius-lg: 1.5rem;
            --radius-md: 1rem;
            --color-border: rgba(97, 109, 240, 0.2);
        }
        html, body {
            margin: 0; padding: 0;
            color: var(--text);
            font-family: 'Namu Pro', sans-serif;
            background-color: var(--bg);
        }
        @keyframes fade{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:none}}
        .animate-fadeIn{animation:fade 0.5s ease-out forwards}

        @media (min-width: 768px) {
            main.max-w-xl { max-width: 42rem; }
            footer .max-w-xl { max-width: 42rem; }
        }

        .plan-card {
            position: relative; padding: 12px;
            border: 2px solid var(--surface);
            background: var(--surface);
            border-radius: var(--radius-lg);
            text-align: center; cursor: pointer;
            transition: all 0.2s ease-in-out;
            user-select: none;
        }
        .plan-card:hover {
            transform: translateY(-4px); border-color: var(--accent);
        }
        .plan-card:active {
            transform: translateY(2px);
        }
        .plan-card.selected {
            border-color: var(--accent); background: var(--accent);
        }
        .plan-card.selected .text-lg, .plan-card.selected .text-sm { color: white; }
        .plan-badge {
            position: absolute; top: -12px; left: 50%;
            transform: translateX(-50%); background: var(--accent);
            color: white; padding: 4px 10px; font-size: 0.7rem;
            font-weight: 600; border-radius: 9999px; white-space: nowrap;
        }
        .plan-card.selected .plan-badge { background: white; color: var(--accent); }

        /* Список фич */
        .feature-item {
            display: flex; align-items: center; gap: 16px;
            padding: 12px; background: var(--surface); border-radius: var(--radius-md);
        }
        .feature-icon {
            flex-shrink: 0; width: 36px; height: 36px;
            display: flex; align-items: center; justify-content: center;
            background: var(--accent); border-radius: 50%; font-size: 1rem;
            animation: pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite;
            animation-delay: var(--delay);
        }
        .feature-text { font-size: 0.9rem; line-height: 1.4; color: var(--text-dim); }
        .feature-text strong { color: var(--text); font-weight: 600; }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }

        .plan-card.long-term {
            text-align: left;
            padding: 20px;
        }

        #promo-container input::placeholder {
            color: #6B7280;
            font-weight: 500;
        }
        #promo-container:focus-within {
            border-color: var(--color-accent-primary);
            box-shadow: 0 0 15px rgba(97, 109, 240, 0.3);
        }
        .promo-success { color: var(--color-accent-secondary); }
        .promo-error { color: #F87171; }


        /* Анимация переливания неона */
        @keyframes neon-flow {
            0% { border-color: #7928CA; box-shadow: 0 0 15px rgba(121, 40, 202, 0.3); }
            50% { border-color: #FF0080; box-shadow: 0 0 25px rgba(255, 0, 128, 0.4); }
            100% { border-color: #007CF0; box-shadow: 0 0 15px rgba(0, 124, 240, 0.3); }
        }

        .plan-card.premium-neon {
            position: relative;
            border: 2px solid #7928CA;
            border-radius: 1.5rem;
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            animation: neon-flow 4s infinite alternate;
            z-index: 1;
        }

        .plan-card.premium-neon .plan-badge {
            position: absolute;
            top: -12px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10;
            background: linear-gradient(45deg, #7928CA, #FF0080);
            box-shadow: 0 0 15px rgba(255, 0, 128, 0.4);
            border: none;
            color: #fff;
            white-space: nowrap;
        }

        .plan-card.premium-neon:hover {
            transform: translateY(-4px);
            z-index: 2;
        }

        .plan-card.premium-neon.selected {
            border-color: #fff;
            box-shadow: 0 0 35px rgba(255, 255, 255, 0.4);
        }
    </style>
</head>

<body class="bg-[var(--bg)] text-[var(--text)] font-['Namu_Pro']">
    {% include 'header.html' %}

    <!-- ГЛАВНЫЙ КОНТЕЙНЕР СТРАНИЦЫ -->
    <main class="max-w-3xl mx-auto px-4 pt-24 pb-48">

        <div class="max-w-lg mx-auto flex justify-center px-4 mt-2 mb-6">
            <img src="{% static 'img/logo-header.webp' %}" alt="Логотип Летучка" class="w-48 h-auto">
        </div>
        
        <!-- ЗАГОЛОВОК -->
        <div class="text-center mb-8 animate-fadeIn">
            <div class="flex justify-center items-center gap-3 mb-2">
                <h1 class="text-2xl font-['Unbounded_Medium'] font-bold text-white">Летучка <span class="gradient-text">Премиум</span></h1>
            </div>
            <p class="mt-2 text-[var(--text-dim)] pricing-subtitle">Прекратите тратить вечера на рутину и освободите время для себя.</p>
        </div>

        <div class="grid grid-cols-3 gap-2 mb-8 animate-fadeIn" style="animation-delay: 0.1s;" id="plans-container">
        {% if is_veteran %}
            <!-- ГОД PREMIUM -->
            <div class="plan-card premium-neon" data-plan="premium-year" data-price="4800" data-original-price="4800" data-desc="Премиум 1 год">
                <div class="plan-badge">Макс. выгода</div>
                <p class="sm:text-sm text-xs font-semibold">Год</p>
                <p id="price-year" class="text-lg sm:text-2xl font-bold">4800 р</p>
                <p class="text-sm font-semibold text-white/50">~92 р / неделя</p>
            </div>

            <!-- 3 МЕСЯЦА PREMIUM -->
            <div class="plan-card" data-plan="premium-quarter" data-price="1440" data-original-price="1440" data-desc="Премиум 3 мес">
                <div class="plan-badge">Популярный</div>
                <p class="sm: text-sm text-xs font-semibold">3 месяца</p>
                <p class="text-lg sm:text-xl text-white/60 line-through">2070 р</p>
                <p id="price-three-months" class="text-lg sm:text-3xl font-bold">1440 р</p>
                <p class="text-sm font-semibold text-white/50">~120 р / неделя</p>
            </div>

            <!-- МЕСЯЦ PREMIUM -->
            <div class="plan-card popular" data-plan="premium-month" data-price="690" data-original-price="690" data-desc="Премиум">
                <p class="sm:text-sm text-xs font-semibold">Месяц</p>
                <p id="price-month" class="text-lg sm:text-2xl font-bold">690 р</p>
                <p class="text-sm sm:text-sm text-white/50">~147 р / неделя</p>
            </div>
            
        {% else %}
            <!-- НЕДЕЛЯ PREMIUM -->
            <div class="plan-card" data-plan="premium-week" data-price="390" data-original-price="390" data-desc="Премиум неделя">
                <div class="plan-badge">Тест-драйв</div>
                <p class="sm:text-sm text-xs font-semibold">Неделя</p>
                <p id="price-week" class="text-lg sm:text-2xl font-bold">390 р</p>
            </div>

            <!-- МЕСЯЦ PREMIUM (популярный для новичков) -->
            <div class="plan-card popular" data-plan="premium-month" data-price="690" data-original-price="690" data-desc="Премиум">
                <div class="plan-badge">Лучший выбор</div>
                <p class="sm:text-sm text-xs font-semibold">Месяц</p>
                <p class="text-lg sm:text-xl text-white/60 line-through">900 р</p>
                <p id="price-month" class="text-lg sm:text-3xl font-bold">690 р</p>
                <p class="text-sm sm:text-sm text-white/50">~147 р / неделя</p>
            </div>

            <!-- 3 МЕСЯЦА PREMIUM -->
            <div class="plan-card" data-plan="premium-quarter" data-price="1440" data-original-price="1440" data-desc="Премиум 3 мес">
                <div class="plan-badge">Макс. выгода</div>
                <p class="sm: text-sm text-xs font-semibold">3 месяца</p>
                <p id="price-three-months" class="text-lg sm:text-2xl font-bold">1440 р</p>
                <p class="text-sm font-semibold text-white/50">~120 р / неделя</p>
            </div>
            
        {% endif %}
        </div>
            
        <!-- БЛОК ПРОМОКОДА -->
        <!-- <div class="mt-8 max-w-sm mx-auto">
            <div id="promo-container" class="relative p-1 bg-[var(--color-surface)] rounded-full border border-[var(--color-border)] flex items-center gap-2">
                <span class="promo-icon text-blue-300 text-xl pl-3">❄️</span>
                <input type="text" id="promo-input" placeholder="Есть промокод?" 
                    class="flex-grow bg-transparent text-white placeholder-gray-500 font-semibold focus:outline-none">
                    
                <button id="apply-promo-btn" 
                        class="px-5 py-2 bg-[var(--color-accent-primary)] text-white font-bold rounded-full transition-transform hover:scale-105 active:scale-98">
                    Применить
                </button>
            </div>
            <p id="promo-message" class="text-center text-sm mt-2 h-12 mb-6"></p>
        </div> -->

        <!-- СПИСОК ФИЧ PREMIUM -->
        <div class="space-y-3 animate-fadeIn">
            <div class="feature-item">
                <div class="feature-icon animate-fadeIn" style="animation-delay: 80ms;"><i class="fas fa-magic"></i></div>
                <p class="feature-text text-sm sm:text-base"><strong>Полная автоматизация.</strong> Создавайте тесты напрямую из PDF и Word.</p>
            </div>

            <div class="feature-item">
                <div class="feature-icon animate-fadeIn" style="animation-delay: 160ms;"><i class="fas fa-tachometer-alt"></i></div>
                <p class="feature-text text-sm sm:text-base"><strong>Аналитика на дашбордах.</strong> Отслеживайте прогресс учеников, сравнивайте тесты и смотрите детальную карту ошибок, а также просматривайте аналитику по всем тестам в профиле.</p>
            </div>

            <div class="feature-item">
                <div class="feature-icon animate-fadeIn" style="animation-delay: 240ms;"><i class="fas fa-file-excel"></i></div>
                <p class="feature-text text-sm sm:text-base"><strong>Экспорт в Excel.</strong> Выгружайте результаты своих участников для отчётности и архива в один клик.</p>
            </div>

            <div class="feature-item">
                <div class="feature-icon animate-fadeIn" style="animation-delay: 320ms;"><i class="fas fa-bolt"></i></div>
                <p class="feature-text"><strong>Максимальные лимиты.</strong> Создавайте до 50 тестов в сутки (до 20 вопросов в каждом).</p>
            </div>
            
            <div class="feature-item">
                <div class="feature-icon animate-fadeIn" style="animation-delay: 480ms;"><i class="fas fa-print"></i></div>
                <p class="feature-text"><strong>Тесты без водяных знаков.</strong> Скачивайте тесты, которые сразу готовы к печати.</p>
            </div>

            <div class="feature-item">
                <div class="feature-icon animate-fadeIn" style="animation-delay: 480ms;"><i class="fas fa-user-check"></i></div>
                <p class="feature-text">
                    <strong>Самопроверка.</strong> Проходите тесты прямо на платформе, чтобы быстро проверить свои знания или убедиться в качестве сгенерированных вопросов.
                </p>
            </div>
        </div>

        <div class="mt-12 mb-8 text-center">
            <p class="text-7xl font-extrabold gradient-text">
                3,000+
            </p>
            <p class="mt-2 font-semibold text-gray-400">
                Учителей, преподавателей, HR-специалистов и студентов уже в Летучке!
            </p>
        </div>

        <div class="mt-12 mb-8 text-center">
            <p class="text-7xl font-extrabold gradient-text">
                25,000+
            </p>
            <p class="mt-2 font-semibold text-gray-400">
                Тестов уже создано преподавателями и студентами
            </p>
        </div>

        <div class="mt-8 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- КАРТОЧКА 1: БЕЗОПАСНОСТЬ -->
            <div class="bg-[var(--surface)] p-6 rounded-3xl border border-[var(--color-border)] flex flex-col gap-3">
                <div class="flex items-center justify-center h-12 w-12 rounded-full bg-[var(--color-accent-primary)]/10 border border-[var(--color-border)]">
                    <i class="fas fa-shield-alt text-xl text-[var(--color-accent-primary)]"></i>
                </div>
                <div>
                    <h4 class="font-['Unbounded_Medium'] font-bold text-white/90">Безопасно</h4>
                    <p class="mt-1 text-sm text-white/75 leading-relaxed">
                        Платежи защищены TLS-шифрованием. Мы не храним данные карты — они передаются банку напрямую.
                    </p>
                </div>
            </div>

            <!-- КАРТОЧКА 2: КОНТРОЛЬ -->
            <div class="bg-[var(--surface)] p-6 rounded-3xl border border-[var(--color-border)] flex flex-col gap-3">
                <div class="flex items-center justify-center h-12 w-12 rounded-full bg-[var(--color-accent-primary)]/10 border border-[var(--color-border)]">
                    <i class="fas fa-undo-alt text-xl text-[var(--color-accent-primary)]"></i>
                </div>
                <div>
                    <h4 class="font-['Unbounded_Medium'] font-bold text-white/90">Контроль</h4>
                    <p class="mt-1 text-sm text-white/75 leading-relaxed">
                        Мы ценим Ваш комфорт: Оплата разовая. Подписка не продлится автоматически, пока Вы не решите ее обновить сами.
                    </p>
                </div>
            </div>

            <!-- КАРТОЧКА 3: ПОДДЕРЖКА -->
            <div class="bg-[var(--surface)] p-6 rounded-3xl border border-[var(--color-border)] flex flex-col gap-3">
                <div class="flex items-center justify-center h-12 w-12 rounded-full bg-[var(--color-accent-primary)]/10 border border-[var(--color-border)]">
                    <i class="fas fa-headset text-xl text-[var(--color-accent-primary)]"></i>
                </div>
                <div>
                    <h4 class="font-['Unbounded_Medium'] font-bold text-white/90">Поддержка 24/7</h4>
                    <p class="mt-1 text-sm text-white/75 leading-relaxed">
                        Отвечаем быстро — в течение часа в рабочее время. Пишите, если что-то пошло не так.
                    </p>
                </div>
            </div>

        </div>

        <div class="max-w-3xl mx-auto px-4 sm:px-8">
            <div class="mt-8 mb-4 pt-8 border-t border-[var(--color-border)] flex flex-col sm:flex-row justify-between items-center text-xs text-gray-600 text-center">
                <p>2024-2025 Летучка AI. Design & Development <a class="text-gray-500 hover:text-[var(--color-accent-primary)]" rel='nofollow' href="https://dprofile.ru/kozak_developer" target="_blank">by Kozak</a></p>
                <div class="mt-2 sm:mt-0">
                    <a href="/docs/public-offer" class="hover:text-gray-400">Публичная оферта</a>
                    <span class="mx-2">|</span>
                    <a href="/docs/privacy-policy" class="hover:text-gray-400">Политика конфиденциальности</a>
                </div>
            </div>
        </div>

    </main>
    
    <!-- ПРИЛИПАЮЩИЙ ФУТЕР С ОПЛАТОЙ -->
    <footer class="fixed bottom-0 left-0 right-0 z-50 p-4 bg-gradient-to-t from-[var(--bg)] via-[var(--bg)] to-transparent">
        <div class="max-w-xl mx-auto">
            <form name="payform-tbank" id="payform-tbank">
                {% csrf_token %}
                <input type="hidden" name="amount" id="amount_price" />
                <input type="hidden" name="order" value="{{order_id}}" />
                <input type="hidden" name="description" id="description_order" />
                <input type="hidden" name="email" value="{{email}}" />
                <input type="hidden" name="phone" value="{{phone}}" />

                <input id="user-email" class="w-full p-2 mb-2 bg-[var(--surface)] border border-[var(--border)] rounded-xl text-white placeholder-[var(--text-dim)] focus:outline-none focus:ring-2 focus:ring-[var(--accent)]" 
                       placeholder="E‑mail для чека" name="email" value="{{email}}" required/>
                
                <button class="w-full py-4 font-bold text-center rounded-3xl bg-[var(--accent)] text-white sm:text-lg text-base transition-transform hover:scale-105 active:scale-95 shadow-lg shadow-[var(--accent)]/30" id="payment-button" type="submit">
                    <!-- Заполняется через JS -->
                </button>
            </form>
            <p class="text-xs text-center text-[var(--text-dim)] mt-3">
                Разовая оплата. Без автопродления. Нажимая кнопку, вы соглашаетесь с <a href="/docs/public-offer" target="_blank" class="underline">офертой</a>.
            </p>
        </div>
    </footer>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
        const plansContainer = document.querySelector('main');
        const featuresList = document.getElementById('features-list');
        const amountInput = document.getElementById('amount_price');
        const descInput = document.getElementById('description_order');
        const paymentButton = document.getElementById('payment-button');
        const payForm = document.getElementById('payform-tbank');

        function selectPlan(planCard) {
            if (!planCard) return;

            document.querySelectorAll('.plan-card, .long-term-plan').forEach(c => c.classList.remove('selected'));
            planCard.classList.add('selected');
            
            const price = planCard.dataset.price;
            const desc = planCard.dataset.desc;
            
            amountInput.value = price;
            descInput.value = desc;
            
            const periodText = planCard.querySelector('.text-xs').textContent;
            let ctaText = `Перейти к оплате`;

            console.log(periodText);

            if (periodText.includes('3 месяца')) {
                ctaText = `Оплатить ${price} руб на 3 месяца`;
                paymentButton.style.background = 'var(--accent)';
                paymentButton.style.shadow = 'none';
            } else if (periodText.includes('Месяц')) {
                ctaText = `Оплатить ${price} руб на месяц`;
                paymentButton.style.background = 'var(--accent)';
                paymentButton.style.shadow = 'none';
            } else if (periodText.includes('Год')) {
                ctaText = `Оплатить ${price} руб на год`;
                paymentButton.style.background = 'linear-gradient(45deg, #7928CA, #FF0080)';
                paymentButton.style.boxShadow = '0 0 20px rgba(255, 0, 128, 0.4)';
            } else {
                ctaText = `Оплатить ${price} руб на неделю`;
            }
            paymentButton.textContent = ctaText;
            paymentButton.disabled = false;
        }

        // --- Обработчик кликов ---
        plansContainer.addEventListener('click', (e) => {
            const planCard = e.target.closest('.plan-card');
            if (planCard) {
                selectPlan(planCard);
            }
        });
        
        // --- Логика отправки платежа ---
        payForm.addEventListener('submit', function(e) {
            e.preventDefault();
            if (paymentButton.disabled) return;

            const email = document.getElementById('user-email').value;
            const phone = payForm.querySelector('input[name="phone"]').value;
            
            if (!email) {
                console.log('mail', email);
                alert('Пожалуйста, укажите E-mail для отправки чека');
                return;
            }

            const receiptData = {
                EmailCompany: 'support@letychka.ru',
                Taxation: 'patent',
                FfdVersion: '1.2',
                Items: [{
                    Name: descInput.value || 'Оплата',
                    Price: amountInput.value + '00',
                    Quantity: 1.0,
                    Amount: parseFloat(amountInput.value).toFixed(2),
                    PaymentMethod: 'full_prepayment',
                    PaymentObject: 'service',
                    Tax: 'none',
                    MeasurementUnit: 'pc'
                }]
            };

            const data = {
                amount: amountInput.value,
                orderId: payForm.querySelector('input[name="order"]').value,
                description: descInput.value,
                email: email,
                phone: phone,
                receipt: JSON.stringify(receiptData)
            };

            fetch('/api/payment/initiate/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify(data)
            })
            .then(r => r.json())
            .then(resp => {
                if (resp.Success) {
                    window.location.href = resp.PaymentURL;
                } else {
                    alert(resp.Message || 'Ошибка инициации платежа');
                }
            })
            .catch(() => alert('Ошибка сети. Пожалуйста, попробуйте еще раз.'));
        });

        // --- Инициализация: предвыбираем Премиум 3 мес ---
        const defaultPlan = document.querySelector('.plan-card[data-plan="premium-quarter"]');
        if (defaultPlan) {
            selectPlan(defaultPlan);
        } else {
            const firstPlan = document.querySelector('.plan-card');
            if(firstPlan) selectPlan(firstPlan);
        }
    });
  </script>

  <script>
        document.addEventListener('DOMContentLoaded', () => {
            const promoInput = document.getElementById('promo-input');
            const applyBtn = document.getElementById('apply-promo-btn');
            const promoMessage = document.getElementById('promo-message');
            
            // --- Цены тарифов ---
            const originalPrices = {
                week: 390,
                month: 590,
                three_months: 1440,
            };
            
            const priceElements = {
                month: document.getElementById('price-month'),
                three_months: document.getElementById('price-three-months'),
                year: document.getElementById('price-year')
            };

            applyBtn.addEventListener('click', async () => {
                const code = promoInput.value.trim();
                if (!code) return;

                applyBtn.textContent = '...';
                applyBtn.disabled = true;
                promoMessage.textContent = '';
                promoMessage.className = 'text-center text-sm mt-2 mb-8 h-8';

                try {
                    const response = await fetch("{% url 'api_validate_promo' %}", {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}'
                        },
                        body: JSON.stringify({ promo_code: code })
                    });

                    const data = await response.json();

                    if (data.valid) {
                        // --- УСПЕХ ---
                        promoMessage.textContent = data.message;
                        promoMessage.classList.add('promo-success');
                        
                        // Пересчитываем и обновляем цены на странице
                        const discountMultiplier = 1 - (data.discount_percent / 100);
                        
                        for (const plan in originalPrices) {
                            const newPrice = Math.round(originalPrices[plan] * discountMultiplier);
                            if (priceElements[plan]) {
                                priceElements[plan].textContent = newPrice + ' ₽';
                            }
                        }
                        
                        // Деактивируем поле и кнопку
                        promoInput.disabled = true;
                        applyBtn.style.display = 'none';

                    } else {
                        // --- ОШИБКА ---
                        throw new Error(data.error);
                    }

                } catch (error) {
                    promoMessage.textContent = error.message;
                    promoMessage.classList.add('promo-error');
                } finally {
                    if (!promoInput.disabled) {
                        applyBtn.textContent = 'Применить';
                        applyBtn.disabled = false;
                    }
                }
            });

            // Обработчик для Enter
            promoInput.addEventListener('keydown', (event) => {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    applyBtn.click();
                }
            });
        });
        </script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const applyBtn = document.getElementById('apply-promo-btn');
            const promoInput = document.getElementById('promo-input');
            const planCards = document.querySelectorAll('.plan-card');

            applyBtn.addEventListener('click', async () => {
                const code = promoInput.value.trim();
                if (!code) return;

                try {
                    const response = await fetch("{% url 'api_validate_promo' %}", {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
                        body: JSON.stringify({ promo_code: code })
                    });
                    const data = await response.json();

                    if (data.valid) {
                        promoMessage.textContent = data.message;
                        promoMessage.classList.add('promo-success');
                        
                        // --- УНИВЕРСАЛЬНАЯ ЛОГИКА ОБНОВЛЕНИЯ ЦЕН ---
                        const discountMultiplier = 1 - (data.discount_percent / 100);

                        planCards.forEach(card => {
                            const originalPrice = parseFloat(card.dataset.originalPrice);
                            if (originalPrice) {
                                const newPrice = Math.round(originalPrice * discountMultiplier);
                                
                                const priceEl = card.querySelector('[id^="price-"]');
                                if (priceEl) {
                                    priceEl.textContent = newPrice + ' р';
                                }
                                card.dataset.price = newPrice;
                            }
                        });

                        document.querySelectorAll('.plan-card, .long-term-plan').forEach(c => c.classList.remove('selected'));
                        planCard.classList.add('selected');
                        
                        const price = planCard.dataset.price;
                        const desc = planCard.dataset.desc;
                        
                        amountInput.value = price;
                        descInput.value = desc;
                        
                        let ctaText = `Перейти к оплате`;

                        console.log(periodText);

                        if (periodText.includes('3 месяца')) {
                            ctaText = `Оплатить ${price} руб на 3 месяца`;
                        } else if (periodText.includes('Месяц')) {
                            ctaText = `Оплатить ${price} руб на месяц`;
                        } else {
                            ctaText = `Оплатить ${price} руб на неделю`;
                        }
                        paymentButton.textContent = ctaText;
                        paymentButton.disabled = false;
                        
                        promoInput.disabled = true;
                        applyBtn.style.display = 'none';

                    } else {
                        throw new Error(data.error);
                    }
                } catch (error) {
                    // ... (обработка ошибок)
                } finally {
                    // ... (возвращение кнопки в исходное состояние)
                }
            });
        });

    </script>

    {% include 'footer-s.html' %}
</body>
</html>

<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Оплата</title>
    {% load static %}
    <link rel="shortcut icon" href="{% static 'img/favicon.ico' %}" type="image/png">
    {% include 'components/linker.html' %}
    <link rel="stylesheet" href="{% static 'css/change-plan.css' %}">
    <script src="https://securepay.tinkoff.ru/html/payForm/js/tinkoff_v2.js"></script>
</head>
<body>
    <script src="{% static 'js/second-loader.js' %}"></script>
    {% include 'components/loader.html' %}

    <div id="page-container" class="fade" style="display: none;">
        {% include 'header.html' %}
        
        <div class="container payment-container">
            <h2 class="product-title">Вы подключаете</h2>
            <p><strong class="selected_plan_text"></strong></p>

            <div class="subscription-selector">
        
                <div class="subscription-options">
                    <div class="subscription-option" data-plan="standard">
                        <div>
                            <p><strong>Стандартный план</strong></p>
                            <p class="description">Создание тестов</p>
                            <p class="description">Скачивание тестов в PDF</p>
                            <p class="description">50 тестов в сутки</p>
                            <p class="description">Доступ на 30 дней</p>
                        </div>
                        <h3 class="price">220₽</h3>
                    </div>
        
                    <div class="subscription-option active" data-plan="premium">
                        <div>
                            <p><strong>Премиум план</strong></p>
                            <p class="description">Все функции стандартного плана</p>
                            <p class="description">Загрузка своих материалов</p>
                            <p class="description">Обратная связь от ИИ</p>
                            <p class="description">90 тестов в сутки</p>
                            <p class="description">Доступ на 30 дней</p>
                        </div>
                        <h3 class="price">590₽</h3>
                    </div>
        
                    <div class="subscription-option" data-plan="tokens">
                        <div>
                            <p><strong>Пакет токенов</strong></p>
                            <p class="description">100 тыс токенов</p>
                            <p class="description">Скачивание тестов в PDF</p>
                            <p class="description">~50 тестов</p>
                            <p class="description">Без ограничений по времени</p>
                        </div>
                        <h3 class="price">480₽</h3>
                    </div>
                </div>
        
            </div>

            <div class="promo-block">
                <input type="text" id="promo-code" class="promo-input" placeholder="Промокод">
            </div>

            <p class="total-cost">Стоимость - <span id="cost"></span> руб</p>
            <p class="next-payment">Следующий платеж - <strong>17.12.2024</strong></p>

            <div class="agreement">
                <input type="checkbox" id="agreement" class="agreement-checkbox">
                <label for="agreement">Согласен с <a href="/docs/user-agreement">пользовательским соглашением</a> и <a href="/docs/privacy-policy">политикой обработки персональных данных</a>.</label>
            </div>

            <form class="payform-tbank" name="payform-tbank" id="payform-tbank">
                {% csrf_token %}
                <input class="payform-tbank-row" type="hidden" name="terminalkey" value="1731153311116DEMO">
                <input class="payform-tbank-row" type="hidden" name="frame" value="false">
                <input class="payform-tbank-row" type="hidden" name="language" value="ru">
                <input class="payform-tbank-row" type="hidden" name="receipt" value="">
                <input class="payform-tbank-row" type="hidden" placeholder="Сумма заказа" name="amount">
                <input class="payform-tbank-row" type="hidden" placeholder="Номер заказа" name="order" value="123456">
                <input class="payform-tbank-row" type="hidden" placeholder="Описание заказа" name="description" value="Тестовый заказ">
                <input class="payform-tbank-row" type="hidden" placeholder="ФИО плательщика" name="name" value="Иван Иванов">
                <input class="payform-tbank-row" type="hidden" placeholder="E-mail" name="email" value="test@mail.com">
                <input class="payform-tbank-row" type="hidden" placeholder="Контактный телефон" name="phone" value="+79001234567">
                <input class="payform-tbank-row payment-button" type="submit" value="Перейти к оплате">
            </form>
        </div>
        
        {% include 'footer.html' %}
    </div>

    <script type="text/javascript">
        const subscriptionOptions = document.querySelectorAll('.subscription-option');
        const amountInput = document.querySelector('input[name="amount"]');
        const descriptionInput = document.querySelector('input[name="description"]');
        const selectedPlanText = document.querySelectorAll('.selected_plan_text');
        const priceElements = document.querySelectorAll('.price');

        console.log(selectedPlanText[0].textContent);
        
        subscriptionOptions.forEach(option => {
            option.addEventListener('click', () => {
                subscriptionOptions.forEach(opt => opt.classList.remove('active'));
                
                option.classList.add('active');

                const selectedPlan = option.getAttribute('data-plan');
                let price, description;

                switch (selectedPlan) {
                    case 'standard':
                        price = 220;
                        description = 'Стандартный план';
                        sub_description = 'Доступ на 30 дней за ' + price + ' руб';
                        break;
                    case 'premium':
                        price = 590;
                        sub_description = 'Доступ на 30 дней за ' + price + ' руб';
                        description = 'Премиум план';
                        break;
                    case 'tokens':
                        price = 480;
                        sub_description = 'Неограниченный доступ за ' + price + ' руб';
                        description = 'Пакет токенов';
                        break;
                }

                amountInput.value = price;
                console.log(sub_description);
                descriptionInput.value = description;
                for (i=0; selectedPlanText.length; i++) {
                    selectedPlanText[i].textContent = sub_description;
                    console.log(selectedPlanText[i].textContent);
                }
            });
        });

        const TPF = document.getElementById("payform-tbank");

        TPF.addEventListener("submit", function (e) {
            e.preventDefault();
            const {description, amount, email, phone} = TPF;

            if (!email.value && !phone.value) {
                return alert("Поле E-mail или Phone не должно быть пустым");
            }

            const requestData = {
                terminalKey: TPF.terminalkey.value,
                amount: amount.value,
                orderId: TPF.order.value,
                description: description.value,
                email: email.value,
                phone: phone.value,
                receipt: JSON.stringify({
                    "EmailCompany": "mail@mail.com",
                    "Taxation": "patent",
                    "FfdVersion": "1.2",
                    "Items": [
                        {
                            "Name": description.value || "Оплата",
                            "Price": amount.value + '00',
                            "Quantity": 1.00,
                            "Amount": amount.value + '00',
                            "PaymentMethod": "full_prepayment",
                            "PaymentObject": "service",
                            "Tax": "none",
                            "MeasurementUnit": "pc"
                        }
                    ]
                })
            };

            const csrfToken = document.querySelector('input[name="csrfmiddlewaretoken"]').value;

            fetch('/api/payment/initiate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify(requestData)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok.');
                }
                return response.json();
            })
            .then(data => {
                console.log('Success:', data);
                if (data.Success) {
                    window.location.href = data.PaymentURL;
                } else {
                    alert(`Ошибка: ${data.Message}`);
                }
            })
            .catch((error) => {
                console.error('Error:', error);
                alert('Произошла ошибка при инициации платежа.');
            });
        });
    </script>
    
</body>
</html>

<!DOCTYPE html>
<html lang="ru">
<head>
    {% include 'components/meta_tags.html' %}
    <meta name="description" content="–ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {{ user.username }}">
    <meta name="keywords" content="–ø—Ä–æ—Ñ–∏–ª—å, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å, {{ user.username }}">
    {% load static %}
    {% include 'components/linker.html' %}
</head>
<body>
    <script src="{% static 'js/second-loader.js' %}"></script>
    {% include 'components/loader.html' %}

    <div id="page-container" class="fade" style="display: none;">
        {% include 'header.html' %}
        
        <div class="container profile" id="profile-container">
            <h2>–ü—Ä–æ—Ñ–∏–ª—å <span class="accent-color-text">{{ username }}</span></h2>

            <div class="profile-info">
                <p>{{ email }}</p>
                <p>{{ phone }}</p>
                <p>{{ password }}</p>

                <ul>
                    <li class="small-text">–ü–æ—Å–ª–µ–¥–Ω—è—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è: {{ date_last_login }}</li>
                    <li class="small-text">–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: {{ date_join }}</li>
                </ul>

                {% if password != '' %}
                    <form method="post" action="{% url 'password_reset' %}">
                        {% csrf_token %}
                        <div class="button-medium">
                            <button type="submit">
                                <div>
                                    <p>–°–±—Ä–æ—Å–∏—Ç—å –ø–∞—Ä–æ–ª—å</p>
                                    <img src="{% static 'img/icon-retry.png' %}" alt="">
                                </div>
                            </button>
                        </div>
                    </form>
                {% endif %}
                <!-- <div class="button-medium">
                    <a href="{% url 'verify_email' token=token %}">
                        <div>
                            <p>–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –ø–æ—á—Ç—É</p>
                            <img src="{% static 'img/icon-confirm.png' %}" alt="">
                        </div>
                    </a>
                </div> -->
                
            </div>

            <hr>

            <div class="profile-info">
                <h3>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>
                <ul>
                    <li>–°–æ–∑–¥–∞–Ω–æ —Ç–µ—Å—Ç–æ–≤: <span class="accent-color-text">{{ statistics.total_tests }}</span></li>
                    <li>–°—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª: <span id="accent-color">{{ statistics.average_score }} / 5</span></li>
                </ul>
            </div>

            <hr>

            <div class="profile-info">
                <h3>–ê–∫—Ç–∏–≤–Ω—ã–π –ø–ª–∞–Ω</h3>
                <ul>
                    <li>–ü–ª–∞–Ω <strong>{{subscription.plan_name}}</strong></li>
                    <li>–ó–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è <strong>{{subscription.plan_end_date}}</strong></li>
                </ul>
                {% if subscription.days_until_end is not none and subscription.days_until_end < 3 %}
                    <div class="button-medium button-accent">
                        <a href="{% url 'payment' %}">
                            <div>
                                <p>–ü—Ä–æ–¥–ª–∏—Ç—å {{subscription.plan_name}} üíé</p>
                            </div>
                        </a>
                    </div>
                {% elif subscription_level < 2 %}
                    <div class="button-medium">
                        <a href="{% url 'payment' %}">
                            <div>
                                <p>–ö—É–ø–∏—Ç—å –ø—Ä–µ–º–∏—É–º üíé</p>
                            </div>
                        </a>
                    </div>
                {% endif %}
            </div>

            <hr>

            <div class="profile-info">
                <h3>–¢–æ–∫–µ–Ω—ã</h3>
                <ul>
                    <li>–î–ª—è —Ç–µ—Å—Ç–æ–≤ <span class="accent-color-text">{{tokens.surveys}}</span></li>
                    <li>–î–ª—è —Ñ–∏–¥–±—ç–∫–∞ <span class="accent-color-text">{{tokens.feedback}}</span></li>
                    <li>–í—Å–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ <span class="accent-color-text">{{tokens.total_tokens}} / {{tokens.limit_tokens}}</span></li>
                </ul>
            </div>

            <div class="head-button">
                <div class="button-medium">
                    <a href="{% url 'profile' username %}">
                        <div>
                            <p>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</p>
                            <img src="{% static 'img/icon-edit.png' %}" alt="">
                        </div>
                    </a>
                </div>
                <div class="button-medium button-red">
                    <a href="{% url 'logout' %}">
                        <div>
                            <p>–í—ã–π—Ç–∏ –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è</p>
                            <img src="{% static 'img/icon-logout.png' %}" alt="">
                        </div>
                    </a>
                </div>
            </div>
        </div>

        {% include 'footer.html' %}
    </div>
    
    <script>
        function getColor(averageScore) {
            averageScore = Math.max(0, Math.min(5, averageScore));

            let red, green;

            if (averageScore <= 3) {
                red = 255;
                green = Math.round(255 * (averageScore / 5));
            } else if (averageScore <= 3.8) {
                red = 255;
                green = 255;
            } else if (averageScore <= 4.2) {
                red = Math.round(255 * (1 - (averageScore - 3) / 1.5));
                green = 255;
            } else {
                red = 0;
                green = 255;
            }
        
            return `rgb(${red}, ${green}, 0)`;
        }
        
        const averageScore = {{ statistics.average_score }};
        const color = getColor(averageScore);
        
        const scoreElement = document.getElementById('accent-color');
        scoreElement.style.color = color;
    </script>
</body>
</html>

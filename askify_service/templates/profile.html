<!DOCTYPE html>
<html lang="ru">
<head>
    {% include 'components/meta_tags.html' %}
    <meta name="description" content="–ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {{ user.username }}">
    <meta name="keywords" content="–ø—Ä–æ—Ñ–∏–ª—å, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å, {{ user.username }}">
    {% load static %}
    {% include 'components/linker.html' %}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Yandex.Metrika counter -->
    <script type="text/javascript">
        (function(m,e,t,r,i,k,a){
            m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
            m[i].l=1*new Date();
            for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}
            k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)
        })(window, document,'script','https://mc.yandex.ru/metrika/tag.js', 'ym');
        ym(98829160, 'init', {webvisor:true, clickmap:true, accurateTrackBounce:true, trackLinks:true});
    </script>
    <noscript><div><img src="https://mc.yandex.ru/watch/98829160" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
    <!-- /Yandex.Metrika counter -->
</head>
<body>
    <script src="{% static 'js/second-loader.js' %}"></script>
    {% include 'components/loader.html' %}

    <div id="page-container" class="fade" style="display: none;">
        {% include 'header.html' %}

        <main class="profile-main">
            <div class="profile-header">
                <h1>{{ username }}</h1>
                <p>–í–∞—à –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</p>
            </div>

            <div class="profile-stack">
                <!-- –ú–æ–¥—É–ª—å 1: –ü–æ–¥–ø–∏—Å–∫–∞ (–∞–∫—Ü–µ–Ω—Ç) -->
                {% if subscription_level == 0 %}
                    <div class="profile-section plan-starter">
                {% elif subscription_level == 1 %}
                    <div class="profile-section plan-standard">
                {% else %}
                    <div class="profile-section plan-premium">
                {% endif %}

                <div>
                    <div class="profile-section__header">
                        <h3><i class="fas fa-gem"></i> –ê–∫—Ç–∏–≤–Ω—ã–π –ø–ª–∞–Ω</h3>
                        {% if subscription.status == 'active' %}
                            <span class="status-badge status-badge--active">–ê–∫—Ç–∏–≤–µ–Ω</span>
                        {% else %}
                            <span class="status-badge status-badge--inactive">–ù–µ–∞–∫—Ç–∏–≤–µ–Ω</span>
                        {% endif %}
                    </div>
                    <div class="profile-section__body">
                        <div class="plan-details">
                            <h2 class="plan-title">{{ subscription.plan_name }}</h2>
                            <p class="plan-expiration">–î–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω –¥–æ: {{ subscription.plan_end_date }}</p>
                        </div>
                        
                        <div class="plan-highlights-grid">
                            <div class="plan-highlights-grid">
                                {% if subscription_level == 0 %}
                                    <div class="highlight-card">
                                        <div class="highlight-card__header">
                                            <i class="fas fa-battery-quarter highlight-icon-bad"></i>
                                            <span class="highlight-card__label">–†–∞–∑–æ–≤—ã–π –ª–∏–º–∏—Ç</span>
                                        </div>
                                        <p class="highlight-card__value">5 –≥–µ–Ω–µ—Ä–∞—Ü–∏–π</p>
                                    </div>
                                    <div class="highlight-card">
                                        <div class="highlight-card__header">
                                            <i class="fas fa-tint highlight-icon-bad"></i>
                                            <span class="highlight-card__label">–≠–∫—Å–ø–æ—Ä—Ç PDF</span>
                                        </div>
                                        <p class="highlight-card__value">–° –±—Ä–µ–Ω–¥–∏–Ω–≥–æ–º</p>
                                    </div>
                                    
                                {% elif subscription_level == 1 %}
                                    <div class="highlight-card">
                                        <div class="highlight-card__header">
                                            <i class="fas fa-bolt highlight-icon"></i>
                                            <span class="highlight-card__label">–†–∞–±–æ—á–∞—è –º–æ—â–Ω–æ—Å—Ç—å</span>
                                        </div>
                                        <p class="highlight-card__value">–î–æ 30 —Ç–µ—Å—Ç–æ–≤/–¥–µ–Ω—å</p>
                                    </div>
                                    <div class="highlight-card">
                                        <div class="highlight-card__header">
                                            <i class="fas fa-brain highlight-icon"></i>
                                            <span class="highlight-card__label">–£–º–Ω—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç</span>
                                        </div>
                                        <p class="highlight-card__value">–ê–∫—Ç–∏–≤–µ–Ω</p>
                                    </div>
                                    <div class="highlight-card">
                                        <div class="highlight-card__header">
                                            <i class="fas fa-file-invoice highlight-icon"></i>
                                            <span class="highlight-card__label">–ü—Ä–æ—Ñ. —ç–∫—Å–ø–æ—Ä—Ç</span>
                                        </div>
                                        <p class="highlight-card__value">–ë–µ–∑ –±—Ä–µ–Ω–¥–∏–Ω–≥–∞</p>
                                    </div>

                                {% else %}
                                    <div class="highlight-card">
                                        <div class="highlight-card__header">
                                            <i class="fas fa-crown highlight-icon-pro"></i>
                                            <span class="highlight-card__label">–ü—Ä–æ-–ª–∏–º–∏—Ç</span>
                                        </div>
                                        <p class="highlight-card__value">–î–æ 100 —Ç–µ—Å—Ç–æ–≤/–¥–µ–Ω—å</p>
                                    </div>
                                    <div class="highlight-card">
                                        <div class="highlight-card__header">
                                            <i class="fas fa-magic highlight-icon-pro"></i>
                                            <span class="highlight-card__label">–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è</span>
                                        </div>
                                        <p class="highlight-card__value">–ò–∑ Word –∏ PDF</p>
                                    </div>
                                    <div class="highlight-card">
                                        <div class="highlight-card__header">
                                            <i class="fas fa-chart-pie highlight-icon-pro"></i>
                                            <span class="highlight-card__label">–ü–æ–ª–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞</span>
                                        </div>
                                        <p class="highlight-card__value">–ê–∫—Ç–∏–≤–Ω–∞</p>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        {% if subscription_level == 0 %}
                        <div class="plan-upsell-hint">
                            <p>–ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ <a href="{% url 'payment' %}">–ü—Ä–µ–º–∏—É–º</a> –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ Word/PDF –∏ –ª–∏–º–∏—Ç–∞ –≤ 150 —Ç–µ—Å—Ç–æ–≤.</p>
                        </div>
                        {% endif %}
                        
                    </div>
                    <div class="profile-section__footer">
                        {% if subscription.days_until_end is not none and subscription.days_until_end < 7 %}
                            <a class="button-medium button-accent" href="{% url 'payment' %}"><div><p>–ü—Ä–æ–¥–ª–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É üî•</p></div></a>
                        {% elif subscription_level < 2 %}
                            <a href="{% url 'payment' %}" class="button-medium button-accent"><div><p>–£–ª—É—á—à–∏—Ç—å –¥–æ –ü—Ä–µ–º–∏—É–º üíé</p></div></a>
                        {% endif %}
                    </div>
                    {% if tests_today_limit == 0 %}
                        <div class="upgrade-prompt">
                            <div class="prompt-icon">
                                <i class="fas fa-exclamation-circle"></i>
                            </div>
                            <div class="prompt-text">
                                <h4>–î–Ω–µ–≤–Ω–æ–π –ª–∏–º–∏—Ç –∏—Å—á–µ—Ä–ø–∞–Ω</h4>
                                <p>–°–Ω–∏–º–∏—Ç–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –∏ –ø—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ —Ä–∞–±–æ—Ç—É, —É–ª—É—á—à–∏–≤ —Å–≤–æ–π –ø–ª–∞–Ω.</p>
                            </div>
                            <a href="{% url 'payment' %}" class="button-medium button-accent">
                                <div><i class="fas fa-arrow-up"></i><p>–ê–ø–≥—Ä–µ–π–¥</p></div>
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- –ú–æ–¥—É–ª—å –õ–∏–º–∏—Ç—ã -->
            <div class="profile-section">
                <div class="profile-section__header">
                    <h3><i class="fas fa-sliders-h"></i> –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ</h3>
                </div>

                <div class="profile-section__body">
                    <div class="usage-item">
                        <div class="usage-label">
                            <span>–î–æ—Å—Ç—É–ø–Ω–æ —Ç–µ—Å—Ç–æ–≤ —Å–µ–≥–æ–¥–Ω—è</span>
                            <span class="usage-value accent-color-text">{{ tokens.tests_remaining_count_limit }} / {{ tokens.tests_total_limit }}</span>
                        </div>
                        <div class="progress-bar {{ tokens.progress_bar_class }}">
                            <div class="progress-bar__fill" style="width: {{ tokens.tests_usage_percentage }}%;"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- –ú–æ–¥—É–ª—å –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
            <div class="profile-section">
                <div class="profile-section__header">
                    <h3><i class="fas fa-user-chart"></i> –í–∞—à–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</h3>
                </div>
                <div class="profile-section__body">
                    <div class="stats-container">
                        {% if subscription_level == 0 %}
                            <div class="stats-blur-overlay">
                                <div class="stats-upsell">
                                    <i class="fas fa-lock"></i><h4>–†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞</h4>
                                    <p>–í–∏–∑—É–∞–ª—å–Ω—ã–µ –≥—Ä–∞—Ñ–∏–∫–∏ –í–∞—à–µ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –¥–æ—Å—Ç—É–ø–Ω—ã –Ω–∞ –ø–ª–∞—Ç–Ω—ã—Ö —Ç–∞—Ä–∏—Ñ–∞—Ö.</p>
                                    <a href="{% url 'payment' %}" class="button-medium button-accent"><div><p>–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å üíé</p></div></a>
                                </div>
                            </div>
                        {% endif %}
                        <div class="charts-grid">
                            <div class="chart-card">
                                <h4>–°–æ–∑–¥–∞–Ω–æ —Ç–µ—Å—Ç–æ–≤</h4>
                                <p>–∑–∞ 7 –¥–Ω–µ–π</p>
                                <div class="chart-wrapper"><canvas id="personalActivityChart"></canvas></div>
                            </div>
                            <div class="chart-card">
                                <h4>–ü—Ä–æ—Å–º–æ—Ç—Ä—ã —Ç–µ—Å—Ç–æ–≤</h4>
                                <p>–∑–∞ 7 –¥–Ω–µ–π</p>
                                <div class="chart-wrapper"><canvas id="personalViewsChart"></canvas></div>
                            </div>
                            <div class="chart-card">
                                <h4>–ö–∞—á–µ—Å—Ç–≤–æ —Ç–µ—Å—Ç–æ–≤</h4>
                                <p>–ü–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –≤–æ–ø—Ä–æ—Å–æ–≤</p>
                                <div class="chart-wrapper"><canvas id="qualityChart"></canvas></div>
                            </div>
                            <div class="chart-card">
                                <h4>–¢–∏–ø—ã –≤–æ–ø—Ä–æ—Å–æ–≤</h4>
                                <p>–ê–Ω–∞–ª–∏–∑ –ø–æ –≤—Å–µ–º –≤–∞—à–∏–º —Ç–µ—Å—Ç–∞–º</p>
                                <div class="chart-wrapper"><canvas id="questionTypesChart"></canvas></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- –ú–æ–¥—É–ª—å –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —É—á–µ–Ω–∏–∫–æ–≤ -->
            <div class="profile-section">
                <div class="profile-section__header">
                    <h3><i class="fas fa-users"></i> –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ü—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏–π</h3>
                </div>
                <div class="profile-section__body">
                    <div class="stats-container">
                        {% if subscription_level == 0 %}
                            <div class="stats-blur-overlay">
                                <div class="stats-upsell">
                                    <i class="fas fa-lock"></i><h4>–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ –æ—Ç–≤–µ—Ç–∞–º</h4>
                                    <p>–û—Ç—Å–ª–µ–∂–∏–≤–∞–π—Ç–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∏ –∫–∞—á–µ—Å—Ç–≤–æ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏–π –Ω–∞ –ø–ª–∞—Ç–Ω—ã—Ö —Ç–∞—Ä–∏—Ñ–∞—Ö.</p>
                                    <a href="{% url 'payment' %}" class="button-medium button-accent"><div><p>–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å üíé</p></div></a>
                                </div>
                            </div>
                        {% endif %}
                        <div class="charts-grid">
                            <div class="chart-card">
                                <h4>–ü—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏–π —Ç–µ—Å—Ç–æ–≤ –∑–∞ 7 –¥–Ω–µ–π</h4>
                                <div class="chart-wrapper"><canvas id="studentActivityChart"></canvas></div>
                            </div>
                            <div class="chart-card">
                                <h4>–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤</h4>
                                <div class="chart-wrapper"><canvas id="studentScoresChart"></canvas></div>
                            </div>
                            <div class="chart-card">
                                <h4>–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ —á–∞—Å–∞–º</h4>
                                <p>–∑–∞ 7 –¥–Ω–µ–π</p>
                                <div class="chart-wrapper"><canvas id="hourlyActivityChart"></canvas></div>
                            </div>
                            <div class="chart-card">
                                <h4>–ü–æ–ø—É–ª—è—Ä–Ω—ã–µ —Ç–µ—Å—Ç—ã</h4>
                                <p>–ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏–π</p>
                                <div class="chart-wrapper"><canvas id="surveyEngagementChart"></canvas></div>
                            </div>
                        </div>
                    </div>
                </div>
                {% if top_surveys %}
                    <div class="top-surveys-container">
                        <h4><i class="fas fa-fire"></i> –°–∞–º—ã–µ –ø–æ–ø—É–ª—è—Ä–Ω—ã–µ —Ç–µ—Å—Ç—ã</h4>
                        <ul class="top-surveys-list">
                            {% for survey in top_surveys %}
                            <li>
                                <a href="{% url 'preview_test_result' survey.survey_id %}">
                                    <div class="survey-info">
                                        <span class="survey-title">{{ survey.title }}</span>
                                        <span class="survey-meta">–°–æ–∑–¥–∞–Ω: {{ survey.created_at }}</span>
                                    </div>
                                    <div class="survey-stats">
                                        <i class="fas fa-eye"></i>
                                        <span>{{ survey.view_count }}</span>
                                    </div>
                                </a>
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}
            </div>

            <!-- –ú–æ–¥—É–ª—å –ò—Å—Ç–æ—Ä–∏—è –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–π -->
            <div class="profile-section">
                <div class="profile-section__header">
                    <h3><i class="fas fa-receipt"></i> –ò—Å—Ç–æ—Ä–∏—è –ø–ª–∞—Ç–µ–∂–µ–π</h3>
                </div>
                <div class="profile-section__body">
                    {% if payments %}
                        <div class="transaction-log">
                            {% for payment in payments %}
                                {% if payment.status == 'completed' %}
                                    <div class="transaction-log__item --success">
                                {% elif payment.status == 'failed' %}
                                    <div class="transaction-log__item --failed">
                                {% else %}
                                    <div class="transaction-log__item --pending">
                                {% endif %}
                                        <div class="transaction-log__status-dot"></div>
                                        <div class="transaction-log__info">
                                            <p class="transaction-log__title">–ü–æ–∫—É–ø–∫–∞ ¬´{{ payment.subscription.get_human_plan }}¬ª</p>
                                            <p class="transaction-log__subtitle">{{ payment.created_at|date:"d M Y, H:i" }} ‚Ä¢ –ó–∞–∫–∞–∑ {{ payment.order_id }}</p>
                                        </div>
                                        <p class="transaction-log__amount">{{ payment.amount_display }} ‚ÇΩ</p>
                                    </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="no-data-message-final">
                            <i class="fas fa-receipt"></i>
                            <h3>–ù–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π</h3>
                            <p>–ö–æ–≥–¥–∞ –≤—ã —Å–æ–≤–µ—Ä—à–∏—Ç–µ –ø–æ–∫—É–ø–∫—É, –æ–Ω–∞ –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å.</p>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- –ú–æ–¥—É–ª—å –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞–∫–∫–∞—É–Ω—Ç–æ–º -->
            <div class="profile-section">
                <div class="profile-section__header">
                    <h3><i class="fas fa-user-cog"></i> –ê–∫–∫–∞—É–Ω—Ç</h3>
                </div>
                <div class="profile-section__body">
                    <ul class="profile-list">
                        {% if user.email %}<li><span class="label">E-mail</span><span class="value">{{ user.email }}</span></li>{% endif %}
                        {% if phone != '–¢–µ–ª–µ—Ñ–æ–Ω: –ù–µ —É–∫–∞–∑–∞–Ω' %}<li><span class="label">–¢–µ–ª–µ—Ñ–æ–Ω</span><span class="value">{{ user.phone }}</span></li>{% endif %}
                    </ul>
                </div>
                <div class="profile-section__footer action-buttons">
                    {% if password != '' %}
                        <form method="post" action="{% url 'password_reset' %}">
                            {% csrf_token %}
                            <button type="submit" class="button-medium"><div><p>–°–±—Ä–æ—Å–∏—Ç—å –ø–∞—Ä–æ–ª—å</p></div></button>
                        </form>
                    {% endif %}
                    <div class="button-medium button-red" id="logout-button"><div><p>–í—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞</p></div></div>
                </div>
                    {% if user.is_superuser %}
                    <a class="button-medium admin-button" href="{% url 'db_viewer' %}"><div><p>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å üëë</p></div></a>
                {% endif %}
            </div>
            </div>
        </main>
    </div>

    <!-- –ú–æ–¥–∞–ª–∫–∞ logout -->
    <div id="logout-modal" class="action-modal">
        <div class="action-modal__content">
            <div class="action-modal__header">
                <div class="action-modal__icon">
                    <i class="fas fa-sign-out-alt"></i>
                </div>
                <h3>–í—ã—Ö–æ–¥ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞</h3>
            </div>
            <div class="action-modal__body">
                <p>–í—ã –±—É–¥–µ—Ç–µ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω—ã –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤—Ö–æ–¥–∞. –£–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å?</p>
            </div>
            <div class="action-modal__footer">
                <div id="action-modal-cancel" class="button-medium"><div><p>–û—Ç–º–µ–Ω–∞</p></div></div>
                <div id="action-modal-confirm" class="button-medium button-red"><div><p>–í—ã–π—Ç–∏</p></div></div>
            </div>
        </div>
    </div>

    <script>
        function setupActionModal(modalId, triggerId, confirmId, cancelId, confirmUrl) {
            const modal = document.getElementById(modalId);
            const triggerButton = document.getElementById(triggerId);
            const confirmButton = document.getElementById(confirmId);
            const cancelButton = document.getElementById(cancelId);

            if (!modal || !triggerButton || !confirmButton || !cancelButton) {
                console.error('Modal setup failed: one or more elements not found.');
                return;
            }

            const showModal = () => modal.classList.add('is-visible');
            const hideModal = () => modal.classList.remove('is-visible');

            triggerButton.addEventListener('click', showModal);
            cancelButton.addEventListener('click', hideModal);

            modal.addEventListener('click', (event) => {
                if (event.target === modal) {
                    hideModal();
                }
            });

            confirmButton.addEventListener('click', () => {
                window.location.href = confirmUrl;
            });
        }

        setupActionModal(
            'logout-modal', 
            'logout-button',
            'action-modal-confirm',
            'action-modal-cancel',
            "{% url 'logout' %}"
        );
    </script>
    
    <script>
        const chartInstances = {};

        function destroyChart(chartId) {
            if (chartInstances[chartId]) {
                chartInstances[chartId].destroy();
                delete chartInstances[chartId];
            }
        }

        const barChartOptions = {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { 
                legend: { display: false },
                tooltip: {
                    backgroundColor: 'rgba(18, 17, 25, 0.8)',
                    titleFont: { family: 'Unbounded Medium' },
                    bodyFont: { family: 'Namu Pro' },
                    padding: 10,
                    cornerRadius: 4
                }
            },
            scales: {
                y: { 
                    beginAtZero: true, 
                    ticks: { color: '#8e8d93', precision: 0 },
                    grid: { color: 'rgba(255, 255, 255, 0.05)' }
                },
                x: { 
                    ticks: { color: '#8e8d93' },
                    grid: { display: false }
                }
            }
        };

        const lineChartOptions = {
            ...barChartOptions,
            interaction: {
                intersect: false,
                mode: 'index',
            },
        };

        const doughnutChartOptions = {
            responsive: true,
            maintainAspectRatio: false,
            cutout: '70%',
            plugins: {
                legend: { 
                    display: true,
                    position: 'bottom',
                    labels: { 
                        color: '#bab8c1', 
                        boxWidth: 12, 
                        padding: 20,
                        font: { family: 'Namu Pro' }
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(18, 17, 25, 0.8)',
                    titleFont: { family: 'Unbounded Medium' },
                    bodyFont: { family: 'Namu Pro' },
                    padding: 10,
                    cornerRadius: 4
                }
            }
        };


        function initializeProfileCharts() {
            const subscriptionLevel = {{ subscription_level }};
            if (subscriptionLevel === 0) {
                Object.keys(chartInstances).forEach(destroyChart);
                return;
            }

            fetch("{% url 'personal_charts_api' %}")
                .then(response => response.json())
                .then(data => {
                    destroyChart('personalActivityChart');
                    destroyChart('personalViewsChart');
                    
                    const activityCtx = document.getElementById('personalActivityChart')?.getContext('2d');
                    if (activityCtx) {
                        chartInstances.personalActivityChart = new Chart(activityCtx, {
                            type: 'bar',
                            data: {
                                labels: data.activity_chart.labels,
                                datasets: [{
                                    label: '–°–æ–∑–¥–∞–Ω–æ',
                                    data: data.activity_chart.data,
                                    backgroundColor: 'rgba(97, 109, 240, 0.6)',
                                    borderColor: 'rgba(97, 109, 240, 1)',
                                    borderRadius: 4,
                                    hoverBackgroundColor: 'rgba(97, 109, 240, 0.8)'
                                }]
                            },
                            options: barChartOptions
                        });
                    }

                    const viewsCtx = document.getElementById('personalViewsChart')?.getContext('2d');
                    if (viewsCtx) {
                        chartInstances.personalViewsChart = new Chart(viewsCtx, {
                            type: 'line',
                            data: {
                                labels: data.views_chart.labels,
                                datasets: [{
                                    label: '–ü—Ä–æ—Å–º–æ—Ç—Ä—ã',
                                    data: data.views_chart.data,
                                    backgroundColor: 'rgba(121, 239, 102, 0.1)',
                                    borderColor: 'rgba(121, 239, 102, 1)',
                                    tension: 0.3,
                                    fill: true,
                                    pointBackgroundColor: 'rgba(121, 239, 102, 1)',
                                    pointBorderColor: '#fff',
                                    pointHoverRadius: 6
                                }]
                            },
                            options: lineChartOptions
                        });
                    }

                    destroyChart('qualityChart');
                    const qualityCtx = document.getElementById('qualityChart')?.getContext('2d');
                    if (qualityCtx) {
                        chartInstances.qualityChart = new Chart(qualityCtx, {
                            type: 'doughnut',
                            data: {
                                labels: data.quality_chart.labels,
                                datasets: [{
                                    data: data.quality_chart.data,
                                    backgroundColor: ['rgba(231, 76, 117, 0.7)', 'rgba(121, 239, 102, 0.7)', 'rgba(255, 199, 0, 0.7)'],
                                    borderColor: '#121119',
                                    borderWidth: 3,
                                }]
                            },
                            options: doughnutChartOptions
                        });
                    }

                    destroyChart('questionTypesChart');
                    const questionTypesCtx = document.getElementById('questionTypesChart')?.getContext('2d');
                    if (questionTypesCtx && data.question_types_chart.data.length > 0) {
                        chartInstances.questionTypesChart = new Chart(questionTypesCtx, {
                            type: 'pie',
                            data: {
                                labels: data.question_types_chart.labels,
                                datasets: [{
                                    data: data.question_types_chart.data,
                                    backgroundColor: ['#616DF0', '#36A2EB', '#FFCD56', '#8e8d93'],
                                    borderColor: '#121119',
                                    borderWidth: 3,
                                }]
                            },
                            options: doughnutChartOptions
                        });
                    }

                }).catch(error => console.error('Personal charts error:', error));

            fetch("{% url 'student_charts_api' %}")
                .then(response => response.json())
                .then(data => {
                    destroyChart('studentActivityChart');
                    destroyChart('studentScoresChart');

                    const studentActivityCtx = document.getElementById('studentActivityChart')?.getContext('2d');
                    if(studentActivityCtx) {
                        chartInstances.studentActivityChart = new Chart(studentActivityCtx, {
                            type: 'bar',
                            data: {
                                labels: data.attempts_activity_chart.labels,
                                datasets: [{
                                    label: '–ü—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏–π',
                                    data: data.attempts_activity_chart.data,
                                    backgroundColor: 'rgba(97, 109, 240, 0.6)',
                                    borderColor: 'rgba(97, 109, 240, 1)',
                                    borderRadius: 4,
                                    hoverBackgroundColor: 'rgba(97, 109, 240, 0.8)'
                                }]
                            },
                            options: barChartOptions
                        });
                    }

                    const studentScoresCtx = document.getElementById('studentScoresChart')?.getContext('2d');
                    if (studentScoresCtx) {
                        chartInstances.studentScoresChart = new Chart(studentScoresCtx, {
                            type: 'doughnut',
                            data: {
                                labels: data.scores_chart.labels,
                                datasets: [{
                                    data: data.scores_chart.data,
                                    backgroundColor: ['rgba(121, 239, 102, 0.7)', 'rgba(255, 199, 0, 0.7)', 'rgba(231, 76, 117, 0.7)'],
                                    borderColor: '#121119',
                                    borderWidth: 3,
                                    hoverOffset: 8,
                                    hoverBorderColor: '#121119'
                                }]
                            },
                            options: doughnutChartOptions
                        });
                    }

                    destroyChart('hourlyActivityChart');
                    const hourlyActivityCtx = document.getElementById('hourlyActivityChart')?.getContext('2d');
                    if (hourlyActivityCtx && data.hourly_activity_chart.data.length > 0) {
                        chartInstances.hourlyActivityChart = new Chart(hourlyActivityCtx, {
                            type: 'line',
                            data: {
                                labels: data.hourly_activity_chart.labels,
                                datasets: [{
                                    label: '–ü—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏–π',
                                    data: data.hourly_activity_chart.data,
                                    borderColor: 'rgba(255, 159, 64, 1)',
                                    backgroundColor: 'rgba(255, 159, 64, 0.2)',
                                    fill: true,
                                    tension: 0.4,
                                }]
                            },
                            options: lineChartOptions
                        });
                    }

                    destroyChart('surveyEngagementChart');
                    const surveyEngagementCtx = document.getElementById('surveyEngagementChart')?.getContext('2d');
                    if (surveyEngagementCtx && data.survey_engagement_chart.data.length > 0) {
                        chartInstances.surveyEngagementChart = new Chart(surveyEngagementCtx, {
                            type: 'polarArea',
                            data: {
                                labels: data.survey_engagement_chart.labels,
                                datasets: [{
                                    label: '–ö–æ–ª-–≤–æ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏–π',
                                    data: data.survey_engagement_chart.data,
                                    backgroundColor: [
                                        'rgba(97, 109, 240, 0.7)',
                                        'rgba(121, 239, 102, 0.7)',
                                        'rgba(255, 205, 86, 0.7)',
                                        'rgba(255, 99, 132, 0.7)',
                                        'rgba(54, 162, 235, 0.7)',
                                        'rgba(153, 102, 255, 0.7)',
                                        'rgba(255, 159, 64, 0.7)'
                                    ],
                                    borderWidth: 0
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: { legend: { display: false } },
                                scales: {
                                    r: {
                                        ticks: { display: false },
                                        grid: { color: 'rgba(255, 255, 255, 0.05)' }
                                    }
                                }
                            }
                        });
                    }

                }).catch(error => console.error('Student charts error:', error));
        }

        document.addEventListener('DOMContentLoaded', initializeProfileCharts);
        </script>

</body>
</html>

<!DOCTYPE html>
<html lang="ru">
<head>
    {% include 'components/meta_tags.html' %}
    <meta name="description" content="–ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {{ user.username }}">
    <meta name="keywords" content="–ø—Ä–æ—Ñ–∏–ª—å, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å, {{ user.username }}">
    {% load static %}
    {% include 'components/linker.html' %}
</head>
<body>
    <script src="{% static 'js/second-loader.js' %}"></script>
    {% include 'components/loader.html' %}

    <div id="page-container" class="fade" style="display: none;">
        {% include 'header.html' %}
        
        <div class="container profile" id="profile-container">
            <h2>–ü—Ä–æ—Ñ–∏–ª—å <span class="accent-color-text">{{ username }}</span></h2>

            <div class="profile-info">
                <p>{{ email }}</p>
                <p>{{ phone }}</p>
                <p>{{ password }}</p>

                <ul>
                    <li class="small-text">–ü–æ—Å–ª–µ–¥–Ω—è—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è: {{ date_last_login }}</li>
                    <li class="small-text">–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: {{ date_join }}</li>
                </ul>

                {% if password != '' %}
                    <form method="post" action="{% url 'password_reset' %}">
                        {% csrf_token %}
                        <div class="button-medium">
                            <button type="submit">
                                <div>
                                    <p>–°–±—Ä–æ—Å–∏—Ç—å –ø–∞—Ä–æ–ª—å</p>
                                    <img src="{% static 'img/icon-retry.png' %}" alt="">
                                </div>
                            </button>
                        </div>
                    </form>
                {% endif %}
                <!-- <div class="button-medium">
                    <a href="{% url 'verify_email' token=token %}">
                        <div>
                            <p>–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –ø–æ—á—Ç—É</p>
                            <img src="{% static 'img/icon-confirm.png' %}" alt="">
                        </div>
                    </a>
                </div> -->
                
            </div>

            <hr>

            <div class="profile-info">
                <h3>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>
                <ul>
                    <li>–°–æ–∑–¥–∞–Ω–æ —Ç–µ—Å—Ç–æ–≤: <span class="accent-color-text">{{ statistics.total_tests }}</span></li>
                    <li>–ü—Ä–æ–π–¥–µ–Ω–æ: <span id="accent-color">{{ statistics.passed_tests }}</span></li>
                    <li>–õ—É—á—à–∏–π: <span id="accent-color">{{ statistics.best_result }}</span></li>
                </ul>
            </div>

            <hr>

            <div class="profile-info">
                <h3>–ê–∫—Ç–∏–≤–Ω—ã–π –ø–ª–∞–Ω</h3>
                <ul>
                    <li>–ü–ª–∞–Ω <strong>{{subscription.plan_name}}</strong>, –∏ –æ–Ω {{ subscription.plan_end_date }}</li>
                </ul>
                {% if subscription.days_until_end is not none and subscription.days_until_end < 3 %}
                    <div class="button-medium button-accent">
                        <a href="{% url 'payment' %}">
                            <div>
                                <p>–ü—Ä–æ–¥–ª–∏—Ç—å üíé</p>
                            </div>
                        </a>
                    </div>
                {% elif subscription_level < 2 or subscription_level == 99 %}
                    <div class="button-medium">
                        <a href="{% url 'payment' %}">
                            <div>
                                <p>–ö—É–ø–∏—Ç—å –ø—Ä–µ–º–∏—É–º üíé</p>
                            </div>
                        </a>
                    </div>
                {% endif %}
            </div>

            <hr>

            {% if user.is_superuser %}
                <div class="admin-only-hint">
                    <small>–í–∏–¥–Ω–æ —Ç–æ–ª—å–∫–æ —Ç–µ–±–µ, –ø–æ–≤–µ–ª–∏—Ç–µ–ª—å</small>
                </div>
                <div class="button-medium button-accent" style="margin: 20px 0; background: #ff4757;">
                    <a href="{% url 'db_viewer' %}">
                        <div>
                            <p>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å üëë</p>
                        </div>
                    </a>
                </div>
            {% endif %}

            <div class="profile-info">
                <h3>–¢–æ–∫–µ–Ω—ã –≤ —ç—Ç–æ–º –º–µ—Å—è—Ü–µ</h3>
                <ul>
                    <li>–î–ª—è —Ç–µ—Å—Ç–æ–≤ <span class="accent-color-text">{{tokens.surveys}}</span></li>
                    <li>–î–ª—è —Ñ–∏–¥–±—ç–∫–∞ <span class="accent-color-text">{{tokens.feedback}}</span></li>
                    <li>–í—Å–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ <span class="accent-color-text">{{tokens.total_tokens}}</span></li>
                </ul>
                <hr>
                <h3>–õ–∏–º–∏—Ç—ã</h3>
                <ul>
                    <li>–î–æ—Å—Ç—É–ø–Ω–æ —Å–æ–∑–¥–∞—Ç—å <span class="accent-color-text">{{ tokens.tests_remaining_count_limit }}</span> —Ç–µ—Å—Ç–æ–≤ —Å–µ–≥–æ–¥–Ω—è</li>
                </ul>
            </div>

            <div class="head-button">
                <div class="button-medium">
                    <a href="{% url 'payment' %}">
                        <div>
                            <p>–¢–∞—Ä–∏—Ñ—ã</p>
                            <img src="{% static 'img/icon-tokens.png' %}" alt="">
                        </div>
                    </a>
                </div>

                <div class="button-medium button-red" id="logout-button">
                    <div>
                        <p>–í—ã–π—Ç–∏</p>
                        <img src="{% static 'img/icon-logout.png' %}" alt="">
                    </div>
                </div>

            </div>
        </div>
        {% include 'ui_components/bottom_menu.html' %}

        {% include 'footer-s.html' %}
    </div>

    <div id="modal-exit" class="modal">
        <div class="modal-content">
            <h3>–í—ã —É–≤–µ—Ä–µ–Ω—ã?</h3>
            <p>–ü–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –≤—ã –±—É–¥–µ—Ç–µ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω—ã –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏</p>
            <div class="buttons-container">
                <button id="cancel-logout" class="">–û—Ç–º–µ–Ω–∞</button>
                <button id="confirm-logout"  class="button-red">–í—ã–π—Ç–∏</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const progressBarFill = document.getElementById('token-progress-fill');
            const monthlyUsed = parseFloat("{{ tokens.monthly_used|default:0 }}".replace(/\s/g, ''));
            const monthlyLimit = parseFloat("{{ tokens.monthly_limit|default:1 }}".replace(/\s/g, ''));

            let percentage = 0;
            let fillColorClass = 'normal';

            if (monthlyLimit > 0) {
                percentage = (monthlyUsed / monthlyLimit) * 100;
                if (percentage > 100) {
                    fillColorClass = 'exceeded';
                    percentage = 100;
                }
            }
            
            progressBarFill.classList.remove('normal', 'exceeded');
            progressBarFill.classList.add(fillColorClass);

            progressBarFill.style.width = percentage + '%';
        });
    </script>

    <script>
        function modalWindow(elementId) {
            document.getElementById('logout-button').addEventListener('click', function() {
                document.getElementById(elementId).style.display = 'flex';
            });
            
            document.getElementById('cancel-logout').addEventListener('click', function() {
                document.getElementById(elementId).style.display = 'none';
            });
            
            document.getElementById('confirm-logout').addEventListener('click', function() {
                window.location.href = "{% url 'logout' %}";
            });
        }

        modalWindow('modal-exit-menu');
        modalWindow('modal-exit');
    </script>
    
    <script>
        function getColor(averageScore) {
            averageScore = Math.max(0, Math.min(5, averageScore));

            let red, green;

            if (averageScore <= 3) {
                red = 255;
                green = Math.round(255 * (averageScore / 5));
            } else if (averageScore <= 3.8) {
                red = 255;
                green = 255;
            } else if (averageScore <= 4.2) {
                red = Math.round(255 * (1 - (averageScore - 3) / 1.5));
                green = 255;
            } else {
                red = 0;
                green = 255;
            }
        
            return `rgb(${red}, ${green}, 0)`;
        }
        
        const averageScore = {{ statistics.average_score }};
        const color = getColor(averageScore);
        
        const scoreElement = document.getElementById('accent-color');
        scoreElement.style.color = color;
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Пульс Летучки | Летучка</title>
    <meta name="robots" content="noindex, nofollow" />
    {% load static %}
    <link rel="shortcut icon" href="{% static 'img/logo.png' %}" type="image/png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&family=Unbounded:wght@500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js'></script>

    <style>
        :root {
            --color-bg: #0F0818;
            --color-surface: rgba(30, 24, 48, 0.5);
            --color-border: rgba(97, 109, 240, 0.2);
            --color-text-primary: #f0f0f0;
            --color-text-secondary: #a0a0b0;
            --color-accent-primary: #616DF0;
            --color-accent-secondary: #79EF66;
            --color-red: #F06161;
        }
        body { background-color: var(--color-bg); color: var(--color-text-primary); font-family: 'Inter', sans-serif; }
        h1, h2, h3 { font-family: 'Unbounded', sans-serif; }
        .gradient-text {
            background: linear-gradient(45deg, var(--color-accent-primary), var(--color-accent-secondary));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        .progress-bar-fill { transition: width 0.5s ease-in-out; }

        /* --- ДОБАВЬ ЭТОТ CSS В <style> --- */
        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 15px 3px rgba(79, 70, 229, 0.4); }
            50% { box-shadow: 0 0 25px 8px rgba(79, 70, 229, 0.2); }
        }
        .gauge-glow {
            animation: pulse-glow 4s ease-in-out infinite;
        }
        .text-glow {
            text-shadow: 0 0 8px rgba(255, 255, 255, 0.3);
        }

        .gauge-ring {
            transition: stroke-dashoffset 1s ease-in-out;
        }

        /* --- Стили реактора --- */
        .reactor-container {
            position: relative;
            width: 16rem;
            height: 8rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .reactor-svg {
            position: absolute;
            top: 0;
            width: 100%;
            height: auto;
        }
        .reactor-arc {
            fill: none;
            stroke-linecap: round;
            transition: all 1.5s cubic-bezier(0.6, 0, 0.4, 1);
        }
        .reactor-gauge__track {
            stroke: rgba(31, 41, 55, 0.5);
            stroke-width: 12;
        }
        .reactor-gauge__fill {
            stroke: url(#reactor-gradient);
            stroke-width: 12;
            stroke-dasharray: 141.3;
            stroke-dashoffset: 141.3;
        }
        .reactor-gauge__spark {
            stroke: url(#spark-gradient);
            stroke-width: 4;
            stroke-dasharray: 5 136.3;
            stroke-dashoffset: 146.3;
            filter: drop-shadow(0 0 5px #79EF66);
        }
        .reactor-gauge__trail {
            stroke: url(#reactor-gradient);
            stroke-width: 14;
            stroke-dasharray: 141.3;
            stroke-dashoffset: 141.3;
            filter: blur(8px);
            opacity: 0.6;
        }
        .reactor-text-container {
            position: relative;
            z-index: 10;
            text-align: center;
            margin-top: 1.5rem;
            opacity: 0;
            transform: scale(0.9);
            transition: opacity 0.5s ease, transform 0.5s ease;
        }

        @keyframes final-pulse {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(121, 239, 102, 0); }
            50% { transform: scale(1.02); box-shadow: 0 0 20px 10px rgba(121, 239, 102, 0.2); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(121, 239, 102, 0); }
        }
        .final-pulse-animation {
            animation: final-pulse 1s cubic-bezier(0.6, 0, 0.4, 1);
        }

        .log-tab {
            padding: 4px 12px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            color: #9CA3AF; 
            background-color: transparent;
            transition: all 0.2s ease;
        }
        .log-tab:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        .log-tab.active {
            color: white;
            background-color: #4F46E5;
        }

        .log-content {
            position: absolute;
            inset: 0;
            overflow-y: auto;
            text-xs: 12px;
            color: #D1D5DB;
            font-family: monospace;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
            white-space: pre-wrap;
        }
        .log-content.active {
            opacity: 1;
            pointer-events: auto;
        }

        /* --- СТИЛИ ДЛЯ КАЛЕНДАРЯ И ТУЛТИПА --- */
        #churn-calendar { --fc-border-color: var(--color-border); --fc-today-bg-color: rgba(97, 109, 240, 0.1); }
        .fc-col-header-cell-cushion, .fc-daygrid-day-number { color: var(--color-text-secondary); text-decoration: none; }
        .fc .fc-button-primary { background-color: var(--color-accent-primary); border: none; }
        .fc .fc-button-primary:hover { background-color: #4a57d0; }
        .fc-event { font-weight: 600; cursor: pointer; }
        
        #calendar-tooltip {
            position: absolute;
            z-index: 100;
            background: rgba(15, 8, 24, 0.9);
            backdrop-filter: blur(8px);
            color: white;
            padding: 0.75rem 1rem;
            border-radius: 0.75rem;
            border: 1px solid var(--color-border);
            font-size: 0.875rem;
            pointer-events: none;
            opacity: 0;
            transform: scale(0.95);
            transition: opacity 0.2s ease, transform 0.2s ease;
        }

        .satellite-widget {
            background: linear-gradient(145deg, rgba(30, 24, 48, 0.4), rgba(15, 8, 24, 0.3));
            border-radius: 1.25rem;
            border: 1px solid var(--color-border);
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            min-height: 280px;
        }
        .satellite-widget .title {
            font-family: 'Unbounded Medium', sans-serif;
            font-size: 1.125rem;
            color: white;
        }

        .progress-ring {
            position: relative;
            width: 100px;
            height: 100px;
        }
        .progress-ring svg {
            transform: rotate(-90deg);
        }
        .progress-ring circle {
            transition: stroke-dashoffset 1s ease-out;
        }
        .progress-ring .value-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-family: 'Unbounded Medium', sans-serif;
            font-size: 1.5rem;
            color: white;
        }

        .stacked-bar {
            display: flex;
            height: 1rem;
            width: 100%;
            background-color: rgba(0,0,0,0.3);
            border-radius: 9999px;
            overflow: hidden;
        }
        .stacked-bar-segment {
            height: 100%;
            transition: width 1s ease-out;
        }

        /* --- СТИЛИ ДЛЯ ВИДЖЕТА "КАЧЕСТВО КОГОРТ" --- */
        .cohort-metric {
            position: relative;
            padding-top: 1rem;
            border-top: 1px solid var(--color-border);
        }
        .cohort-metric:first-child {
            border-top: none;
            padding-top: 0;
        }
        .metric-ring {
            position: relative;
            width: 64px;
            height: 64px;
        }
        .metric-ring svg {
            transform: rotate(-90deg);
        }
        .metric-ring circle {
            transition: stroke-dashoffset 1s ease-out;
        }
        .metric-ring .value-text {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            font-family: 'Unbounded Medium', sans-serif;
            font-size: 1.125rem;
            color: white;
        }
        .metric-ring .value-text .unit {
            font-size: 0.875rem;
            color: var(--color-text-secondary);
        }
    </style>
</head>
<body class="bg-[var(--color-bg)] text-[var(--color-text-primary)]">

    {% include 'header.html' %}

    <main class="max-w-7xl mx-auto p-4 sm:p-8 space-y-8 mt-16">
        
        <div class="flex flex-col md:flex-row justify-between md:items-center gap-4">
            <h1 class="text-3xl font-bold text-white">Пульс Летучки</h1>
            <div>
                <a href="{% url 'user_ops_center' %}" class="w-auto px-4 py-2 font-bold text-center rounded-2xl bg-[var(--color-accent-primary)] text-white text-sm">CRM-машина</a>
            </div>
            <div class="bg-[var(--color-surface)] p-2 rounded-2xl border border-[var(--color-border)]">
                <form method="get" class="flex flex-col sm:flex-row items-center gap-2">
                    <input type="date" name="start_date" value="{{ start_date }}" class="w-full sm:w-auto p-2 bg-[var(--color-bg)] border border-[var(--color-border)] rounded-lg text-sm">
                    <span class="text-gray-500 hidden sm:block">-</span>
                    <input type="date" name="end_date" value="{{ end_date }}" class="w-full sm:w-auto p-2 bg-[var(--color-bg)] border border-[var(--color-border)] rounded-lg text-sm">
                    <button type="submit" class="w-full sm:w-auto px-4 py-2 font-bold text-center rounded-2xl bg-[var(--color-accent-primary)] text-white text-sm">Применить</button>
                </form>
            </div>
        </div>

        <!-- <--- ГЛАВНЫЙ ПРИБОР -->
        <section class="bg-black/20 p-4 sm:p-6 rounded-3xl border border-[var(--color-border)] mb-8">
            <!-- Верхняя строка состояния -->
            <div class="flex justify-between items-center text-xs text-[var(--color-text-secondary)] border-b border-[var(--color-border)] pb-3 mb-3">
                <div class="flex items-center gap-4">
                    <div title="Новые реальные пользователи сегодня"><i class="fa-solid fa-user-plus text-green-400"></i> {{ main_gauge.status_bar.new_users_today }}</div>
                    <div title="Новые подписки сегодня"><i class="fa-solid fa-star text-yellow-400"></i> {{ main_gauge.status_bar.new_subs_today }}</div>
                    <div title="Ошибки оплат сегодня"><i class="fa-solid fa-triangle-exclamation text-red-400"></i> {{ main_gauge.status_bar.failed_payments_today }}</div>
                </div>
                <div class="flex items-center gap-4">
                    <div title="Вызовы API сегодня"><i class="fa-solid fa-bolt"></i> {{ main_gauge.status_bar.api_calls_today }}</div>
                    <div title="Среднее время ответа API"><i class="fa-solid fa-clock"></i> {{ main_gauge.status_bar.avg_response_time|floatformat:0 }} ms</div>
                </div>
            </div>

            <!-- Основной дисплей -->
            <div class="flex flex-col md:flex-row justify-around items-center gap-6 py-4">
                
                <!-- Левый тахометр: DAU -->
                <div class="text-center w-48">
                    <p class="text-5xl font-bold text-glow">{{ main_gauge.dau }}</p>
                    <p class="text-sm text-[var(--color-text-secondary)] tracking-widest">АКТИВНЫХ ПОЛЬЗОВАТЕЛЕЙ</p>
                </div>

                <!-- Центральный спидометр: Тестов создано -->
                <div class="reactor-container p-4 m-4" id="reactor-container">
                    <svg viewBox="0 0 100 55" class="reactor-svg">
                        <path d="M 5 50 A 45 45 0 0 1 95 50" class="reactor-arc reactor-gauge__track" />
                        <path d="M 5 50 A 45 45 0 0 1 95 50" class="reactor-arc reactor-gauge__trail" id="trail-arc"/>
                        <path d="M 5 50 A 45 45 0 0 1 95 50" class="reactor-arc reactor-gauge__spark" id="spark-arc"/>
                        <path d="M 5 50 A 45 45 0 0 1 95 50" class="reactor-arc reactor-gauge__fill" id="fill-arc"/>
                        <defs>
                            <linearGradient id="reactor-gradient" x1="0%" y1="0%" x2="100%" y2="0%">
                                <stop offset="0%" style="stop-color: #616DF0;" />
                                <stop offset="100%" style="stop-color: #79EF66;" />
                            </linearGradient>
                            <linearGradient id="spark-gradient" x1="0%" y1="0%" x2="100%" y2="0%">
                                <stop offset="0%" stop-color="white" />
                                <stop offset="100%" stop-color="#79EF66" />
                            </linearGradient>
                        </defs>
                    </svg>

                    <div class="reactor-text-container" id="reactor-text">
                        <p class="text-6xl font-bold text-glow" id="tests-today-counter">0</p>
                        <p class="text-sm text-[var(--color-text-secondary)] tracking-widest -mt-1">ТЕСТОВ СЕГОДНЯ</p>
                    </div>
                </div>

                <!-- Контекст под спидометром -->
                <div class="mt-2 text-center text-xs text-gray-500 font-mono">
                    Вчера: {{ main_gauge.tests_yesterday }} | Макс: {{ main_gauge.record_7_days }}
                </div>

                <!-- Правый навигатор: Доход -->
                <div class="text-center w-48">
                    <p class="text-5xl font-bold text-glow">{{ main_gauge.revenue_today|floatformat:2 }}<span class="text-3xl text-green-400">&nbsp;₽</span></p>
                    <p class="text-sm text-[var(--color-text-secondary)] tracking-widest">ЗАРАБОТАНО СЕГОДНЯ</p>
                </div>
            </div>

            <!-- Одометр -->
            <div class="text-center text-lg text-[var(--color-text-secondary)] border-t border-[var(--color-border)] pt-3 mt-3">
                <span class="font-mono tracking-widest">{{ main_gauge.total_tests_created }}</span>
                <span class="text-xs ml-1">ВСЕГО СОЗДАНО</span>
            </div>
        </section>

        <!-- КЛЮЧЕВЫЕ ПОКАЗАТЕЛИ -->
        <section>
            <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">

                <div class="bg-[var(--color-surface)] p-6 rounded-2xl border border-[var(--color-border)] space-y-4">
                    <h2 class="font-bold text-white text-lg border-b border-b-[var(--color-border)] pb-2">Показатели</h2>
                    
                    <div class="text-center">
                        <p class="text-xs text-[var(--color-text-secondary)]">Всего юзеров</p>
                        <p class="text-4xl font-bold gradient-text">{{ cockpit.total_real_users }}</p>
                    </div>

                    <div class="grid grid-cols-2 gap-4 text-center">
                        <div>
                            <p class="text-xs text-[var(--color-text-secondary)]">Новых сегодня</p>
                            <p class="text-2xl font-semibold">{{ cockpit.new_users_today }}</p>
                        </div>
                        <div>
                            <p class="text-xs text-[var(--color-text-secondary)]">Новых за месяц</p>
                            <p class="text-2xl font-semibold">{{ cockpit.new_users_month }}</p>
                        </div>
                    </div>

                    <div class="grid grid-cols-3 gap-2 text-center pt-2 border-t border-t-[var(--color-border)]">
                        <div><p class="font-bold text-lg">{{ cockpit.dau }}</p><p class="text-[10px] text-[var(--color-text-secondary)]">DAU</p></div>
                        <div><p class="font-bold text-lg">{{ cockpit.wau }}</p><p class="text-[10px] text-[var(--color-text-secondary)]">WAU</p></div>
                        <div><p class="font-bold text-lg">{{ cockpit.mau }}</p><p class="text-[10px] text-[var(--color-text-secondary)]">MAU</p></div>
                    </div>

                    <div>
                        <p class="text-xs text-[var(--color-text-secondary)]">Липкость (DAU/MAU)</p>
                        <div class="w-full bg-black/20 rounded-full h-2.5 mt-1"><div class="bg-[var(--color-accent-primary)] h-2.5 rounded-full" style="width: {{ cockpit.stickiness }}%"></div></div>
                    </div>
                    <div>
                        <p class="text-xs text-[var(--color-text-secondary)]">Липкость (WAU/MAU)</p>
                        <div class="w-full bg-black/20 rounded-full h-2.5 mt-1"><div class="bg-[var(--color-accent-primary)] h-2.5 rounded-full" style="width: {{ cockpit.stickiness_wau }}%"></div></div>
                    </div>
                    <div>
                        <p class="text-xs text-[var(--color-text-secondary)]">Активация в 1-й тест (за 30д)</p>
                        <div class="w-full bg-black/20 rounded-full h-2.5 mt-1"><div class="bg-[var(--color-accent-primary)] h-2.5 rounded-full" style="width: {{ cockpit.activation_rate_30d }}%"></div></div>
                    </div>
                </div>

                <div class="bg-[var(--color-surface)] p-6 rounded-2xl border border-[var(--color-border)] space-y-4">
                    <h2 class="font-bold text-white text-lg border-b border-b-[var(--color-border)] pb-2">Тесты</h2>
                    
                    <div class="grid grid-cols-2 gap-4 text-center">
                        <div>
                            <p class="text-xs text-[var(--color-text-secondary)]">Тестов создано сегодня</p>
                            <p class="text-3xl font-bold">{{ cockpit.tests_created_today }}</p>
                            <p class="text-xs {% if cockpit.tests_vs_yesterday >= 0 %}text-green-400{% else %}text-red-400{% endif %}">
                                {% if cockpit.tests_vs_yesterday >= 0 %}+{% endif %}{{ cockpit.tests_vs_yesterday }} к вчера
                            </p>
                        </div>
                        <div>
                            <p class="text-xs text-[var(--color-text-secondary)]">Попыток прохождения</p>
                            <p class="text-3xl font-bold">{{ cockpit.attempts_today }}</p>
                            <p class="text-xs {% if cockpit.attempts_vs_yesterday >= 0 %}text-green-400{% else %}text-red-400{% endif %}">
                                {% if cockpit.attempts_vs_yesterday >= 0 %}+{% endif %}{{ cockpit.attempts_vs_yesterday }} к вчера
                            </p>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4 text-center pt-2 border-t border-t-[var(--color-border)]">
                        <div>
                            <p class="text-xs text-[var(--color-text-secondary)]">Всего тестов</p>
                            <p class="text-xl font-semibold">{{ cockpit.tests_created_total }}</p>
                        </div>
                        <div>
                            <p class="text-xs text-[var(--color-text-secondary)]">Всего попыток</p>
                            <p class="text-xl font-semibold">{{ cockpit.attempts_total }}</p>
                        </div>
                    </div>
                    
                    <div class="text-center">
                        <p class="text-xs text-[var(--color-text-secondary)]">Средний балл за 30 дней</p>
                        <p class="text-2xl font-bold text-[var(--color-accent-secondary)]">{{ cockpit.avg_score_30d|floatformat:1 }}%</p>
                    </div>
                </div>
                
                <div class="bg-[var(--color-surface)] p-6 rounded-2xl border border-[var(--color-border)] space-y-4">
                    <h2 class="font-bold text-white text-lg border-b border-b-[var(--color-border)] pb-2">Экономика</h2>
                    
                    <div class="text-center">
                        <p class="text-xs text-[var(--color-text-secondary)]">Доход сегодня</p>
                        <p class="text-4xl font-bold text-[var(--color-accent-secondary)]">{{ cockpit.revenue_today|floatformat:2 }} ₽</p>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4 text-center">
                        <div>
                            <p class="text-xs text-[var(--color-text-secondary)]">Доход за месяц</p>
                            <p class="text-xl font-semibold">{{ cockpit.revenue_month|floatformat:2 }} ₽</p>
                        </div>
                        <div>
                            <p class="text-xs text-[var(--color-text-secondary)]">Новых подписок сегодня</p>
                            <p class="text-xl font-semibold">{{ cockpit.new_subs_today }}</p>
                        </div>
                        <div>
                            <p class="text-xs text-[var(--color-text-secondary)]">Активных подписок</p>
                            <p class="text-xl font-semibold">{{ cockpit.active_subs_total }}</p>
                        </div>
                        <div>
                            <p class="text-xs text-[var(--color-text-secondary)]">Средний чек</p>
                            <p class="text-xl font-semibold">{{ cockpit.avg_check_total|floatformat:2 }} ₽</p>
                        </div>
                    </div>
                    
                    <div class="text-center pt-2 border-t border-t-[var(--color-border)]">
                        <p class="text-xs text-[var(--color-text-secondary)]">Конверсия в оплату (общая)</p>
                        <p class="text-2xl font-bold">{{ cockpit.conversion_to_paid_total }}%</p>
                    </div>
                </div>

                <div class="bg-[var(--color-surface)] p-6 rounded-2xl border border-[var(--color-border)] space-y-4">
                    <h2 class="font-bold text-white text-lg border-b border-b-[var(--color-border)] pb-2">Поставщики</h2>

                    <div class="text-center">
                        <p class="text-xs text-[var(--color-text-secondary)]">Вызовов API сегодня</p>
                        <p class="text-4xl font-bold">{{ cockpit.api_calls_today }}</p>
                        <p class="text-xs {% if cockpit.api_calls_vs_yesterday >= 0 %}text-green-400{% else %}text-red-400{% endif %}">
                            {% if cockpit.api_calls_vs_yesterday >= 0 %}+{% endif %}{{ cockpit.api_calls_vs_yesterday }} к вчера
                        </p>
                    </div>

                    <div>
                        <p class="text-xs text-[var(--color-text-secondary)]">Загрузка активного SURVEY ключа ({{ cockpit.active_key_name }})</p>
                        <div class="w-full bg-black/20 rounded-full h-4 mt-1 flex items-center justify-center relative">
                            <div class="{{ cockpit.active_key_load_color }} h-4 rounded-full transition-all duration-500" style="width: {{ cockpit.active_key_load }}%"></div>
                            <span class="absolute text-xs font-bold text-white mix-blend-difference">{{ cockpit.active_key_load }}%</span>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4 text-center pt-2 border-t border-t-[var(--color-border)]">
                        <div>
                            <p class="text-xs text-[var(--color-text-secondary)]">Успешность API</p>
                            <p class="text-xl font-semibold text-green-400">{{ cockpit.api_success_rate_today }}%</p>
                        </div>
                        <div>
                            <p class="text-xs text-[var(--color-text-secondary)]">Ср. ответ API</p>
                            <p class="text-xl font-semibold">{{ cockpit.avg_response_time_today|floatformat:0 }} ms</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- ВАЖНЫЕ ДАТЧИКИ -->
        <section class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-3 gap-6 mb-8">
            <!-- 1. ВОРОНКА АКТИВАЦИИ -->
            <div class="md:col-span-1 p-6 rounded-2xl border border-[var(--color-border)] bg-[#110c1f] space-y-4">
                <h3 class="font-bold text-white">Воронка Активации сегодня</h3>
                <div class="relative pt-8">
                    <!-- Линия воронки -->
                    <div class="absolute top-8 left-5 w-px h-full bg-[var(--color-border)]"></div>
                    <!-- Шаг 1: Всего касаний -->
                    <div class="relative flex items-start gap-4 mb-4">
                        <div class="z-10 w-10 h-10 flex-shrink-0 flex items-center justify-center rounded-full bg-purple-500/20 text-purple-400 border-2 border-purple-500"><i class="fas fa-users"></i></div>
                        <div>
                            <p class="font-bold text-white text-lg">{{ cyber_gauges.activation_funnel.total_touches }} - Всего взаимодействий</p>
                            <p class="text-xs text-gray-400">Нелегалы ({{ cyber_gauges.activation_funnel.illegals }}) + Регистрации ({{ cyber_gauges.activation_funnel.registrations }})</p>
                        </div>
                    </div>
                    <!-- Шаг 2: Регистрации -->
                    <div class="relative flex items-start gap-4 mb-4">
                        <div class="z-10 w-10 h-10 flex-shrink-0 flex items-center justify-center rounded-full bg-blue-500/20 text-blue-400 border-2 border-blue-500"><i class="fas fa-user-plus"></i></div>
                        <div>
                            <p class="font-bold text-white text-lg">{{ cyber_gauges.activation_funnel.registrations }} - Регистраций</p>
                            <p class="text-xs text-gray-400">Создали аккаунт</p>
                        </div>
                    </div>
                    <!-- Шаг 3: Активация после реги -->
                    <div class="relative flex items-start gap-4">
                        <div class="z-10 w-10 h-10 flex-shrink-0 flex items-center justify-center rounded-full bg-green-500/20 text-green-400 border-2 border-green-500"><i class="fas fa-magic"></i></div>
                        <div>
                            <p class="font-bold text-white text-lg">{{ cyber_gauges.activation_funnel.activated_after_reg }} - Активировались</p>
                            <p class="text-xs text-gray-400">Создали тест после регистрации</p>
                        </div>
                        <div class="ml-auto text-right">
                            <p class="font-bold text-green-400 text-2xl">{{ cyber_gauges.activation_funnel.conversion_reg_to_activation }}%</p>
                            <p class="text-xs text-gray-500">Конверсия</p>
                        </div>
                    </div>
                </div>
            </div>

            <section class="bg-[var(--color-surface)] md:col-span-2 p-6 rounded-2xl border border-[var(--color-border)]">
                <h3 class="font-bold text-white mb-4">Лента Активности (тесты за сегодня)</h3>
                <div class="space-y-3">
                    {% if live_feed_data %}
                        {% for item in live_feed_data %}
                            <a href="{% url 'preview_test' item.survey_id %}" target="_blank" 
                            class="block p-3 bg-black/20 rounded-lg hover:bg-black/40 transition-colors">
                                <div class="grid grid-cols-12 gap-4 items-center">
                                    <!-- Время -->
                                    <div class="col-span-2 sm:col-span-1 text-sm font-mono text-gray-400">
                                        {{ item.time }}
                                    </div>
                                    <!-- Название -->
                                    <div class="col-span-10 sm:col-span-8">
                                        <p class="font-semibold text-white truncate">{{ item.title }}</p>
                                    </div>
                                    <!-- Статистика -->
                                    <div class="col-span-12 sm:col-span-3 mt-2 sm:mt-0 flex justify-start sm:justify-end items-center gap-6 text-sm">
                                        <div class="flex items-center gap-2 text-gray-400" title="Просмотры">
                                            <i class="fas fa-eye"></i>
                                            <span class="font-bold text-white">{{ item.views }}</span>
                                        </div>
                                        <div class="flex items-center gap-2 text-gray-400" title="Прохождения">
                                            <i class="fas fa-tasks"></i>
                                            <span class="font-bold text-white">{{ item.attempts }}</span>
                                        </div>
                                    </div>
                                </div>
                            </a>
                        {% endfor %}
                    {% else %}
                        <p class="text-center text-gray-500 py-8">Сегодня еще не было создано ни одного теста.</p>
                    {% endif %}
                </div>
            </section>

            <!-- 1. НОВАЯ ВИЗУАЛЬНАЯ ВОРЕНКА АКТИВАЦИИ -->
            <div class="md:col-span-2 p-6 rounded-2xl border border-[var(--color-border)] bg-[#110c1f]">
                <h3 class="font-bold text-white mb-4">Воронка Прихода сегодня</h3>
                <div class="h-64 sm:h-80"><canvas id="activation-funnel-chart"></canvas></div>
            </div>

            <!-- 2. НОВЫЙ ВИДЖЕТ "МОНЕТИЗАЦИЯ" -->
            <div class="p-6 rounded-2xl border border-[var(--color-border)] bg-[#110c1f] flex flex-col justify-between">
                <h3 class="font-bold text-white">Монетизация (сегодня)</h3>
                <div class="text-center my-4">
                    <p class="text-6xl font-black text-white text-glow">{{ cyber_gauges.monetization.revenue|floatformat:2 }} <span class="text-4xl text-green-400 opacity-80">₽</span></p>
                </div>
                <div class="space-y-4">
                    <div>
                        <p class="text-sm text-gray-400">Новых платящих клиентов</p>
                        <p class="text-2xl font-bold text-white">{{ cyber_gauges.monetization.buyers }}</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-400">Конверсия в покупку</p>
                        <p class="text-2xl font-bold text-white">{{ cyber_gauges.monetization.conversion_activation_to_payment }}%</p>
                    </div>
                </div>
            </div>

            <!-- 3. Пульс Активности -->
            <div class="p-6 rounded-2xl border border-[var(--color-border)] bg-[#110c1f] flex flex-col justify-between">
                <div>
                    <span class="text-sm font-semibold text-gray-400">Пульс Активности (тесты)</span>
                    <span class="ml-2 text-sm font-bold {% if cyber_gauges.tests_pulse.change >= 0 %}text-green-400{% else %}text-red-400{% endif %}">
                        {% if cyber_gauges.tests_pulse.change >= 0 %}+{% endif %}{{ cyber_gauges.tests_pulse.change }}% vs вчера
                    </span>
                </div>
                <div class="my-4">
                    <p class="text-5xl font-black text-white text-glow">{{ cyber_gauges.tests_pulse.today }}</p>
                    <p class="text-xs text-gray-500 -mt-1">Создано сегодня</p>
                </div>
                <div class="h-12"><canvas id="tests-pulse-sparkline"></canvas></div>
            </div>

            <!-- 3. НОВЫЙ ВИДЖЕТ "НЕДЕЛЬНЫЙ ПУЛЬС" -->
            <div class="p-6 md:col-span-2 rounded-2xl border border-[var(--color-border)] bg-[#110c1f]">
                <h3 class="font-bold text-white mb-4">Недельный Пульс</h3>
                <div class="grid grid-cols-2 sm:grid-cols-2 gap-4 items-center">
                    <!-- Левая часть: Цифры -->
                    <div class="space-y-4">
                        <!-- Новые пользователи -->
                        <div>
                            <p class="text-3xl font-bold text-white">{{ weekly_pulse_data.current.new_users }}</p>
                            <p class="text-xs text-gray-400">Новых пользователей</p>
                            <span class="text-xs font-semibold {{ weekly_pulse_data.changes.new_users.color }}">
                                {{ weekly_pulse_data.changes.new_users.value }} vs прошлая неделя
                            </span>
                        </div>
                        <!-- Выручка -->
                        <div>
                            <p class="text-3xl font-bold text-white">{{ weekly_pulse_data.current.revenue|floatformat:0 }} <span class="text-xl text-gray-500">₽</span></p>
                            <p class="text-xs text-gray-400">Выручка</p>
                            <span class="text-xs font-semibold {{ weekly_pulse_data.changes.revenue.color }}">
                                {{ weekly_pulse_data.changes.revenue.value }} vs прошлая неделя
                            </span>
                        </div>
                        <!-- Создано тестов -->
                        <div>
                            <p class="text-3xl font-bold text-white">{{ weekly_pulse_data.current.surveys }}</p>
                            <p class="text-xs text-gray-400">Создано тестов</p>
                            <span class="text-xs font-semibold {{ weekly_pulse_data.changes.surveys.color }}">
                                {{ weekly_pulse_data.changes.surveys.value }} vs прошлая неделя
                            </span>
                        </div>
                    </div>

                    <!-- Правая часть: Диаграмма-радар -->
                    <div class="h-48 sm:h-full">
                        <canvas id="weekly-pulse-radar-chart"></canvas>
                    </div>
                </div>
            </div>

        </section>

        <section class="grid grid-cols-1 lg:grid-cols-4 gap-6">
            <div class="lg:col-span-3 bg-[var(--color-surface)] p-6 rounded-2xl border border-[var(--color-border)]">
                <h3 class="font-bold text-white mb-4">Ежедневная Воронка Активации (30 дней)</h3>
                <div class="h-96"><canvas id="daily-funnel-chart"></canvas></div>
            </div>
            <div class="bg-[var(--color-surface)] p-6 rounded-2xl border border-[var(--color-border)] flex flex-col justify-around text-center">
                <div>
                    <p class="text-4xl font-black text-white">{{ daily_funnel_summary.total_touches }}</p>
                    <p class="text-sm text-gray-400">Всего взаимодействий</p>
                </div>
                <div class="border-t border-[var(--color-border)] my-4"></div>
                <div>
                    <p class="text-4xl font-black text-white">{{ daily_funnel_summary.total_registrations }}</p>
                    <p class="text-sm text-gray-400">Регистраций</p>
                </div>
                <div class="border-t border-[var(--color-border)] my-4"></div>
                <div>
                    <p class="text-4xl font-black text-white">{{ daily_funnel_summary.total_activations }}</p>
                    <p class="text-sm text-gray-400">Активаций</p>
                </div>
                <div class="border-t border-[var(--color-border)] my-4"></div>
                <div>
                    <p class="text-4xl font-black text-green-400 text-glow">{{ daily_funnel_summary.total_conversion }}<span class="text-2xl">%</span></p>
                    <p class="text-sm text-gray-400">Итоговая конверсия</p>
                </div>
            </div>
        </section>

        <section class="space-y-8">
            <div class="grid grid-cols-1 gap-8">
                <div class="bg-[var(--color-surface)] p-6 rounded-2xl border border-[var(--color-border)]">
                    <h3 class="font-bold text-white mb-4">Динамика создания тестов</h3>
                    <div class="h-80">
                        <canvas id="dailyCreationChart"></canvas>
                    </div>
                </div>
            </div>
        </section>

        <section class.="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Колонка 1: Топ по просмотрам -->
            <div class="bg-[var(--color-surface)] p-6 rounded-2xl border border-[var(--color-border)]">
                <div class="flex items-center gap-3 mb-4">
                    <i class="fas fa-eye text-xl text-[var(--color-accent-primary)]"></i>
                    <h3 class="font-bold text-white">Топ по просмотрам (30 дней)</h3>
                </div>
                <div class="space-y-3">
                    {% if hall_of_fame_data.top_by_views %}
                        {% for item in hall_of_fame_data.top_by_views %}
                            <a href="{% url 'preview_test' item.survey_id %}" target="_blank"
                            class="block p-3 bg-black/20 rounded-lg hover:bg-black/40 transition-colors">
                                <div class="flex justify-between items-start gap-4">
                                    <div class="min-w-0">
                                        <p class="font-semibold text-white truncate">{{ item.title }}</p>
                                        <p class="text-xs text-gray-400 mt-1">
                                            Автор: {{ item.author }} &bull; {{ item.created_at }}
                                        </p>
                                    </div>
                                    <div class="flex-shrink-0 text-right">
                                        <p class="text-lg font-bold text-[var(--color-accent-primary)]">{{ item.metric_value }}</p>
                                        <p class="text-xs text-gray-500 -mt-1">просмотров</p>
                                    </div>
                                </div>
                            </a>
                        {% endfor %}
                    {% else %}
                        <p class="text-center text-gray-500 py-8">Нет данных.</p>
                    {% endif %}
                </div>
            </div>

            <!-- Колонка 2: Топ по прохождениям -->
            <div class="bg-[var(--color-surface)] p-6 rounded-2xl border border-[var(--color-border)] mt-6">
                <div class="flex items-center gap-3 mb-4">
                    <i class="fas fa-tasks text-xl text-[var(--color-accent-secondary)]"></i>
                    <h3 class="font-bold text-white">Топ по прохождениям (30 дней)</h3>
                </div>
                <div class="space-y-3">
                    {% if hall_of_fame_data.top_by_attempts %}
                        {% for item in hall_of_fame_data.top_by_attempts %}
                            <a href="{% url 'preview_test' item.survey_id %}" target="_blank"
                            class="block p-3 bg-black/20 rounded-lg hover:bg-black/40 transition-colors">
                                <div class="flex justify-between items-start gap-4">
                                    <div class="min-w-0">
                                        <p class="font-semibold text-white truncate">{{ item.title }}</p>
                                        <p class="text-xs text-gray-400 mt-1">
                                            Автор: {{ item.author }} &bull; {{ item.created_at }}
                                        </p>
                                    </div>
                                    <div class="flex-shrink-0 text-right">
                                        <p class="text-lg font-bold text-[var(--color-accent-secondary)]">{{ item.metric_value }}</p>
                                        <p class="text-xs text-gray-500 -mt-1">прохождений</p>
                                    </div>
                                </div>
                            </a>
                        {% endfor %}
                    {% else %}
                        <p class="text-center text-gray-500 py-8">Нет данных.</p>
                    {% endif %}
                </div>
            </div>
            
        </section>

        <section class="space-y-8">
            <h2 class="font-bold text-white text-xl">Аналитика публичных тестов (последние 7 дней)</h2>

            <div class="grid grid-cols-1 xl:grid-cols-2 gap-8">
                <!-- Пульс Активности -->
                <div class="bg-[var(--color-surface)] p-6 rounded-2xl border border-[var(--color-border)]">
                    <h3 class="font-bold text-white mb-4">Пульс Активности</h3>
                    <div class="h-80">
                        <canvas id="dailyAttemptsChart"></canvas>
                    </div>
                </div>

                <!-- Карта Эффективности Тестов -->
                <div class="bg-[var(--color-surface)] p-6 rounded-2xl border border-[var(--color-border)]">
                    <h3 class="font-bold text-white mb-4">Карта Эффективности Тестов (Топ-20)</h3>
                    <div class="h-80">
                        <canvas id="testPerformanceChart"></canvas>
                    </div>
                </div>

                 <div class="bg-[var(--color-surface)] p-6 rounded-2xl border border-[var(--color-border)]">
                    <h3 class="font-bold text-white mb-4">Спектр Успеваемости</h3>
                    <div class="h-80 flex justify-center items-center">
                        <canvas id="scoreDistributionChart" style="max-height: 300px;"></canvas>
                    </div>
                </div>

                <div class="bg-[var(--color-surface)] p-6 rounded-2xl border border-[var(--color-border)]">
                    <h3 class="font-bold text-white mb-4">Матрица Ценности Пользователей (Топ-100)</h3>
                    <div class="h-80 relative">
                        <canvas id="userValueMatrixChart"></canvas>
                        <div class="absolute top-2 right-2 text-xs text-yellow-400 font-bold">Звезды</div>
                        <div class="absolute bottom-2 right-2 text-xs text-green-400 font-bold">Крупные клиенты</div>
                        <div class="absolute top-2 left-2 text-xs text-blue-400 font-bold">Амбассадоры</div>
                        <div class="absolute bottom-2 left-2 text-xs text-gray-500 font-bold">Потенциал</div>
                    </div>
                </div>
            </div>
        </section>

        <section class="space-y-8">
            <h2 class="font-bold text-white text-xl">Анализ продукта и поведения пользователей</h2>

            <section class="grid grid-cols-1 xl:grid-cols-2 gap-8">
                {% if user_chart_data %}
                <div class="bg-[var(--color-surface)] p-6 rounded-2xl border border-[var(--color-border)]">
                    <h2 class="font-bold text-white mb-4">Динамика регистраций</h2>
                    <div class="h-64"><canvas id="userChart"></canvas></div>
                </div>
                {% endif %}
                
                <div class="bg-[var(--color-surface)] p-6 rounded-2xl border border-[var(--color-border)]">
                    <h2 class="font-bold text-white mb-4">Воронка активации пользователей (30 дней)</h2>
                    <div class="h-64">
                        <canvas id="userJourneyChart"></canvas>
                    </div>
                </div>

                <div class="bg-[var(--color-surface)] p-6 rounded-2xl border border-[var(--color-border)]">
                    <h3 class="font-bold text-white mb-4">Популярные темы тестов</h3>
                    <div class="h-80"><canvas id="topTopicsChart"></canvas></div>
                </div>

                <div class="bg-[var(--color-surface)] p-6 rounded-2xl border border-[var(--color-border)]">
                    <h3 class="font-bold text-white mb-4">Расход токенов</h3>
                    <div class="h-80">
                        <canvas id="dailyTokenUsageChart"></canvas>
                    </div>
                </div>
            </section>

            <section class="space-y-8">
                <h2 class="font-bold text-white text-xl">Бизнес-инсайты</h2>

                <section class="grid grid-cols-1 lg:grid-cols-4 gap-6">
                    <!-- Главный график -->
                    <div class="lg:col-span-2 bg-[var(--color-surface)] p-6 rounded-2xl border border-[var(--color-border)]">
                        <div class="flex justify-between items-baseline">
                            <h3 class="font-bold text-white">Поступления</h3>
                            <span class="text-2xl font-black text-white">{{ financial_pulse_data.total_revenue }} <span class="text-lg text-gray-400">₽</span></span>
                        </div>
                        <div class="h-64 mt-4"><canvas id="revenue-pulse-chart"></canvas></div>
                    </div>

                    <!-- Сателлит 1: Качество Покупок -->
                    <div class="satellite-widget">
                        <h3 class="title">Качество Покупок</h3>
                        <div class="grid grid-cols-2 gap-4 text-center items-center">
                            <!-- ARPU -->
                            <div>
                                <div class="progress-ring mx-auto">
                                    <svg class="w-full h-full"><circle class="text-black/20" stroke-width="8" stroke="currentColor" fill="transparent" r="46" cx="50" cy="50"/><circle class="text-[var(--color-accent-primary)]" stroke-width="8" stroke-linecap="round" stroke="currentColor" fill="transparent" r="46" cx="50" cy="50" style="stroke-dasharray: 289; stroke-dashoffset: calc(289 - (289 * {% widthratio financial_pulse_data.quality_metrics.avg_check 1000 100 %}) / 100);"/></svg>
                                    <div class="value-text">{{ financial_pulse_data.quality_metrics.avg_check }}<span class="text-lg">₽</span></div>
                                </div>
                                <p class="text-xs text-gray-400 mt-2">Средний чек (ARPU)</p>
                            </div>
                            <!-- LTV -->
                            <div>
                                <div class="progress-ring mx-auto">
                                    <svg class="w-full h-full"><circle class="text-black/20" stroke-width="8" stroke="currentColor" fill="transparent" r="46" cx="50" cy="50"/><circle class="text-green-400" stroke-width="8" stroke-linecap="round" stroke="currentColor" fill="transparent" r="46" cx="50" cy="50" style="stroke-dasharray: 289; stroke-dashoffset: calc(289 - (289 * {% widthratio financial_pulse_data.quality_metrics.ltv 2000 100 %}) / 100);"/></svg>
                                    <div class="value-text">{{ financial_pulse_data.quality_metrics.ltv }}<span class="text-lg">₽</span></div>
                                </div>
                                <p class="text-xs text-gray-400 mt-2">LTV (доход с клиента)</p>
                            </div>
                        </div>
                    </div>

                    <!-- Сателлит 2: Источники Роста (РЕДИЗАЙН) -->
                    <div class="satellite-widget">
                        <h3 class="title">Источники Роста</h3>
                        <div class="space-y-6">
                            <!-- Новые vs Повторные -->
                            <div>
                                {% with total_payments=financial_pulse_data.growth_metrics.new_payments|add:financial_pulse_data.growth_metrics.returning_payments %}
                                    <div class="stacked-bar">
                                        <div class="stacked-bar-segment bg-blue-500" style="width: {% widthratio financial_pulse_data.growth_metrics.new_payments total_payments 100 %}%" title="Новые: {{ financial_pulse_data.growth_metrics.new_payments }}"></div>
                                        <div class="stacked-bar-segment bg-green-500" style="width: {% widthratio financial_pulse_data.growth_metrics.returning_payments total_payments 100 %}%" title="Повторные: {{ financial_pulse_data.growth_metrics.returning_payments }}"></div>
                                    </div>
                                    <div class="flex justify-between text-xs mt-2">
                                        <span class="font-semibold text-blue-400">Новые: {{ financial_pulse_data.growth_metrics.new_payments }}</span>
                                        <span class="font-semibold text-green-400">Повторные: {{ financial_pulse_data.growth_metrics.returning_payments }}</span>
                                    </div>
                                {% endwith %}
                            </div>
                            <!-- Churn Rate -->
                            <div class="text-center">
                                <p class="text-5xl font-black text-red-400 text-glow">{{ financial_pulse_data.growth_metrics.churn_rate }}<span class="text-3xl">%</span></p>
                                <p class="widget-label mt-1">Уровень оттока (общий)</p>
                            </div>
                        </div>
                    </div>
                </section>

                <div class="grid grid-cols-1 xl:grid-cols-2 gap-8">
                    <div class="bg-[var(--color-surface)] p-6 rounded-2xl border border-[var(--color-border)]">
                        <h3 class="font-bold text-white mb-4">Время до Первой Покупки</h3>
                        <div class="h-80">
                            <canvas id="timeToPaymentChart"></canvas>
                        </div>
                    </div>

                    <!-- КАЧЕСТВО КОГОРТ -->
                    <div class="bg-[var(--color-surface)] p-6 rounded-2xl border border-[var(--color-border)]">
                        <h3 class="font-bold text-white mb-4">Качество Когорт</h3>
                        <div class="space-y-4">

                            <!-- Метрика 1: Конверсия -->
                            <div class="cohort-metric flex items-center gap-4">
                                <div class="metric-ring flex-shrink-0">
                                    <svg class="w-full h-full">
                                        <!-- Трек-фон -->
                                        <circle class="text-black/20" stroke-width="6" stroke="currentColor" fill="transparent" r="28" cx="32" cy="32"/>
                                        <!-- Прогресс предыдущего месяца (полупрозрачный) -->
                                        <circle class="text-[var(--color-accent-primary)] opacity-30" stroke-width="6" stroke-linecap="round" stroke="currentColor" fill="transparent" r="28" cx="32" cy="32" style="stroke-dasharray: 176; stroke-dashoffset: calc(176 - (176 * {{ cohort_quality_data.previous_month.metrics.conversion_rate }}) / 10);"/>
                                        <!-- Прогресс текущего месяца -->
                                        <circle class="text-[var(--color-accent-primary)]" stroke-width="6" stroke-linecap="round" stroke="currentColor" fill="transparent" r="28" cx="32" cy="32" style="stroke-dasharray: 176; stroke-dashoffset: calc(176 - (176 * {{ cohort_quality_data.current_month.metrics.conversion_rate }}) / 10);"/>
                                    </svg>
                                    <div class="value-text">{{ cohort_quality_data.current_month.metrics.conversion_rate }}<span class="unit">%</span></div>
                                </div>
                                <div>
                                    <p class="font-semibold text-white">Конверсия в 1-ю покупку</p>
                                    {% with change=cohort_quality_data.changes.conversion_rate %}
                                    <p class="text-xs {% if change >= 0 %}text-green-400{% else %}text-red-400{% endif %}">
                                        {% if change >= 0 %}+{% endif %}{{ change|floatformat:2 }}% vs {{ cohort_quality_data.previous_month.name }}
                                    </p>
                                    {% endwith %}
                                </div>
                            </div>

                            <!-- Метрика 2: ARPU -->
                            <div class="cohort-metric flex items-center gap-4">
                                <div class="metric-ring flex-shrink-0">
                                    <svg class="w-full h-full">
                                        <circle class="text-black/20" stroke-width="6" stroke="currentColor" fill="transparent" r="28" cx="32" cy="32"/>
                                        <circle class="text-green-400 opacity-30" stroke-width="6" stroke-linecap="round" stroke="currentColor" fill="transparent" r="28" cx="32" cy="32" style="stroke-dasharray: 176; stroke-dashoffset: calc(176 - (176 * {% widthratio cohort_quality_data.previous_month.metrics.arppu 1000 100 %}) / 100);"/>
                                        <circle class="text-green-400" stroke-width="6" stroke-linecap="round" stroke="currentColor" fill="transparent" r="28" cx="32" cy="32" style="stroke-dasharray: 176; stroke-dashoffset: calc(176 - (176 * {% widthratio cohort_quality_data.current_month.metrics.arppu 1000 100 %}) / 100);"/>
                                    </svg>
                                    <div class="value-text">{{ cohort_quality_data.current_month.metrics.arppu }}<span class="unit">₽</span></div>
                                </div>
                                <div>
                                    <p class="font-semibold text-white">ARPU (ср. доход)</p>
                                    {% with change=cohort_quality_data.changes.arppu %}
                                    <p class="text-xs {% if change >= 0 %}text-green-400{% else %}text-red-400{% endif %}">
                                        {% if change >= 0 %}+{% endif %}{{ change|floatformat:0 }} ₽ vs {{ cohort_quality_data.previous_month.name }}
                                    </p>
                                    {% endwith %}
                                </div>
                            </div>
                            
                            <!-- Метрика 3: Активация -->
                            <div class="cohort-metric">
                                <div class="flex justify-between items-baseline mb-1">
                                    <p class="text-sm font-semibold text-white">Ср. тестов на юзера</p>
                                    <p class="text-lg font-bold text-white">{{ cohort_quality_data.current_month.metrics.avg_tests }}</p>
                                </div>
                                <div class="w-full bg-black/30 rounded-full h-2 relative">
                                    <!-- Прогресс предыдущего месяца (фон) -->
                                    <div class="absolute top-0 left-0 h-2 bg-gray-600 rounded-full" style="width: {% widthratio cohort_quality_data.previous_month.metrics.avg_tests 5 100 %}%"></div>
                                    <!-- Прогресс текущего месяца -->
                                    <div class="absolute top-0 left-0 h-2 bg-[var(--color-accent-secondary)] rounded-full" style="width: {% widthratio cohort_quality_data.current_month.metrics.avg_tests 5 100 %}%"></div>
                                </div>
                                {% with change=cohort_quality_data.changes.avg_tests %}
                                <p class="text-xs text-right mt-1 {% if change >= 0 %}text-green-400{% else %}text-red-400{% endif %}">
                                    {% if change >= 0 %}+{% endif %}{{ change|floatformat:1 }} vs {{ cohort_quality_data.previous_month.name }}
                                </p>
                                {% endwith %}
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <section class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- ТЕМПЕРАТУРНАЯ КАРТА -->
                <div class="lg:col-span-2 bg-[var(--color-surface)] p-6 rounded-2xl border border-[var(--color-border)]">
                    <h3 class="font-bold text-white mb-4">Температурная Карта Активности (Создание тестов, 4 нед.)</h3>
                    <div class="h-64"><canvas id="activity-heatmap"></canvas></div>
                </div>
                <!-- ДЕТЕКТОР АНОМАЛИЙ -->
                <div class="bg-[var(--color-surface)] p-6 rounded-2xl border border-[var(--color-border)] flex flex-col justify-between">
                    <div>
                        <div class="flex items-center gap-3">
                            <i class="fas fa-shield-virus text-2xl text-red-400"></i>
                            <h3 class="font-bold text-white">Детектор Аномалий</h3>
                        </div>
                    </div>
                    <div class="space-y-6 mt-4">
                        <div>
                            <p class="text-xs text-gray-400">Индекс Наглости</p>
                            <p class="text-4xl font-black text-white">{{ anomaly_detector_data.audacity_index }}</p>
                        </div>
                        <div>
                            <p class="text-xs text-gray-400">Доля бесплатных тестов сегодня</p>
                            <div class="w-full bg-black/20 rounded-full h-6 mt-1 flex items-center pr-2 relative">
                                <div class="bg-gradient-to-r from-red-500 to-yellow-500 h-6 rounded-full" style="width: {{ anomaly_detector_data.free_tests_percentage }}%"></div>
                                <span class="absolute right-3 text-sm font-bold text-white mix-blend-difference">{{ anomaly_detector_data.free_tests_percentage }}%</span>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <section id="growth-engine" class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- 1. ПРИВЛЕЧЕНИЕ -->
                <div class="growth-card p-6 rounded-2xl border border-[var(--color-border)] bg-gradient-to-br from-[rgba(30,24,48,0.5)] to-[rgba(30,24,48,0.2)]">
                    <div class="flex justify-between items-center">
                        <span class="text-sm font-semibold text-gray-400">Привлечение</span>
                        <span id="acq-change" class="text-sm font-bold {% if growth_engine_data.acquisition.change >= 0 %}text-green-400{% else %}text-red-400{% endif %}">
                            {% if growth_engine_data.acquisition.change >= 0 %}+{% endif %}{{ growth_engine_data.acquisition.change }}
                        </span>
                    </div>
                    <p class="text-4xl font-black text-white my-2">{{ growth_engine_data.acquisition.value }}</p>
                    <p class="text-xs text-gray-500 -mt-2 mb-4">Новых пользователей (30 д.)</p>
                    <div class="h-16"><canvas id="acq-sparkline"></canvas></div>
                </div>
                <!-- 2. АКТИВАЦИЯ -->
                <div class="growth-card p-6 rounded-2xl border border-[var(--color-border)] bg-gradient-to-br from-[rgba(30,24,48,0.5)] to-[rgba(30,24,48,0.2)]">
                    <div class="flex justify-between items-center">
                        <span class="text-sm font-semibold text-gray-400">Активация</span>
                        <span id="act-change" class="text-sm font-bold {% if growth_engine_data.activation.change >= 0 %}text-green-400{% else %}text-red-400{% endif %}">
                            {% if growth_engine_data.activation.change >= 0 %}+{% endif %}{{ growth_engine_data.activation.change }}%
                        </span>
                    </div>
                    <p class="text-4xl font-black text-white my-2">{{ growth_engine_data.activation.value }}<span class="text-2xl text-gray-400">%</span></p>
                    <p class="text-xs text-gray-500 -mt-2 mb-4">Создали 1-й тест (30 д.)</p>
                    <div class="h-16 relative flex items-center justify-center">
                        <svg class="w-24 h-24 transform -rotate-90"><circle class="text-black/20" stroke-width="8" stroke="currentColor" fill="transparent" r="40" cx="48" cy="48"/><circle id="act-circle" class="text-[var(--color-accent-secondary)]" stroke-width="8" stroke-linecap="round" stroke="currentColor" fill="transparent" r="40" cx="48" cy="48" style="stroke-dasharray: 251.2; stroke-dashoffset: calc(251.2 - (251.2 * {{ growth_engine_data.activation.value }}) / 100); transition: stroke-dashoffset 1s ease-out;"/></svg>
                        <span class="absolute text-xl font-bold">{{ growth_engine_data.activation.value }}%</span>
                    </div>
                </div>
                <!-- 3. УДЕРЖАНИЕ -->
                <div class="growth-card p-6 rounded-2xl border border-[var(--color-border)] bg-gradient-to-br from-[rgba(30,24,48,0.5)] to-[rgba(30,24,48,0.2)]">
                    <div class="flex justify-between items-center">
                        <span class="text-sm font-semibold text-gray-400">Удержание</span>
                    </div>
                    <p class="text-4xl font-black text-white my-2">{{ growth_engine_data.retention.value }}<span class="text-2xl text-gray-400">%</span></p>
                    <p class="text-xs text-gray-500 -mt-2 mb-4">Повторных покупок (30 д.)</p>
                    <div class="h-16">
                    </div>
                </div>

            </section>

            <section class="grid grid-cols-1 xl:grid-cols-3 gap-8">
                <!-- Календарь -->
                <div class="xl:col-span-2 bg-[var(--color-surface)] p-6 rounded-2xl border border-[var(--color-border)]">
                    <h3 class="font-bold text-white mb-4">Радар оттока: Календарь подписок</h3>
                    <div id="churn-calendar"></div>
                </div>
                
                <!-- Список -->
                <div class="xl:col-span-1 bg-[var(--color-surface)] p-6 rounded-2xl border border-[var(--color-border)]">
                    <h3 class="font-bold text-white mb-4">Ближайшие истечения</h3>
                    <div class="space-y-3">
                        {% if churn_radar_data.list %}
                            {% for user in churn_radar_data.list %}
                            <div class="p-3 bg-black/20 rounded-lg">
                                <div class="flex justify-between items-center">
                                    <p class="font-bold text-white truncate pr-2">{{ user.username }}</p>
                                    {% if user.urgency == 'expired' %}
                                        <span class="text-xs font-bold text-red-400">Истекла</span>
                                    {% elif user.urgency == 'today' %}
                                        <span class="text-xs font-bold text-yellow-400">Сегодня</span>
                                    {% endif %}
                                </div>
                                <div class="flex justify-between items-center text-xs text-gray-400 mt-1">
                                    <span>{{ user.plan_name }}</span>
                                    <span class="font-mono">{{ user.end_date_str }}</span>
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <p class="text-gray-500 text-sm text-center py-8">В ближайшее время нет истекающих подписок.</p>
                        {% endif %}
                    </div>
                </div>
            </section>

            <!-- Когортный анализ -->
            {% if retention_data %}
            <div class="bg-[var(--color-surface)] p-6 rounded-2xl border border-[var(--color-border)]">
                <h3 class="font-bold text-white mb-4">Когорта удержания пользователей</h3>
                <div class="overflow-x-auto">
                    <table class="w-full text-xs text-left">
                        <thead class="text-[var(--color-text-secondary)]">
                            <tr>
                                <th class="p-2 bg-[#111827]/50 rounded-tl-lg">Когорта</th>
                                <th class="p-2 bg-[#111827]/50">Юзеров</th>
                                {% for header in retention_data.headers %}
                                    <th class="p-2 bg-[#111827]/50 text-center {% if forloop.last %}rounded-tr-lg{% endif %}">{{ header }}</th>
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for cohort in retention_data.cohorts %}
                            <tr class="border-b border-[var(--color-border)]">
                                <td class="p-2 font-semibold">{{ cohort.cohort_name }}</td>
                                <td class="p-2">{{ cohort.size }}</td>
                                {% for cell in cohort.values %}
                                    {% if forloop.counter0 < retention_data.headers|length %}
                                    <td class="p-0 text-center">
                                        {% if cell.percentage is not None %}
                                        <div class="m-1 p-2 rounded-xl" style="background-color: rgba(16, 185, 129, {{ cell.percentage }});">
                                            {{ cell.percentage }}%
                                            <div class="text-[10px] opacity-70">{{ cell.users }}</div>
                                        </div>
                                        {% endif %}
                                    </td>
                                    {% endif %}
                                {% endfor %}
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% endif %}

            <!-- Чарты с распределением юзеров -->
            <div class="grid grid-cols-1 xl:grid-cols-2 gap-8">
                <div class="bg-[var(--color-surface)] p-6 rounded-2xl border border-[var(--color-border)]">
                    <h3 class="font-bold text-white mb-4">Распределение активности пользователей</h3>
                    <div class="h-64"><canvas id="userActivityChart"></canvas></div>
                </div>
                <div class="bg-[var(--color-surface)] p-6 rounded-2xl border border-[var(--color-border)]">
                    <h3 class="font-bold text-white mb-4">Использование продукта по тарифам</h3>
                    <div class="h-64"><canvas id="usageBySubChart"></canvas></div>
                </div>
            </div>
        </section>

        <!-- Чарты с экономикой вкратце -->
        <section id="financial-briefing" class="mb-8">
            <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
                <div class="bg-[var(--color-surface)] p-6 rounded-2xl border border-[var(--color-border)]">
                    <h3 class="text-sm font-semibold text-gray-400">Выручка за период</h3>
                    <p class="mt-2 text-4xl font-black text-white text-glow">
                        {{ financial_briefing.revenue|floatformat:0 }} <span class="text-2xl opacity-70">₽</span>
                    </p>
                </div>
                <div class="bg-[var(--color-surface)] p-6 rounded-2xl border border-[var(--color-border)]">
                    <h3 class="text-sm font-semibold text-gray-400">Текущий MRR за период</h3>
                    <p class="mt-2 text-4xl font-black text-white text-glow">
                        {{ financial_briefing.new_mrr|floatformat:0 }} <span class="text-2xl opacity-70">₽</span>
                    </p>
                </div>
                <div class="bg-[var(--color-surface)] p-6 rounded-2xl border border-[var(--color-border)]">
                    <h3 class="text-sm font-semibold text-gray-400">Средний Чек (ARPU)</h3>
                    <p class="mt-2 text-4xl font-black text-white text-glow">
                        {{ financial_briefing.arpu|floatformat:0 }} <span class="text-2xl opacity-70">₽</span>
                    </p>
                </div>

            </div>
        </section>

        <!-- Чарты с финансовым командным центром -->
        <section id="financial-command-center" class="space-y-8">
            <h2 class="font-bold text-white text-xl">Финансовый командный центр</h2>

            <div class="grid grid-cols-1 xl:grid-cols-2 gap-8">
                <div class="bg-[var(--color-surface)] p-6 rounded-2xl border border-[var(--color-border)]">
                    <h3 class="font-bold text-white mb-4">Денежный Поток (за период)</h3>
                    <div class="h-80"><canvas id="dailyRevenueChart"></canvas></div>
                </div>
                <div class="bg-[var(--color-surface)] p-6 rounded-2xl border border-[var(--color-border)]">
                    <h3 class="font-bold text-white mb-4">Динамика Среднего Чека (за период)</h3>
                    <div class="h-80"><canvas id="arpuDynamicsChart"></canvas></div>
                </div>
                <div class="bg-[var(--color-surface)] p-6 rounded-2xl border border-[var(--color-border)]">
                    <h3 class="font-bold text-white mb-4">Источник Дохода: Новые vs. Старые</h3>
                    <div class="h-80"><canvas id="revenueSourceChart"></canvas></div>
                </div>
                <div class="bg-[var(--color-surface)] p-6 rounded-2xl border border-[var(--color-border)]">
                    <h3 class="font-bold text-white mb-4">Жизненный Цикл Дохода по Когортам (LTV)</h3>
                    <div class="h-80"><canvas id="cohortRevenueChart"></canvas></div>
                </div>
            </div>
        </section>

        <div class="lg:col-span-2 bg-[var(--color-surface)] p-4 mb-4 rounded-xl border border-[var(--color-border)] h-80 flex flex-col">
            <div class="lg:col-span-1">
                <h3 class="font-bold text-white mb-4">Статус систем</h3>
                <div id="service-status-container" class="space-y-4">
                    <!-- Сюда JS будет вставлять статусы -->
                </div>
            </div>
            <div class="flex-shrink-0 flex items-center gap-2 mb-2 border-b border-gray-700/60 pb-2">
                <button data-log-target="app-log-content" class="log-tab active">app.log</button>
                <button data-log-target="gunicorn-log-content" class="log-tab">gunicorn.log</button>
                
                <span class="ml-auto text-xs text-gray-400 font-mono">/var/www/letychka.ru</span>
            </div>
            <div class="flex-grow relative overflow-hidden">
                <pre id="app-log-content" class="log-content active">
                    <!-- Сюда JS будет вставлять app.log -->
                </pre>
                <pre id="gunicorn-log-content" class="log-content">
                    <!-- Сюда JS будет вставлять gunicorn.log -->
                </pre>
            </div>
        </div>
        
        <!-- УПРАВЛЕНИЕ API -->
        <section class="bg-[var(--color-surface)] p-6 rounded-2xl border border-[var(--color-border)]">
            <h2 class="font-bold text-white mb-4 text-xl">Управление API ключами</h2>
            <section class="grid grid-cols-1 xl:grid-cols-2 gap-8">
                {% if api_chart_data %}
                <div class="bg-[var(--color-surface)] p-6 rounded-2xl border border-[var(--color-border)]">
                    <h2 class="font-bold text-white mb-4">Использование API по ключам</h2>
                    <div class="h-64"><canvas id="apiUsageChart"></canvas></div>
                </div>
                {% endif %}
                <div class="bg-[var(--color-surface)] p-6 rounded-2xl border border-[var(--color-border)]">
                    <h2 class="font-bold text-white mb-4">Общее использование API</h2>
                    <div class="h-64"><canvas id="totalApiUsageChart"></canvas></div>
                </div>
            </section>

            {% for purpose, keys in keys_by_purpose.items %}
                <h3 class="text-sm font-semibold text-gray-400 uppercase mt-4 mb-2">{{ purpose }}</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    {% for key in keys %}
                        <div class="p-4 rounded-lg border {% if key.is_active %}border-[var(--color-accent-secondary)] shadow-lg shadow-[var(--color-accent-secondary)]/20{% else %}border-[var(--color-border)]{% endif %}">
                            <div class="flex justify-between items-center"><span class="font-bold text-white">{{ key.name }}</span> <span class="text-xs px-2 py-1 bg-black/20 rounded-full">{{ key.provider }}</span></div>
                            <div class="text-xs text-gray-500 mt-1">До {{ key.expires_at|date:'d.m.Y'|default:"∞" }}</div>
                            <div class="w-full bg-black/20 rounded-full h-2.5 mt-2"><div class="progress-bar-fill bg-[var(--color-accent-secondary)] h-2.5 rounded-full" style="width: {{ key.usage_percent }}%"></div></div>
                            <div class="flex justify-between items-center mt-2">
                                <span class="text-xs text-gray-400">{{ key.today_usage_count }} / 50 сегодня</span>
                                {% if not key.is_active %}
                                    <form method="post" class="activate-key-form" data-action="{% url 'api_activate_key' %}">
                                        <input type="hidden" name="activate_api_key_id" value="{{ key.id }}">
                                        <input type="hidden" name="key_purpose" value="{{ key.purpose }}">
                                        <button type="submit" class="text-xs font-bold text-[var(--color-accent-primary)] hover:text-white">Активировать</button>
                                    </form>
                                {% endif %}
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% endfor %}
            
            <div class="mt-6 pt-6 border-t border-[var(--color-border)]">
                <h3 class="font-bold text-white mb-4">Добавить новый ключ</h3>
                <form method="post" action="{% url 'api_add_key' %}" class="space-y-4">
                    {% csrf_token %}
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <input type="text" name="new_api_key_name" class="p-2 bg-[var(--color-bg)] border border-[var(--color-border)] rounded-lg" placeholder="Название" required>
                        <input type="text" name="new_api_key_value" class="p-2 bg-[var(--color-bg)] border border-[var(--color-border)] rounded-lg" placeholder="Значение" required>
                        <select name="new_api_key_provider" class="p-2 bg-[var(--color-bg)] border border-[var(--color-border)] rounded-lg" required><option value="openrouter">OpenRouter</option><option value="azure">Azure</option></select>
                        <select name="new_api_key_purpose" class="p-2 bg-[var(--color-bg)] border border-[var(--color-border)] rounded-lg" required><option value="FEEDBACK">FEEDBACK</option><option value="SURVEY">SURVEY</option></select>
                    </div>
                    <div class="flex gap-4">
                        <input type="date" name="new_api_key_expires" class="flex-grow p-2 bg-[var(--color-bg)] border border-[var(--color-border)] rounded-lg">
                        <button type="submit" class="w-full md:w-auto flex-grow py-2 font-bold text-center rounded-lg bg-[var(--color-accent-primary)] text-white">Добавить ключ</button>
                    </div>
                </form>
            </div>

            <section class="gap-8 mt-6">
                <div class="bg-[var(--color-surface)] p-6 rounded-2xl border border-[var(--color-border)]">
                    <h2 class="font-bold text-white mb-4">Среднее время ответа API</h2>
                    <div class="h-64"><canvas id="apiPerformanceChart"></canvas></div>
                </div>
            </section>
            
        </section>

        <!-- ИСТОРИЯ ПЛАТЕЖЕЙ -->
         {% for item in payment_data %}
            <button class="js-payment-card w-full text-left bg-[var(--color-bg)] p-2 rounded-2xl border border-[var(--color-border)] 
                         transition-all duration-300"
                    data-name="{{ item.name }}"
                    data-plan-name="{{ item.plan_name }}"
                    data-amount="{{ item.amount }}"
                    data-date="{{ item.date|date:'d M Y, H:i' }}"
                    data-payment-type="{{ item.payment_type }}"
                    data-payment-status="{{ item.payment_status }}"
                    data-user-status="{{ item.user_status }}"
                    data-user-status-days="{{ item.user_status_days }}"
                    data-tests-created="{{ item.total_tests_created }}"
                    data-order-id="{{ item.order_id }}">
                
                <div class="flex flex-col sm:flex-row sm:items-center gap-4 pointer-events-none">
                    <div class="flex-shrink-0 w-full sm:w-28 text-center">
                        {% if item.payment_status == 'completed' %}
                            <p class="text-lg font-bold text-green-400"><i class="fas fa-plus-circle mr-2"></i>Успех</p>
                            <p class="text-xs font-semibold {% if item.payment_type == 'Первая' %}text-yellow-400{% else %}text-blue-400{% endif %}">
                                {{ item.payment_type }}
                            </p>
                        {% else %}
                            <p class="text-lg font-bold text-red-500"><i class="fas fa-exclamation-triangle mr-2"></i>Сбой</p>
                            <p class="text-xs text-gray-500">{{ item.payment_type }}</p>
                        {% endif %}
                    </div>

                    <!-- ОСНОВНАЯ ИНФА -->
                    <div class="flex-grow">
                        <div class="flex justify-between items-baseline">
                            <p class="font-bold text-white text-lg truncate pr-4">{{ item.name }}</p>
                            <p class="font-mono font-bold text-xl 
                                    {% if item.payment_status == 'completed' %}
                                        bg-gradient-to-r from-green-400 to-emerald-500 bg-clip-text text-transparent
                                    {% else %}text-red-500 line-through{% endif %}">
                                +{{ item.amount }}
                            </p>
                        </div>
                        <p class="text-xs text-gray-400 -mt-1">{{ item.plan_name }}</p>
                    </div>

                    <!-- ДАТА -->
                    <div class="flex-shrink-0 w-full sm:w-24 text-left sm:text-right">
                        <p class="text-sm font-medium text-white">{{ item.date|date:"d M" }}</p>
                        <p class="text-xs text-gray-500">{{ item.date|date:"H:i" }}</p>
                    </div>
                </div>
            </button>
        {% empty %}
            <p class="text-center text-gray-500 py-8">Пока нет данных о платежах.</p>
        {% endfor %}

        <!-- АДМИН-ДЕЙСТВИЯ -->
        <section class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="bg-[var(--color-surface)] p-6 rounded-2xl border border-[var(--color-border)]">
                <h2 class="font-bold text-white mb-4">Бан по IP</h2>
                <form method="post" class="ajax-form flex gap-2" data-action="{% url 'api_block_ip' %}">
                    <input type="text" name="ip_address" class="w-full p-2 bg-[var(--color-bg)] border border-[var(--color-border)] rounded-lg" placeholder="192.168.1.1">
                    <button type="submit" class="bg-red-800/80 hover:bg-red-700/80 px-4 rounded-lg font-bold">Ban</button>
                </form>
            </div>
            <div class="bg-[var(--color-surface)] p-6 rounded-2xl border border-[var(--color-border)]">
                 <h2 class="font-bold text-white mb-4">Дать права админа</h2>
                <form method="post" class="ajax-form flex gap-2" data-action="{% url 'api_promote_user' %}">
                    <input type="text" name="username" class="w-full p-2 bg-[var(--color-bg)] border border-[var(--color-border)] rounded-lg" placeholder="Имя пользователя">
                    <button type="submit" class="bg-green-800/80 hover:bg-green-700/80 px-4 rounded-lg font-bold">Promote</button>
                </form>
            </div>
        </section>

    </main>

    <div id="payment-details-modal" class="fixed inset-0 bg-black/80 z-50 hidden items-center justify-center p-4">
        <div id="payment-modal-content" class="bg-[var(--color-surface)] w-full max-w-lg p-8 rounded-3xl border border-[var(--color-border)] 
                                            transform scale-95 opacity-0 transition-all duration-300 backdrop-blur-xl">
            
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-white">Детали транзакции</h3>
                <button id="close-payment-modal-btn" class="text-gray-500 hover:text-white text-3xl">&times;</button>
            </div>
            
            <!-- Контент, который будет заполняться динамически -->
            <div id="modal-body-content" class="space-y-4">
                <!-- Сюда будет вставляться контент через JS -->
            </div>
        </div>
    </div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-matrix@2.0.1/dist/chartjs-chart-matrix.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>

    <script>
        $(document).ready(function() {
            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }

            const csrftoken = getCookie('csrftoken');

            // Универсальный обработчик для AJAX форм
            $('.ajax-form').on('submit', function(event) {
                event.preventDefault();
                const form = $(this);
                const submitBtn = form.find('button[type="submit"]');
                const originalBtnText = submitBtn.html();
                const actionUrl = form.data('action');

                $.ajax({
                    type: 'POST',
                    url: actionUrl,
                    headers: { 'X-CSRFToken': csrftoken },
                    data: form.serialize(),
                    beforeSend: () => submitBtn.prop('disabled', true).text('...'),
                    success: (response) => alert(response.message),
                    error: (xhr) => alert('Ошибка: ' + (xhr.responseJSON ? xhr.responseJSON.message : 'Сервер не отвечает')),
                    complete: () => {
                        submitBtn.prop('disabled', false).html(originalBtnText);
                        form.trigger('reset');
                    }
                });
            });

            // Обработчик для активации ключей
            $('.activate-key-form').on('submit', function(event) {
                event.preventDefault();
                const form = $(this);
                const actionUrl = form.data('action');
                $.ajax({
                    type: 'POST',
                    url: actionUrl,
                    headers: { 'X-CSRFToken': csrftoken },
                    data: form.serialize(),
                    beforeSend: () => form.find('button[type="submit"]').prop('disabled', true).text('...'),
                    success: (response) => {
                        if (response.status) {
                            window.location.reload();
                        } else {
                            alert('Ошибка: ' + response.message);
                        }
                    },
                    error: () => alert('Ошибка сети')
                });
            });

            // Модалка деталей платежа
            const paymentModal = $('#payment-details-modal');
            const paymentModalContent = $('#payment-modal-content');
            const closeModalPaymentBtn = $('#close-payment-modal-btn');
            const modalBody = $('#modal-body-content');

            const openPaymentModal = (data) => {
                const statusColor = data.paymentStatus === 'completed' ? 'text-green-400' : 'text-red-500';
                const typeColor = data.paymentType === 'Первая' ? 'text-yellow-400' : 'text-blue-400';

                const contentHTML = `
                    <div class="grid grid-cols-2 gap-x-6 gap-y-4">
                        <div class="col-span-2 sm:col-span-1">
                            <p class="text-sm text-gray-400">Пользователь</p>
                            <p class="text-lg font-bold text-white">${data.name}</p>
                        </div>
                        <div class="col-span-2 sm:col-span-1 sm:text-right">
                            <p class="text-sm text-gray-400">Сумма</p>
                            <p class="text-lg font-bold ${statusColor}">${data.amount}</p>
                        </div>
                    </div>
                    
                    <div class="mt-4 pt-4 border-t border-[var(--color-border)] grid grid-cols-2 sm:grid-cols-4 gap-4 text-center">
                        <div>
                            <p class="font-bold text-lg ${typeColor}">${data.paymentType}</p>
                            <p class="text-xs text-gray-500">Тип платежа</p>
                        </div>
                        <div>
                            <p class="font-bold text-lg text-white">${data.userStatus}</p>
                            <p class="text-xs text-gray-500">Статус (${data.userStatusDays} д.)</p>
                        </div>
                        <div>
                            <p class="font-bold text-lg text-white">${data.testsCreated}</p>
                            <p class="text-xs text-gray-500">Тестов создано</p>
                        </div>
                        <div>
                            <p class="font-bold text-lg text-white">#${data.orderId.slice(0, 8)}</p>
                            <p class="text-xs text-gray-500">ID Заказа</p>
                        </div>
                    </div>

                    <div class="mt-4 text-center text-xs text-gray-600">
                        ${data.date}
                    </div>
                `;
                modalBody.html(contentHTML);

                paymentModal.removeClass('hidden').addClass('flex');
                setTimeout(() => {
                    paymentModalContent.removeClass('scale-95 opacity-0').addClass('scale-100 opacity-100');
                }, 10);
            };

            const closePaymentModal = () => {
                paymentModalContent.addClass('scale-95 opacity-0').removeClass('scale-100 opacity-100');
                setTimeout(() => {
                    paymentModal.addClass('hidden').removeClass('flex');
                }, 300);
            };

            $(document).on('click', '.js-payment-card', function() {
                const card = $(this);
                const paymentData = {
                    name: card.data('name'),
                    planName: card.data('plan-name'),
                    amount: card.data('amount'),
                    date: card.data('date'),
                    paymentType: card.data('payment-type'),
                    paymentStatus: card.data('payment-status'),
                    userStatus: card.data('user-status'),
                    userStatusDays: card.data('user-status-days'),
                    testsCreated: card.data('tests-created'),
                    orderId: card.data('order-id')
                };
                openPaymentModal(paymentData);
            });

            closeModalPaymentBtn.on('click', closePaymentModal);
            paymentModal.on('click', function(e) {
                if (e.target === this) {
                    closePaymentModal();
                }
            });

            // --- ОТРИСОВКА ГРАФИКОВ ---
            const chartBorderColor = 'rgba(97, 109, 240, 0.2)';
            const chartTextColor = 'rgba(160, 160, 176, 1)';

            {% if total_api_usage_data %}
                try {
                    const totalApiData = JSON.parse('{{ total_api_usage_data|escapejs }}');
                    const totalApiCanvas = document.getElementById('totalApiUsageChart');
                    if (totalApiCanvas) {
                        const accentSecondary = 'rgba(16, 185, 129, 1)';
                        const ctx = totalApiCanvas.getContext('2d');
                        const gradient = ctx.createLinearGradient(0, 0, 0, totalApiCanvas.height);
                        gradient.addColorStop(0, accentSecondary.replace('1)', '0.5)'));
                        gradient.addColorStop(1, accentSecondary.replace('1)', '0)'));

                        new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: totalApiData.labels,
                                datasets: [{
                                    label: 'Всего вызовов API',
                                    data: totalApiData.data,
                                    borderColor: accentSecondary,
                                    backgroundColor: gradient,
                                    fill: true,
                                    tension: 0.4,
                                    pointBackgroundColor: accentSecondary,
                                    pointBorderColor: '#fff',
                                    pointHoverRadius: 6
                                }]
                            },
                            options: {
                                responsive: true, maintainAspectRatio: false,
                                plugins: { legend: { display: false } },
                                scales: {
                                    x: { ticks: { color: chartTextColor }, grid: { color: chartBorderColor } },
                                    y: { ticks: { color: chartTextColor, beginAtZero: true, precision: 0 }, grid: { color: chartBorderColor } }
                                }
                            }
                        });
                    }
                } catch (e) { console.error("Ошибка при отрисовке общего графика API:", e); }
            {% endif %}

            {% if daily_creation_data %}
                try {
                    const creationData = JSON.parse('{{ daily_creation_data|escapejs }}');
                    const creationCanvas = document.getElementById('dailyCreationChart');
                    if (creationCanvas) {
                        const ctx = creationCanvas.getContext('2d');
                        
                        const barGradient = ctx.createLinearGradient(0, 0, 0, 320);
                        barGradient.addColorStop(0, 'rgba(236, 72, 153, 0.9)');
                        barGradient.addColorStop(1, 'rgba(139, 92, 246, 0.9)');

                        new Chart(ctx, {
                            type: 'bar',
                            data: {
                                labels: creationData.labels,
                                datasets: [{
                                    label: 'Создано тестов в день',
                                    data: creationData.data,
                                    backgroundColor: barGradient,
                                    borderColor: 'rgba(236, 72, 153, 1)',
                                    borderWidth: 1,
                                    borderRadius: 5,
                                    hoverBackgroundColor: 'rgba(236, 72, 153, 1)',
                                    hoverBorderColor: 'rgba(255, 255, 255, 0.5)'
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: { display: false },
                                    tooltip: {
                                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                        padding: 10,
                                        cornerRadius: 8,
                                        displayColors: false
                                    }
                                },
                                scales: {
                                    x: {
                                        grid: { display: false },
                                        ticks: { color: chartTextColor }
                                    },
                                    y: {
                                        grid: { color: chartBorderColor.replace('0.2', '0.1') },
                                        ticks: { color: chartTextColor, precision: 0 },
                                        beginAtZero: true
                                    }
                                },
                                animation: {
                                    duration: 1000,
                                    easing: 'easeOutBounce',
                                    delay: (context) => {
                                        return context.dataIndex * 50;
                                    },
                                }
                            }
                        });
                    }
                } catch (e) { console.error("Ошибка при отрисовке графика создания:", e); }
            {% endif %}

            {% if daily_attempts_data %}
                try {
                    const dailyAttemptsData = JSON.parse('{{ daily_attempts_data|escapejs }}');
                    const dailyAttemptsCanvas = document.getElementById('dailyAttemptsChart');
                    if (dailyAttemptsCanvas) {
                        const ctx = dailyAttemptsCanvas.getContext('2d');
                        
                        const gradient = ctx.createLinearGradient(0, 0, 0, 320);
                        gradient.addColorStop(0, 'rgba(16, 185, 129, 0.5)');
                        gradient.addColorStop(1, 'rgba(16, 185, 129, 0)');

                        new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: dailyAttemptsData.labels,
                                datasets: [
                                {
                                    label: 'Прошлая неделя',
                                    data: dailyAttemptsData.previous_period_data,
                                    borderColor: 'rgba(75, 85, 99, 0.5)',
                                    backgroundColor: 'transparent',
                                    fill: false,
                                    borderDash: [5, 5],
                                    tension: 0.4,
                                    pointRadius: 0,
                                },
                                {
                                    label: 'Эта неделя',
                                    data: dailyAttemptsData.current_period_data,
                                    borderColor: '#10B981',
                                    backgroundColor: gradient,
                                    fill: true,
                                    tension: 0.4,
                                    pointBackgroundColor: '#10B981',
                                    pointBorderColor: '#fff',
                                    pointHoverRadius: 6
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                interaction: { mode: 'index', intersect: false },
                                plugins: {
                                    legend: { position: 'bottom', labels: { color: chartTextColor } },
                                    tooltip: { backgroundColor: 'rgba(0, 0, 0, 0.8)' }
                                },
                                scales: {
                                    x: { ticks: { color: chartTextColor }, grid: { color: chartBorderColor } },
                                    y: { ticks: { color: chartTextColor, beginAtZero: true, precision: 0 }, grid: { color: chartBorderColor } }
                                }
                            }
                        });
                    }
                } catch (e) { console.error("Ошибка при отрисовке графика пульса:", e); }
            {% endif %}

            {% if score_distribution_data and score_distribution_data != 'null' %}
                try {
                    const scoreData = JSON.parse('{{ score_distribution_data|escapejs }}');
                    const scoreCanvas = document.getElementById('scoreDistributionChart');
                    if (scoreCanvas) {
                        new Chart(scoreCanvas.getContext('2d'), {
                            type: 'doughnut',
                            data: {
                                labels: scoreData.labels,
                                datasets: [{
                                    label: 'Количество прохождений',
                                    data: scoreData.data,
                                    backgroundColor: [
                                        'rgba(16, 185, 129, 0.7)',
                                        'rgba(234, 179, 8, 0.7)',
                                        'rgba(239, 68, 68, 0.7)'
                                    ],
                                    borderColor: 'var(--color-surface)',
                                    borderWidth: 4,
                                    hoverOffset: 8
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                cutout: '70%',
                                plugins: {
                                    legend: {
                                        position: 'bottom',
                                        labels: {
                                            color: chartTextColor,
                                            boxWidth: 15,
                                            padding: 20
                                        }
                                    },
                                    tooltip: {
                                        callbacks: {
                                            label: function(context) {
                                                let label = context.dataset.label || '';
                                                if (label) {
                                                    label += ': ';
                                                }
                                                if (context.raw !== null) {
                                                    label += context.raw;
                                                }
                                                return label;
                                            }
                                        }
                                    }
                                }
                            }
                        });
                    }
                } catch (e) { console.error("Ошибка при отрисовке Спектра успеваемости:", e); }
            {% endif %}

            {% if test_performance_data and test_performance_data != 'null' %}
                try {
                    const performanceData = JSON.parse('{{ test_performance_data|escapejs }}');
                    const performanceCanvas = document.getElementById('testPerformanceChart');
                    if (performanceCanvas) {
                        new Chart(performanceCanvas.getContext('2d'), {
                            type: 'bubble',
                            data: {
                                datasets: [{
                                    label: 'Тесты',
                                    data: performanceData,
                                    backgroundColor: 'rgba(54, 162, 235, 0.6)',
                                    borderColor: 'rgba(54, 162, 235, 1)',
                                }]
                            },
                            options: {
                                responsive: true, maintainAspectRatio: false,
                                plugins: {
                                    legend: { display: false },
                                    tooltip: {
                                        callbacks: {
                                            label: function(context) {
                                                const d = context.raw;
                                                return `${d.label}: ${d.y} попыток, ${d.x}% средний балл`;
                                            }
                                        }
                                    }
                                },
                                scales: {
                                    x: {
                                        title: { display: true, text: 'Средний балл (%)', color: chartTextColor },
                                        ticks: { color: chartTextColor },
                                        grid: { color: chartBorderColor }
                                    },
                                    y: {
                                        title: { display: true, text: 'Количество попыток', color: chartTextColor },
                                        ticks: { color: chartTextColor },
                                        grid: { color: chartBorderColor }
                                    }
                                }
                            }
                        });
                    }
                } catch (e) { console.error("Ошибка при отрисовке карты эффективности:", e); }
            {% endif %}

            {% if user_chart_data %}
                try {
                    const regData = JSON.parse('{{ user_chart_data|escapejs }}');
                    const userCanvas = document.getElementById('userChart');
                    if (userCanvas) {
                        const ctx = userCanvas.getContext('2d');
                        
                        const emailGradient = ctx.createLinearGradient(0, 0, 0, 256);
                        emailGradient.addColorStop(0, 'rgba(79, 70, 229, 0.5)');
                        emailGradient.addColorStop(1, 'rgba(79, 70, 229, 0)');

                        const telegramGradient = ctx.createLinearGradient(0, 0, 0, 256);
                        telegramGradient.addColorStop(0, 'rgba(16, 185, 129, 0.6)');
                        telegramGradient.addColorStop(1, 'rgba(16, 185, 129, 0)');

                        new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: regData.labels,
                                datasets: [
                                    {
                                        label: 'Telegram',
                                        data: regData.telegram_data,
                                        borderColor: 'rgba(16, 185, 129, 1)',
                                        backgroundColor: telegramGradient,
                                        fill: true,
                                        tension: 0.4
                                    },
                                    {
                                        label: 'Email',
                                        data: regData.email_data,
                                        borderColor: 'rgba(79, 70, 229, 1)',
                                        backgroundColor: emailGradient,
                                        fill: true,
                                        tension: 0.4
                                    }
                                ]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                interaction: { mode: 'index', intersect: false },
                                plugins: {
                                    legend: { position: 'bottom', labels: { color: chartTextColor } },
                                    tooltip: { backgroundColor: 'rgba(0, 0, 0, 0.8)', padding: 10, cornerRadius: 8 }
                                },
                                scales: {
                                    x: { grid: { display: false }, ticks: { color: chartTextColor } },
                                    y: { 
                                        grid: { color: chartBorderColor.replace('0.2', '0.1') },
                                        ticks: { color: chartTextColor, precision: 0 },
                                        beginAtZero: true
                                    }
                                }
                            }
                        });
                    }
                } catch (e) { console.error("Ошибка 'Динамика регистраций':", e); }
            {% endif %}

            {% if api_chart_data and api_chart_data != 'null' %}
                try {
                    const apiChartData = JSON.parse('{{ api_chart_data|escapejs }}');
                    const apiChartCanvas = document.getElementById('apiUsageChart');
                    if (apiChartCanvas) {
                        new Chart(apiChartCanvas.getContext('2d'), {
                            type: 'bar',
                            data: {
                                labels: apiChartData.labels,
                                datasets: apiChartData.datasets
                            },
                            options: {
                                responsive: true, maintainAspectRatio: false,
                                plugins: {
                                    legend: { position: 'bottom', labels: { color: chartTextColor, boxWidth: 15, padding: 20 } },
                                    tooltip: { mode: 'index', intersect: false }
                                },
                                scales: {
                                    x: { stacked: true, ticks: { color: chartTextColor }, grid: { display: false } },
                                    y: { stacked: true, ticks: { color: chartTextColor, beginAtZero: true, precision: 0 }, grid: { color: chartBorderColor } }
                                }
                            }
                        });
                    }
                } catch (e) { console.error("Ошибка при отрисовке графика API:", e); }
            {% endif %}
        
            {% if user_activity_data and user_activity_data != 'null' %}
            try {
                const userActivityData = JSON.parse('{{ user_activity_data|escapejs }}');
                const userActivityCanvas = document.getElementById('userActivityChart');
                if (userActivityCanvas) {
                    new Chart(userActivityCanvas.getContext('2d'), {
                        type: 'bar',
                        data: {
                            labels: userActivityData.labels,
                            datasets: [{
                                label: 'Количество пользователей',
                                data: userActivityData.data,
                                backgroundColor: 'rgba(79, 70, 229, 0.8)',
                                borderColor: 'rgba(79, 70, 229, 1)',
                                borderWidth: 1,
                                borderRadius: 4,
                            }]
                        },
                        options: {
                                responsive: true, maintainAspectRatio: false,
                                plugins: {
                                    legend: { position: 'bottom', labels: { color: chartTextColor, boxWidth: 15, padding: 20 } },
                                    tooltip: { mode: 'index', intersect: false }
                                },
                                scales: {
                                    x: { stacked: true, ticks: { color: chartTextColor }, grid: { display: false } },
                                    y: { stacked: true, ticks: { color: chartTextColor, beginAtZero: true, precision: 0 }, grid: { color: chartBorderColor } }
                                }
                            }
                    });
                }
            } catch (e) { console.error("Ошибка при отрисовке графика активности:", e); }
        {% endif %}

        // Отрисовка ФИНАНСОВОГО ЦЕНТРА
        {% if daily_revenue_data and daily_revenue_data != 'null' %}
            try {
                const revData = JSON.parse('{{ daily_revenue_data|escapejs }}');
                const revCanvas = document.getElementById('dailyRevenueChart');
                if (revCanvas) {
                    const ctx = revCanvas.getContext('2d');
                    
                    const gradient = ctx.createLinearGradient(0, 0, 0, 320);
                    gradient.addColorStop(0, 'rgba(16, 185, 129, 0.8)');
                    gradient.addColorStop(1, 'rgba(16, 185, 129, 0.1)');

                    const areaGlowPlugin = {
                        id: 'areaGlow',
                        beforeDraw: (chart) => {
                            const { ctx, chartArea: { left, right, top, bottom } } = chart;
                            ctx.save();
                            const glowGradient = ctx.createLinearGradient(0, top, 0, bottom);
                            glowGradient.addColorStop(0, 'rgba(16, 185, 129, 0.2)');
                            glowGradient.addColorStop(1, 'rgba(16, 185, 129, 0)');
                            ctx.fillStyle = glowGradient;
                            ctx.fillRect(left, top, right - left, bottom - top);
                            ctx.restore();
                        }
                    };

                    new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: revData.labels,
                            datasets: [{
                                label: 'Выручка, ₽',
                                data: revData.data,
                                backgroundColor: gradient,
                                borderColor: 'rgba(16, 185, 129, 1)',
                                borderWidth: 1,
                                borderRadius: 4,
                                hoverBackgroundColor: 'rgba(16, 185, 129, 1)',
                                pointRadius: 4,
                                pointBackgroundColor: 'rgba(16, 185, 129, 1)',
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: false },
                                tooltip: {
                                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                    titleFont: { size: 14, weight: 'bold' },
                                    bodyFont: { size: 12 },
                                    padding: 10,
                                    cornerRadius: 8,
                                    displayColors: false,
                                }
                            },
                            scales: {
                                x: {
                                    grid: { display: false },
                                    ticks: { color: chartTextColor }
                                },
                                y: {
                                    grid: { color: chartBorderColor.replace('0.2', '0.1') },
                                    ticks: { 
                                        color: chartTextColor,
                                        callback: value => `${value} ₽`
                                    },
                                    beginAtZero: true
                                }
                            }
                        },
                        plugins: [areaGlowPlugin]
                    });
                }
            } catch (e) { console.error("Ошибка 'Денежный Поток':", e); }
        {% endif %}

        {% if arpu_dynamics_data and arpu_dynamics_data != 'null' %}
            try {
                const arpuData = JSON.parse('{{ arpu_dynamics_data|escapejs }}');
                const arpuCanvas = document.getElementById('arpuDynamicsChart');
                if (arpuCanvas) {
                    new Chart(arpuCanvas.getContext('2d'), {
                        type: 'line',
                        data: { labels: arpuData.labels, datasets: [{ label: 'Средний чек, ₽', data: arpuData.data, borderColor: '#F97316', tension: 0.3 }] },
                        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
                    });
                }
            } catch (e) { console.error("Ошибка 'Динамика ARPU':", e); }
        {% endif %}

        {% if revenue_source_data and revenue_source_data != 'null' %}
            try {
                const sourceData = JSON.parse('{{ revenue_source_data|escapejs }}');
                const sourceCanvas = document.getElementById('revenueSourceChart');
                if (sourceCanvas) {
                    const ctx = sourceCanvas.getContext('2d');
                    
                    const newRevenueGradient = ctx.createLinearGradient(0, 0, 0, 320);
                    newRevenueGradient.addColorStop(0, 'rgba(59, 130, 246, 0.5)');
                    newRevenueGradient.addColorStop(1, 'rgba(59, 130, 246, 0)');

                    const expansionRevenueGradient = ctx.createLinearGradient(0, 0, 0, 320);
                    expansionRevenueGradient.addColorStop(0, 'rgba(16, 185, 129, 0.6)');
                    expansionRevenueGradient.addColorStop(1, 'rgba(16, 185, 129, 0)');

                    new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: sourceData.labels,
                            datasets: [
                                {
                                    label: 'Старые клиенты',
                                    data: sourceData.expansion_revenue,
                                    borderColor: 'rgba(16, 185, 129, 1)',
                                    backgroundColor: expansionRevenueGradient,
                                    fill: true,
                                    tension: 0.4,
                                    pointRadius: 3,
                                    pointBackgroundColor: 'rgba(16, 185, 129, 1)',
                                },
                                {
                                    label: 'Новые клиенты',
                                    data: sourceData.new_revenue,
                                    borderColor: 'rgba(59, 130, 246, 1)',
                                    backgroundColor: newRevenueGradient,
                                    fill: true,
                                    tension: 0.4,
                                    pointRadius: 3,
                                    pointBackgroundColor: 'rgba(59, 130, 246, 1)',
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            interaction: {
                                mode: 'index',
                                intersect: false,
                            },
                            plugins: {
                                legend: {
                                    position: 'bottom',
                                    labels: { color: chartTextColor }
                                },
                                tooltip: {
                                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                    padding: 10,
                                    cornerRadius: 8,
                                }
                            },
                            scales: {
                                x: {
                                    grid: { display: false },
                                    ticks: { color: chartTextColor }
                                },
                                y: {
                                    grid: { color: chartBorderColor.replace('0.2', '0.1') },
                                    ticks: { color: chartTextColor, callback: value => `${value} ₽` },
                                    beginAtZero: true
                                }
                            }
                        }
                    });
                }
            } catch (e) { console.error("Ошибка 'Источник Дохода':", e); }
        {% endif %}

        {% if cohort_revenue_data and cohort_revenue_data != 'null' %}
            try {
                const cohortData = JSON.parse('{{ cohort_revenue_data|escapejs }}');
                const cohortCanvas = document.getElementById('cohortRevenueChart');
                if (cohortCanvas) {
                    new Chart(cohortCanvas.getContext('2d'), {
                        type: 'line',
                        data: { labels: cohortData.labels, datasets: cohortData.datasets },
                        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
                    });
                }
            } catch (e) { console.error("Ошибка 'Когорты Дохода':", e); }
        {% endif %}
        // END Отрисовка ФИНАНСОВОГО ЦЕНТРА

        {% if user_journey_data and user_journey_data != 'null' %}
            try {
                const journeyData = JSON.parse('{{ user_journey_data|escapejs }}');
                const journeyCanvas = document.getElementById('userJourneyChart');
                if (journeyCanvas) {
                    new Chart(journeyCanvas.getContext('2d'), {
                        type: 'bar',
                        data: {
                            labels: journeyData.labels,
                            datasets: [{
                                data: journeyData.data,
                                backgroundColor: [
                                    'rgba(79, 70, 229, 0.8)', // Indigo
                                    'rgba(16, 185, 129, 0.8)', // Emerald
                                    'rgba(245, 158, 11, 0.8)'  // Amber
                                ],
                                borderWidth: 0,
                                borderRadius: 4,
                                barPercentage: 0.6,
                            }]
                        },
                        options: {
                            indexAxis: 'y',
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: false },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            const rawValue = journeyData.raw_counts[context.dataIndex];
                                            const percentage = context.raw;
                                            return ` ${rawValue} пользователей (${percentage}%)`;
                                        }
                                    }
                                }
                            },
                            scales: {
                                x: {
                                    grid: { color: chartBorderColor },
                                    ticks: { 
                                        color: chartTextColor,
                                        callback: value => value + '%'
                                    },
                                    max: 100,
                                    beginAtZero: true
                                },
                                y: {
                                    grid: { display: false },
                                    ticks: { color: chartTextColor }
                                }
                            }
                        }
                    });
                }
            } catch (e) { console.error("Ошибка при отрисовке воронки:", e); }
        {% endif %}

        {% if usage_by_sub_data and usage_by_sub_data != 'null' %}
            try {
                const usageBySubData = JSON.parse('{{ usage_by_sub_data|escapejs }}');
                const usageBySubCanvas = document.getElementById('usageBySubChart');
                if (usageBySubCanvas) {
                    new Chart(usageBySubCanvas.getContext('2d'), {
                        type: 'bar',
                        data: {
                            labels: usageBySubData.labels,
                            datasets: [{
                                label: 'Среднее кол-во тестов на юзера',
                                data: usageBySubData.data,
                                backgroundColor: 'rgba(16, 185, 129, 0.8)',
                                borderColor: 'rgba(16, 185, 129, 1)',
                                borderWidth: 1,
                                borderRadius: 4,
                            }]
                        },
                        options: {
                                responsive: true, maintainAspectRatio: false,
                                plugins: {
                                    legend: { position: 'bottom', labels: { color: chartTextColor, boxWidth: 15, padding: 20 } },
                                    tooltip: { mode: 'index', intersect: false }
                                },
                                scales: {
                                    x: { stacked: true, ticks: { color: chartTextColor }, grid: { display: false } },
                                    y: { stacked: true, ticks: { color: chartTextColor, beginAtZero: true, precision: 0 }, grid: { color: chartBorderColor } }
                                }
                            }
                    });
                }
            } catch (e) { console.error("Ошибка при отрисовке графика по тарифам:", e); }
        {% endif %}

        {% if time_to_payment_data and time_to_payment_data != 'null' %}
            try {
                const ttpData = JSON.parse('{{ time_to_payment_data|escapejs }}');
                const ttpCanvas = document.getElementById('timeToPaymentChart');
                if (ttpCanvas) {
                    new Chart(ttpCanvas.getContext('2d'), {
                        type: 'bar',
                        data: {
                            labels: ttpData.labels,
                            datasets: [{
                                label: 'Количество пользователей',
                                data: ttpData.data,
                                backgroundColor: 'rgba(139, 92, 246, 0.7)',
                                borderColor: 'rgba(139, 92, 246, 1)',
                                borderRadius: 4
                            }]
                        },
                        options: { /* ... стандартные options для bar chart ... */ }
                    });
                }
            } catch (e) { console.error("Ошибка при отрисовке 'Время до покупки':", e); }
        {% endif %}

        {% if user_value_matrix_data and user_value_matrix_data != 'null' %}
            try {
                const matrixData = JSON.parse('{{ user_value_matrix_data|escapejs }}');
                const matrixCanvas = document.getElementById('userValueMatrixChart');
                if (matrixCanvas) {
                    new Chart(matrixCanvas.getContext('2d'), {
                        type: 'bubble',
                        data: {
                            datasets: [{
                                label: 'Пользователи',
                                data: matrixData,
                                backgroundColor: 'rgba(255, 255, 255, 0.2)',
                                borderColor: 'rgba(255, 255, 255, 0.5)',
                            }]
                        },
                        options: {
                            responsive: true, maintainAspectRatio: false,
                            plugins: {
                                legend: { display: false },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            const d = context.raw;
                                            return `${d.label}: ${d.x} попыток, ${d.y} ₽ доход`;
                                        }
                                    }
                                }
                            },
                            scales: {
                                x: {
                                    type: 'logarithmic', // Логарифмическая шкала для лучшей визуализации
                                    title: { display: true, text: 'Влияние (кол-во попыток на тестах)', color: chartTextColor },
                                    ticks: { color: chartTextColor },
                                },
                                y: {
                                    type: 'logarithmic',
                                    title: { display: true, text: 'Доход (₽)', color: chartTextColor },
                                    ticks: { color: chartTextColor }
                                }
                            }
                        }
                    });
                }
            } catch (e) { console.error("Ошибка при отрисовке 'Матрицы ценности':", e); }
        {% endif %}

        {% if top_topics_data and top_topics_data != 'null' %}
            try {
                const topTopicsData = JSON.parse('{{ top_topics_data|escapejs }}');
                const topTopicsCanvas = document.getElementById('topTopicsChart');
                if (topTopicsCanvas) {
                    new Chart(topTopicsCanvas.getContext('2d'), {
                        type: 'bar',
                        data: {
                            labels: topTopicsData.labels,
                            datasets: [{
                                label: 'Частота упоминаний',
                                data: topTopicsData.data,
                                backgroundColor: ['#36A2EB', '#FF6384', '#4BC0C0', '#FF9F40', '#9966FF', '#FFCD56', '#C9CBCF'],
                            }]
                        },
                        options: {
                            indexAxis: 'y',
                            responsive: true, maintainAspectRatio: false,
                            plugins: { legend: { display: false } },
                            scales: { y: { ticks: { color: chartTextColor } } }
                        }
                    });
                }
            } catch (e) { console.error("Ошибка при отрисовке графика тем:", e); }
        {% endif %}

        {% if daily_token_usage_data %}
            try {
                const tokenUsageData = JSON.parse('{{ daily_token_usage_data|escapejs }}');
                const tokenUsageCanvas = document.getElementById('dailyTokenUsageChart');
                if (tokenUsageCanvas) {
                    const accentColor = 'rgba(234, 179, 8, 1)';
                    const ctx = tokenUsageCanvas.getContext('2d');
                    const gradient = ctx.createLinearGradient(0, 0, 0, 320);
                    gradient.addColorStop(0, accentColor.replace('1)', '0.5)'));
                    gradient.addColorStop(1, accentColor.replace('1)', '0)'));

                    new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: tokenUsageData.labels,
                            datasets: [{
                                label: 'Сгенерировано токенов',
                                data: tokenUsageData.data,
                                borderColor: accentColor,
                                backgroundColor: gradient,
                                fill: true,
                                tension: 0.4,
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { display: false } },
                            scales: {
                                x: { ticks: { color: chartTextColor }, grid: { color: chartBorderColor } },
                                y: { 
                                    title: { display: true, text: 'Токены', color: chartTextColor },
                                    ticks: { color: chartTextColor, beginAtZero: true }, 
                                    grid: { color: chartBorderColor }
                                }
                            }
                        }
                    });
                }
            } catch (e) { console.error("Ошибка при отрисовке графика токенов:", e); }
        {% endif %}

        {% if api_performance_data and api_performance_data != 'null' %}
            try {
                const apiPerfData = JSON.parse('{{ api_performance_data|escapejs }}');
                const apiPerfCanvas = document.getElementById('apiPerformanceChart');
                if (apiPerfCanvas) {
                    const accentColor = '#4F46E5'; // Indigo
                    const ctx = apiPerfCanvas.getContext('2d');
                    const gradient = ctx.createLinearGradient(0, 0, 0, apiPerfCanvas.height);
                    gradient.addColorStop(0, accentColor.replace('1)', '0.5)'));
                    gradient.addColorStop(1, accentColor.replace('1)', '0)'));

                    new Chart(ctx, {
                        type: 'line',
                        data: {
                           labels: apiPerfData.labels,
                           datasets: [{
                               ...apiPerfData.datasets[0],
                               borderColor: accentColor,
                               backgroundColor: gradient,
                               fill: true,
                               tension: 0.4,
                               pointBackgroundColor: accentColor,
                               pointBorderColor: '#fff',
                               pointHoverRadius: 6
                           }]
                        },
                        options: {
                            responsive: true, maintainAspectRatio: false,
                            plugins: { legend: { display: false } },
                            scales: {
                                x: { ticks: { color: chartTextColor }, grid: { color: chartBorderColor } },
                                y: { 
                                    ticks: { color: chartTextColor, beginAtZero: true, callback: value => value + ' ms' }, 
                                    grid: { color: chartBorderColor }
                                }
                            }
                        }
                    });
                }
            } catch (e) { console.error("Ошибка при отрисовке графика производительности API:", e); }
        {% endif %}
        });
    </script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const statusContainer = document.getElementById('service-status-container');
            const logsContainer = document.getElementById('logs-container');

            const appLogContainer = document.getElementById('app-log-content');
            const gunicornLogContainer = document.getElementById('gunicorn-log-content');
            const logTabs = document.querySelectorAll('.log-tab');

            // --- ЛОГИКА ТАБОВ ---
            logTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    logTabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');

                    document.querySelectorAll('.log-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    
                    const targetId = tab.dataset.logTarget;
                    document.getElementById(targetId).classList.add('active');
                });
            });

            async function fetchLiveStats() {
                try {
                    const response = await fetch("{% url 'api_admin_live_stats' %}");
                    if (!response.ok) return;

                    const data = await response.json();

                    // --- ОБНОВЛЕНИЕ СТАТУСОВ СЕРВИСОВ ---
                    if (data.service_statuses && statusContainer) {
                        let statusHTML = '';
                        for (const [service, statusText] of Object.entries(data.service_statuses)) {
                            const isActive = statusText.includes('active (running)');
                            const colorClass = isActive ? 'text-green-400' : 'text-red-400';
                            const icon = isActive ? '<i class="fas fa-check-circle"></i>' : '<i class="fas fa-exclamation-triangle"></i>';
                            
                            statusHTML += `
                                <div class="flex items-center gap-3 text-sm">
                                    <span class="${colorClass}">${icon}</span>
                                    <span class="font-semibold text-white">${service}</span>
                                    <span class="ml-auto text-xs ${colorClass}">${isActive ? 'Active' : 'Inactive'}</span>
                                </div>
                            `;
                        }
                        statusContainer.innerHTML = statusHTML;
                    }
                    
                    // --- ОБНОВЛЕНИЕ ЛОГОВ ---
                    if (data.logs) {
                        if (appLogContainer) {
                            appLogContainer.textContent = data.logs.app_log || 'app.log пуст или не найден.';
                            appLogContainer.scrollTop = appLogContainer.scrollHeight;
                        }
                        if (gunicornLogContainer) {
                            gunicornLogContainer.textContent = data.logs.gunicorn_log || 'gunicorn.log пуст или не найден.';
                            gunicornLogContainer.scrollTop = gunicornLogContainer.scrollHeight;
                        }
                    }

                } catch (error) {
                    console.error("Error fetching live stats:", error);
                }
            }

            fetchLiveStats();
            setInterval(fetchLiveStats, 5000);
        });

    </script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const reactorContainer = document.getElementById('reactor-container');
            const sparkArc = document.getElementById('spark-arc');
            const trailArc = document.getElementById('trail-arc');
            const fillArc = document.getElementById('fill-arc');
            const counter = document.getElementById('tests-today-counter');
            const reactorText = document.getElementById('reactor-text');
            
            if (reactorContainer) {
                const arcLength = parseFloat('{{ main_gauge.arc_length }}');
                const finalOffset = parseFloat('{{ main_gauge.final_dashoffset }}');
                const finalValue = parseInt('{{ main_gauge.tests_today }}');

                const animateCounter = () => {
                    let start = null;
                    const duration = 1500;
                    const step = (timestamp) => {
                        if (!start) start = timestamp;
                        const progress = Math.min((timestamp - start) / duration, 1);
                        counter.innerText = Math.floor(progress * finalValue);
                        if (progress < 1) window.requestAnimationFrame(step);
                    };
                    window.requestAnimationFrame(step);
                };

                setTimeout(() => {
                    sparkArc.style.transition = 'stroke-dashoffset 1s cubic-bezier(0.8, 0, 0.2, 1)';
                    sparkArc.style.strokeDashoffset = -arcLength;

                    trailArc.style.transition = 'stroke-dashoffset 1.2s cubic-bezier(0.8, 0, 0.2, 1)';
                    trailArc.style.strokeDashoffset = -arcLength;
                }, 1000);

                setTimeout(() => {
                    sparkArc.style.opacity = 0;
                    trailArc.style.transition = 'opacity 0.5s ease';
                    trailArc.style.opacity = 0;

                    reactorText.style.opacity = 1;
                    reactorText.style.transform = 'scale(1)';

                    fillArc.style.strokeDashoffset = finalOffset;
                    
                    animateCounter();

                }, 2500);

                setTimeout(() => {
                    reactorContainer.classList.add('final-pulse-animation');
                }, 4000);
            }
        });
    </script>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const calendarEl = document.getElementById('churn-calendar');
        if (calendarEl) {
            const tooltip = document.createElement('div');
            tooltip.id = 'calendar-tooltip';
            document.body.appendChild(tooltip);

            const calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                locale: 'ru',
                headerToolbar: {
                    left: 'prev',
                    center: 'title',
                    right: 'next'
                },
                buttonText: {
                    today: 'Сегодня'
                },
                events: {{ churn_calendar_events_json|safe }},
                
                eventMouseEnter: function(info) {
                    const props = info.event.extendedProps;
                    tooltip.innerHTML = `
                        <p class="font-bold">${info.event.title}</p>
                        <p class="text-sm text-gray-300">${props.plan_name}</p>
                        <p class="text-xs text-gray-500 mt-1">до ${props.end_date_str}</p>
                    `;
                    
                    tooltip.style.opacity = '1';
                    tooltip.style.transform = 'scale(1)';
                    
                    const rect = info.el.getBoundingClientRect();
                    tooltip.style.left = `${rect.left + window.scrollX}px`;
                    tooltip.style.top = `${rect.bottom + window.scrollY + 5}px`;
                },
                eventMouseLeave: function(info) {
                    tooltip.style.opacity = '0';
                    tooltip.style.transform = 'scale(0.95)';
                }
            });
            calendar.render();
        }

        const chartTextColor = 'rgba(160, 160, 176, 1)';

        const acqSparklineCanvas = document.getElementById('acq-sparkline');
        if (acqSparklineCanvas) {
            const acqData = {{ growth_engine_data.acquisition.sparkline|safe }};
            const ctx = acqSparklineCanvas.getContext('2d');
            
            const gradient = ctx.createLinearGradient(0, 0, 0, 64);
            gradient.addColorStop(0, 'rgba(97, 109, 240, 0.5)');
            gradient.addColorStop(1, 'rgba(97, 109, 240, 0)');

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: Array(acqData.length).fill(''),
                    datasets: [{
                        data: acqData,
                        borderColor: '#616DF0',
                        backgroundColor: gradient,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false }, tooltip: { enabled: false } },
                    scales: {
                        x: { display: false },
                        y: { display: false }
                    }
                }
            });
        }

        const heatmapCanvas = document.getElementById('activity-heatmap');
        if (heatmapCanvas) {
            const heatmapData = {{ activity_heatmap_data|safe }};
            
            new Chart(heatmapCanvas.getContext('2d'), {
                type: 'matrix',
                data: {
                    datasets: [{
                        label: 'Активность',
                        data: heatmapData.flatMap((row, i) => row.map((value, j) => ({
                            x: j, // Час
                            y: i, // День недели
                            v: value
                        }))),
                        backgroundColor: function(ctx) {
                            const value = ctx.raw.v;
                            if (value === 0) return 'rgba(30, 24, 48, 0.5)';
                            const alpha = 0.2 + (value / (Math.max(...heatmapData.flat()) || 1)) * 0.8;
                            return `rgba(121, 239, 102, ${alpha})`;
                        },
                        borderColor: 'rgba(97, 109, 240, 0.2)',
                        borderWidth: 1,
                        width: ({chart}) => (chart.chartArea || {}).width / 24 - 1,
                        height: ({chart}) => (chart.chartArea || {}).height / 7 - 1,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                title: function(ctx) {
                                    const day = ['Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб', 'Вс'][ctx[0].raw.y];
                                    const hour = ctx[0].raw.x;
                                    return `${day}, ${hour}:00 - ${hour+1}:00`;
                                },
                                label: function(ctx) {
                                    return `Создано тестов: ${ctx.raw.v}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'linear',
                            labels: Array.from({length: 24}, (_, i) => `${i}`),
                            offset: false,
                            grid: { display: false },
                            ticks: {
                                stepSize: 2,
                                color: chartTextColor,
                            }
                        },
                        y: {
                            type: 'linear',
                            labels: ['Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб', 'Вс'],
                            offset: true,
                            grid: { display: false },
                            ticks: {
                                color: chartTextColor,
                            }
                        }
                    }
                }
            });
        }

        const pulseCanvas = document.getElementById('tests-pulse-sparkline');
        if (pulseCanvas) {
            const pulseData = {{ cyber_tests_pulse_json|safe }};
            const ctx = pulseCanvas.getContext('2d');
            
            const gradient = ctx.createLinearGradient(0, 0, 0, 48);
            gradient.addColorStop(0, 'rgba(121, 239, 102, 0.4)');
            gradient.addColorStop(1, 'rgba(121, 239, 102, 0)');

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Array(pulseData.length).fill(''),
                    datasets: [{
                        data: pulseData,
                        backgroundColor: gradient,
                        borderColor: '#79EF66',
                        borderWidth: 1,
                        borderRadius: 2,
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { display: false }, tooltip: { enabled: false } },
                    scales: { x: { display: false }, y: { display: false, beginAtZero: true } }
                }
            });
        }

        const chartBorderColor = 'rgba(97, 109, 240, 0.2)';

        // --- ФИНАНСОВЫЙ ПУЛЬС ---
        const revenuePulseCanvas = document.getElementById('revenue-pulse-chart');
        if (revenuePulseCanvas) {
            const chartData = {{ financial_pulse_chart_json|safe }};
            const ctx = revenuePulseCanvas.getContext('2d');
            
            const gradient = ctx.createLinearGradient(0, 0, 0, 256);
            gradient.addColorStop(0, 'rgba(59, 130, 246, 0.6)');
            gradient.addColorStop(1, 'rgba(59, 130, 246, 0.1)');

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: chartData.labels,
                    datasets: [{
                        label: 'Поступления',
                        data: chartData.data,
                        borderColor: '#3B82F6',
                        backgroundColor: gradient,
                        fill: true,
                        tension: 0.3,
                        pointBackgroundColor: '#3B82F6',
                        pointBorderColor: 'var(--color-bg)',
                        pointBorderWidth: 2,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { ticks: { color: chartTextColor }, grid: { color: chartBorderColor } },
                        y: { 
                            ticks: { color: chartTextColor, callback: value => `${value/1000} тыс. ₽` }, 
                            grid: { color: chartBorderColor }
                        }
                    }
                }
            });
        }

        const radarCanvas = document.getElementById('weekly-pulse-radar-chart');
        if (radarCanvas) {
            const chartData = {{ weekly_pulse_chart_json|safe }};

            new Chart(radarCanvas, {
                type: 'radar',
                data: {
                    labels: chartData.labels,
                    datasets: [
                        {
                            label: 'Прошлая неделя',
                            data: chartData.previous,
                            borderColor: 'rgba(97, 109, 240, 0.4)',
                            backgroundColor: 'rgba(97, 109, 240, 0.1)',
                            pointBackgroundColor: 'rgba(97, 109, 240, 0.4)',
                        },
                        {
                            label: 'Текущая неделя',
                            data: chartData.current,
                            borderColor: 'rgba(121, 239, 102, 0.8)',
                            backgroundColor: 'rgba(121, 239, 102, 0.2)',
                            pointBackgroundColor: 'rgba(121, 239, 102, 0.8)',
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { color: chartTextColor }
                        }
                    },
                    scales: {
                        r: {
                            grid: { color: chartBorderColor },
                            angleLines: { color: chartBorderColor },
                            pointLabels: { color: chartTextColor, font: { weight: 'bold' } },
                            ticks: {
                                display: false 
                            }
                        }
                    }
                }
            });
        }

        // --- ВИЗУАЛЬНАЯ ВОРОНКА АКТИВАЦИИ (1) ---
        const funnelCanvas = document.getElementById('activation-funnel-chart');
        if (funnelCanvas) {
            const funnelData = {{ cyber_gauges.activation_funnel_chart|safe }};
            
            const percentages = [];
            const totalTouches = funnelData.values[0] || 0;
            const registrations = funnelData.values[2] || 0;

            percentages.push(100.0);
            percentages.push(totalTouches > 0 ? (funnelData.values[1] / totalTouches * 100).toFixed(1) : 0.0); // Нелегалы от Всего
            percentages.push(totalTouches > 0 ? (funnelData.values[2] / totalTouches * 100).toFixed(1) : 0.0); // Регистрации от Всего
            percentages.push(registrations > 0 ? (funnelData.values[3] / registrations * 100).toFixed(1) : 0.0); // Активации от Регистраций

            const dataLabelsPlugin = {
                id: 'customDataLabels',
                afterDatasetsDraw(chart, args, options) {
                    const { ctx } = chart;
                    ctx.save();
                    ctx.font = 'bold 12px Inter';
                    ctx.fillStyle = 'white';
                    
                    chart.getDatasetMeta(0).data.forEach((datapoint, index) => {
                        const value = chart.data.datasets[0].data[index];
                        const percentage = percentages[index];
                        
                        let textToDraw = `${value}`;

                        if (index > 0) {
                            textToDraw += `\n(${percentage}%)`;
                        }

                        const lines = textToDraw.split('\n');
                        let y = datapoint.y;
                        if (lines.length > 1) { y = datapoint.y - 7; }

                        ctx.textAlign = 'left';
                        ctx.textBaseline = 'middle';
                        lines.forEach((line, i) => {
                            ctx.fillText(line, datapoint.x + 8, y + (i * 14));
                        });
                    });
                    ctx.restore();
                }
            };

            new Chart(funnelCanvas, {
                type: 'bar',
                data: {
                    labels: funnelData.labels,
                    datasets: [{
                        data: funnelData.values,
                        backgroundColor: [
                            'rgba(139, 92, 246, 0.7)',
                            'rgba(59, 130, 246, 0.7)',
                            'rgba(16, 185, 129, 0.7)',  // Зеленый
                            'rgba(234, 179, 8, 0.7)'    // Желтый
                        ],
                    }]
                },
                plugins: [dataLabelsPlugin],
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: { enabled: false },
                    },
                    scales: {
                        x: {
                            grid: { color: chartBorderColor },
                            ticks: { color: chartTextColor, precision: 0 },
                        },
                        y: {
                            grid: { display: false },
                            ticks: { color: chartTextColor, font: { weight: 'bold' } },
                        }
                    }
                }
            });
        }

        // --- ЕЖЕДНЕВНАЯ КАРТА ВОРОНКИ ---
        const dailyFunnelCanvas = document.getElementById('daily-funnel-chart');
        if (dailyFunnelCanvas) {
            const chartData = {{ daily_funnel_chart_json|safe }};

            new Chart(dailyFunnelCanvas, {
                type: 'bar',
                data: {
                    labels: chartData.labels,
                    datasets: [
                        {
                            label: 'Всего взаимодействий',
                            data: chartData.total_touches,
                            backgroundColor: 'rgba(97, 109, 240, 0.4)',
                            borderColor: 'rgba(97, 109, 240, 1)',
                            stack: 'background',
                            order: 4
                        },
                        {
                            label: 'Нелегалы',
                            data: chartData.illegals,
                            backgroundColor: '#3B82F6',
                            stack: 'bars',
                            order: 3
                        },
                        {
                            label: 'Регистрации',
                            data: chartData.registrations,
                            backgroundColor: '#22C55E',
                            stack: 'bars',
                            order: 2
                        },
                        {
                            label: 'Активировались',
                            data: chartData.activations,
                            type: 'line',
                            borderColor: '#F59E0B',
                            backgroundColor: 'rgba(245, 158, 11, 0.2)',
                            fill: true,
                            tension: 0.4,
                            pointRadius: 3,
                            pointBackgroundColor: '#F59E0B',
                            pointBorderColor: '#0F0818',
                            pointBorderWidth: 1.5,
                            borderWidth: 3,
                            order: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom', labels: { color: chartTextColor } },
                        tooltip: { mode: 'index', intersect: false }
                    },
                    scales: {
                        x: {
                            stacked: true,
                            grid: { color: chartBorderColor },
                            ticks: { color: chartTextColor }
                        },
                        y: {
                            stacked: false,
                            grid: { color: chartBorderColor },
                            ticks: { color: chartTextColor, precision: 0 },
                            beginAtZero: true
                        }
                    }
                }
            });
        }

    });
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Админ-панель | Летучка</title>
    <meta name="robots" content="noindex, nofollow" />
    {% load static %}
    <link rel="shortcut icon" href="{% static 'img/logo.png' %}" type="image/png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&family=Unbounded:wght@500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --color-bg: #0F0818;
            --color-surface: rgba(30, 24, 48, 0.5);
            --color-border: rgba(97, 109, 240, 0.2);
            --color-text-primary: #f0f0f0;
            --color-text-secondary: #a0a0b0;
            --color-accent-primary: #616DF0;
            --color-accent-secondary: #79EF66;
        }
        body { background-color: var(--color-bg); color: var(--color-text-primary); font-family: 'Inter', sans-serif; }
        h1, h2, h3 { font-family: 'Unbounded', sans-serif; }
        .gradient-text {
            background: linear-gradient(45deg, var(--color-accent-primary), var(--color-accent-secondary));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        .progress-bar-fill { transition: width 0.5s ease-in-out; }
    </style>
</head>
<body class="bg-[var(--color-bg)] text-[var(--color-text-primary)]">

    {% include 'header.html' %}

    <main class="max-w-7xl mx-auto p-4 sm:p-8 space-y-8">
        
        <h1 class="text-3xl font-bold text-white">Админ-панель</h1>

        <section class="grid grid-cols-1 lg:grid-cols-4 gap-6">
            <!-- Левая колонка: Фильтр и Админ-действия -->
            <div class="lg:col-span-1 space-y-6">
                <div class="bg-[var(--color-surface)] p-6 rounded-2xl border border-[var(--color-border)]">
                    <h2 class="font-bold text-white mb-4">Фильтр по дате</h2>
                    <form method="get" class="space-y-4">
                        <input type="date" name="start_date" value="{{ request.GET.start_date }}" class="w-full p-2 bg-[var(--color-bg)] border border-[var(--color-border)] rounded-lg">
                        <input type="date" name="end_date" value="{{ request.GET.end_date }}" class="w-full p-2 bg-[var(--color-bg)] border border-[var(--color-border)] rounded-lg">
                        <button type="submit" class="w-full py-2 font-bold text-center rounded-full bg-[var(--color-accent-primary)] text-white">Применить</button>
                    </form>
                </div>
                <!-- Сюда можно перенести карточки бана и повышения прав -->
            </div>

            <!-- Правая колонка: ВСЯ, СУКА, ТЕЛЕМЕТРИЯ -->
            <div class="lg:col-span-3 space-y-6">
                
                <!-- БЛОК "РОСТ" -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="bg-[var(--color-surface)] p-4 rounded-xl border border-[var(--color-border)] text-center"><p class="text-2xl font-bold gradient-text">{{ selected_users }}</p><p class="text-xs text-gray-400">Новых юзеров <span class="text-gray-600">(за период)</span></p></div>
                    <div class="bg-[var(--color-surface)] p-4 rounded-xl border border-[var(--color-border)] text-center"><p class="text-2xl font-bold gradient-text">{{ subscriptions }}</p><p class="text-xs text-gray-400">Новых подписок <span class="text-gray-600">(за период)</span></p></div>
                    <div class="bg-[var(--color-surface)] p-4 rounded-xl border border-[var(--color-border)] text-center"><p class="text-2xl font-bold text-white">{{ email_users_count }}</p><p class="text-xs text-gray-400">Юзеров (Email)</p></div>
                    <div class="bg-[var(--color-surface)] p-4 rounded-xl border border-[var(--color-border)] text-center"><p class="text-2xl font-bold text-white">{{ telegram_users_count }}</p><p class="text-xs text-gray-400">Юзеров (Telegram)</p></div>
                </div>

                <!-- БЛОК "АКТИВНОСТЬ" -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="bg-[var(--color-surface)] p-4 rounded-xl border border-[var(--color-border)] text-center"><p class="text-2xl font-bold gradient-text">{{ wau_weekly_active_users }}</p><p class="text-xs text-gray-400">Активных за неделю</p></div>
                    <div class="bg-[var(--color-surface)] p-4 rounded-xl border border-[var(--color-border)] text-center"><p class="text-2xl font-bold gradient-text">{{ active_users_monthly }}</p><p class="text-xs text-gray-400">Активных за месяц</p></div>
                    <div class="bg-[var(--color-surface)] p-4 rounded-xl border border-[var(--color-border)] text-center"><p class="text-2xl font-bold text-white">{{ stickiness_ratio|floatformat:1 }}%</p><p class="text-xs text-gray-400">"Липкость" (DAU/MAU)</p></div>
                    <div class="bg-[var(--color-surface)] p-4 rounded-xl border border-[var(--color-border)] text-center"><p class="text-2xl font-bold text-white">{{ conversion_rate_to_paid|floatformat:2 }}%</p><p class="text-xs text-gray-400">Конверсия в оплату</p></div>
                </div>

                <!-- БЛОК "ПРОДУКТ" -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="bg-[var(--color-surface)] p-4 rounded-xl border border-[var(--color-border)] text-center"><p class="text-2xl font-bold gradient-text">{{ total_surveys }}</p><p class="text-xs text-gray-400">Тестов создано <span class="text-gray-600">(за период)</span></p></div>
                    <div class="bg-[var(--color-surface)] p-4 rounded-xl border border-[var(--color-border)] text-center"><p class="text-2xl font-bold gradient-text">{{ total_answers }}</p><p class="text-xs text-gray-400">Ответов дано <span class="text-gray-600">(за период)</span></p></div>
                    <div class="bg-[var(--color-surface)] p-4 rounded-xl border border-[var(--color-border)] text-center"><p class="text-2xl font-bold text-white">{{ total_api_calls_today }}</p><p class="text-xs text-gray-400">Вызовов API <span class="text-gray-600">(сегодня)</span></p></div>
                    <div class="bg-[var(--color-surface)] p-4 rounded-xl border border-[var(--color-border)] text-center"><p class="text-2xl font-bold text-white">{{ total_users }}</p><p class="text-xs text-gray-400">Всего юзеров</p></div>
                </div>

            </div>
        </section>

        <section class="grid grid-cols-2 md:grid-cols-4 gap-6">
            <div class="bg-[var(--color-surface)] p-6 rounded-2xl border border-[var(--color-border)]"><h3 class="font-bold text-white">Общий доход</h3><p class="text-3xl font-bold text-[var(--color-accent-secondary)] mt-2">{{ total_revenue|floatformat:2 }} ₽</p></div>
            <div class="bg-[var(--color-surface)] p-6 rounded-2xl border border-[var(--color-border)]"><h3 class="font-bold text-white">Средний чек</h3><p class="text-3xl font-bold text-white mt-2">{{ average_check|floatformat:2 }} ₽</p></div>
            <div class="bg-[var(--color-surface)] p-6 rounded-2xl border border-[var(--color-border)]"><h3 class="font-bold text-white">Конверсия в оплату</h3><p class="text-3xl font-bold text-white mt-2">{{ payment_conversion|floatformat:1 }}%</p></div>
            <div class="bg-[var(--color-surface)] p-6 rounded-2xl border border-[var(--color-border)]"><h3 class="font-bold text-white">Ошибок оплаты</h3><p class="text-3xl font-bold text-red-500 mt-2">{{ failed_payments_count }}</p></div>
        </section>

        <section class="bg-[var(--color-surface)] p-6 rounded-2xl border border-[var(--color-border)]">
            <h2 class="font-bold text-white mb-4">Управление API ключами</h2>
            {% for purpose, keys in keys_by_purpose.items %}
                <h3 class="text-sm font-semibold text-gray-400 uppercase mt-4 mb-2">{{ purpose }}</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    {% for key in keys %}
                        <div class="p-4 rounded-lg border {% if key.is_active %}border-[var(--color-accent-secondary)] shadow-lg shadow-[var(--color-accent-secondary)]/20{% else %}border-[var(--color-border)]{% endif %}">
                            <div class="flex justify-between items-center"><span class="font-bold text-white">{{ key.name }}</span> <span class="text-xs px-2 py-1 bg-black/20 rounded-full">{{ key.provider }}</span></div>
                            <div class="text-xs text-gray-500 mt-1">До {{ key.expires_at|date:'d.m.Y'|default:"∞" }}</div>
                            <div class="w-full bg-black/20 rounded-full h-2.5 mt-2"><div class="progress-bar-fill bg-[var(--color-accent-secondary)] h-2.5 rounded-full" style="width: {{ key.usage_percent }}%"></div></div>
                            <div class="flex justify-between items-center mt-2">
                                <span class="text-xs text-gray-400">{{ key.today_usage_count }} / 50 сегодня</span>
                                {% if not key.is_active %}
                                    <form method="post" class="activate-key-form">
                                        <input type="hidden" name="activate_api_key_id" value="{{ key.id }}">
                                        <input type="hidden" name="key_purpose" value="{{ key.purpose }}">
                                        <button type="submit" class="text-xs font-bold text-[var(--color-accent-primary)] hover:text-white">Активировать</button>
                                    </form>
                                {% endif %}
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% endfor %}
            
            <div class="mt-6 pt-6 border-t border-[var(--color-border)]">
                <h3 class="font-bold text-white mb-4">Добавить новый ключ</h3>
                <form method="post" class="space-y-4">
                    {% csrf_token %}
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <input type="text" name="new_api_key_name" class="p-2 bg-[var(--color-bg)] border border-[var(--color-border)] rounded-lg" placeholder="Название" required>
                        <input type="text" name="new_api_key_value" class="p-2 bg-[var(--color-bg)] border border-[var(--color-border)] rounded-lg" placeholder="Значение" required>
                        <select name="new_api_key_provider" class="p-2 bg-[var(--color-bg)] border border-[var(--color-border)] rounded-lg" required><option value="openrouter">OpenRouter</option><option value="azure">Azure</option></select>
                        <select name="new_api_key_purpose" class="p-2 bg-[var(--color-bg)] border border-[var(--color-border)] rounded-lg" required><option value="FEEDBACK">FEEDBACK</option><option value="SURVEY">SURVEY</option></select>
                    </div>
                    <div class="flex gap-4">
                        <input type="date" name="new_api_key_expires" class="flex-grow p-2 bg-[var(--color-bg)] border border-[var(--color-border)] rounded-lg">
                        <button type="submit" class="w-full md:w-auto flex-grow py-2 font-bold text-center rounded-lg bg-[var(--color-accent-primary)] text-white">Добавить ключ</button>
                    </div>
                </form>
            </div>
        </section>

        {% if chart_data %}
        <section class="bg-[var(--color-surface)] p-6 rounded-2xl border border-[var(--color-border)]">
            <h2 class="font-bold text-white mb-4">Аналитика за период</h2>
            <div class="grid grid-cols-1 xl:grid-cols-2 gap-8">
                <div>
                    <h3 class="font-semibold text-gray-300 mb-2">Динамика регистраций</h3>
                    <div class="h-64">
                        <canvas id="userChart"></canvas>
                    </div>
                </div>
                <div>
                    <h3 class="font-semibold text-gray-300 mb-2">Использование API</h3>
                    <div class="h-64">
                        <canvas id="apiChart"></canvas>
                    </div>
                </div>
            </div>
        </section>
        {% endif %}
        
        <section class="bg-[var(--color-surface)] p-6 rounded-2xl border border-[var(--color-border)]">
             <h2 class="font-bold text-white mb-4">История платежей</h2>
             <div class="overflow-x-auto">
                <table class="w-full text-sm text-left">
                    <thead class="text-xs text-gray-400 uppercase"><tr><th class="p-2">Пользователь</th><th class="p-2">План</th><th class="p-2">Статус</th><th class="p-2">Сумма</th><th class="p-2">Дата</th></tr></thead>
                    <tbody>
                        {% for item in data %}
                        <tr class="border-b border-[var(--color-border)]"><td class="p-2">{{ item.name }}</td><td class="p-2">{{ item.plan_name }}</td><td class="p-2"><span class="px-2 py-1 rounded-full text-xs {% if item.payment_status == 'completed' %}bg-green-500/10 text-green-400{% else %}bg-red-500/10 text-red-400{% endif %}">{{ item.payment_status }}</span></td><td class="p-2">{{ item.amount }}</td><td class="p-2">{{ item.date }}</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
             </div>
        </section>

        <section class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="bg-[var(--color-surface)] p-6 rounded-2xl border border-[var(--color-border)]">
                <h2 class="font-bold text-white mb-4">Бан по IP</h2>
                <form method="post" class="ajax-form flex gap-2"><input type="text" name="ip_address" class="w-full p-2 bg-[var(--color-bg)] rounded-lg"><button type="submit" class="bg-red-800/80 hover:bg-red-700/80 px-4 rounded-lg font-bold">Ban</button></form>
            </div>
            <div class="bg-[var(--color-surface)] p-6 rounded-2xl border border-[var(--color-border)]">
                 <h2 class="font-bold text-white mb-4">Дать права админа</h2>
                <form method="post" class="ajax-form flex gap-2"><input type="text" name="username" class="w-full p-2 bg-[var(--color-bg)] rounded-lg"><button type="submit" class="bg-green-800/80 hover:bg-green-700/80 px-4 rounded-lg font-bold">Promote</button></form>
            </div>
        </section>

    </main>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        $(document).ready(function() {
            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }

            const csrftoken = getCookie('csrftoken');
            const currentUrl = window.location.pathname;

            $('.ajax-form').on('submit', function(event) {
                event.preventDefault();
                const form = $(this);
                const submitBtn = form.find('button[type="submit"]');
                const originalBtnText = submitBtn.html();

                $.ajax({
                    type: 'POST',
                    url: currentUrl,
                    headers: { 'X-CSRFToken': csrftoken },
                    data: form.serialize(),
                    beforeSend: () => submitBtn.prop('disabled', true).text('...'),
                    success: (response) => alert(response.message),
                    error: (xhr) => alert('Ошибка: ' + (xhr.responseJSON ? xhr.responseJSON.message : 'Сервер не отвечает')),
                    complete: () => {
                        submitBtn.prop('disabled', false).html(originalBtnText);
                        form.trigger('reset');
                    }
                });
            });

            $('.activate-key-form').on('submit', function(event) {
                event.preventDefault();
                const form = $(this);
                $.ajax({
                    type: 'POST',
                    url: currentUrl,
                    headers: { 'X-CSRFToken': csrftoken },
                    data: form.serialize(),
                    beforeSend: () => form.find('button[type="submit"]').prop('disabled', true).text('...'),
                    success: (response) => {
                        if (response.status) window.location.reload();
                        else alert('Ошибка: ' + response.message);
                    },
                    error: () => alert('Ошибка сети')
                });
            });


            {% if chart_data %}
                try {
                    const chartData = JSON.parse('{{ chart_data|escapejs }}');
                    const accentPrimary = 'rgba(97, 109, 240, 1)';
                    const accentSecondary = 'rgba(121, 239, 102, 1)';
                    const borderColor = 'rgba(97, 109, 240, 0.2)';
                    const textColor = 'rgba(160, 160, 176, 1)';

                    function createGradient(ctx, color) {
                        const chart = ctx.canvas.getContext('2d');
                        const gradient = chart.createLinearGradient(0, 0, 0, ctx.canvas.height);
                        gradient.addColorStop(0, color.replace('1)', '0.5)'));
                        gradient.addColorStop(1, color.replace('1)', '0)'));
                        return gradient;
                    }

                    const userChartCanvas = document.getElementById('userChart');
                    if (userChartCanvas) {
                        new Chart(userChartCanvas.getContext('2d'), {
                            type: 'line',
                            data: {
                                labels: chartData.labels,
                                datasets: [{
                                    label: 'Новые пользователи',
                                    data: chartData.user_counts,
                                    borderColor: accentPrimary,
                                    backgroundColor: (context) => createGradient(context.chart, accentPrimary),
                                    fill: true,
                                    tension: 0.4,
                                    pointBackgroundColor: accentPrimary,
                                    pointBorderColor: '#fff',
                                    pointHoverRadius: 6
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: { legend: { display: false } },
                                scales: {
                                    x: { ticks: { color: textColor }, grid: { color: borderColor } },
                                    y: { ticks: { color: textColor, beginAtZero: true, precision: 0 }, grid: { color: borderColor } }
                                }
                            }
                        });
                    }

                    const apiChartCanvas = document.getElementById('apiChart');
                    if (apiChartCanvas) {
                        new Chart(apiChartCanvas.getContext('2d'), {
                            type: 'bar',
                            data: {
                                labels: chartData.labels,
                                datasets: [{
                                    label: 'Вызовы API',
                                    data: chartData.api_counts,
                                    backgroundColor: accentSecondary.replace('1)', '0.7)'),
                                    borderColor: accentSecondary,
                                    borderWidth: 1,
                                    borderRadius: 4
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: { legend: { display: false } },
                                scales: {
                                    x: { ticks: { color: textColor }, grid: { display: false } },
                                    y: { ticks: { color: textColor, beginAtZero: true, precision: 0 }, grid: { color: borderColor } }
                                }
                            }
                        });
                    }
                } catch (e) {
                    console.error("Ошибка при отрисовке графиков:", e);
                }
            {% endif %}
        });
    </script>
</body>
</html>
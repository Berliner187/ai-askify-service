<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Пульс Летучки | Летучка</title>
    <meta name="robots" content="noindex, nofollow" />
    {% load static %}
    <link rel="shortcut icon" href="{% static 'img/logo.png' %}" type="image/png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&family=Unbounded:wght@500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --color-bg: #0F0818;
            --color-surface: rgba(30, 24, 48, 0.5);
            --color-border: rgba(97, 109, 240, 0.2);
            --color-text-primary: #f0f0f0;
            --color-text-secondary: #a0a0b0;
            --color-accent-primary: #616DF0;
            --color-accent-secondary: #79EF66;
            --color-red: #F06161;
        }
        body { background-color: var(--color-bg); color: var(--color-text-primary); font-family: 'Inter', sans-serif; }
        h1, h2, h3 { font-family: 'Unbounded', sans-serif; }
        .gradient-text {
            background: linear-gradient(45deg, var(--color-accent-primary), var(--color-accent-secondary));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        .progress-bar-fill { transition: width 0.5s ease-in-out; }

        /* --- ДОБАВЬ ЭТОТ CSS В <style> --- */
        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 15px 3px rgba(79, 70, 229, 0.4); }
            50% { box-shadow: 0 0 25px 8px rgba(79, 70, 229, 0.2); }
        }
        .gauge-glow {
            animation: pulse-glow 4s ease-in-out infinite;
        }
        .text-glow {
            text-shadow: 0 0 8px rgba(255, 255, 255, 0.3);
        }

        .gauge-ring {
            transition: stroke-dashoffset 1s ease-in-out;
        }
    </style>
</head>
<body class="bg-[var(--color-bg)] text-[var(--color-text-primary)]">

    {% include 'header.html' %}

    <main class="max-w-7xl mx-auto p-4 sm:p-8 space-y-8 mt-16">
        
        <div class="flex flex-col md:flex-row justify-between md:items-center gap-4">
            <h1 class="text-3xl font-bold text-white">Пульс Летучки</h1>
            <div class="bg-[var(--color-surface)] p-2 rounded-2xl border border-[var(--color-border)]">
                <form method="get" class="flex flex-col sm:flex-row items-center gap-2">
                    <input type="date" name="start_date" value="{{ start_date }}" class="w-full sm:w-auto p-2 bg-[var(--color-bg)] border border-[var(--color-border)] rounded-lg text-sm">
                    <span class="text-gray-500 hidden sm:block">-</span>
                    <input type="date" name="end_date" value="{{ end_date }}" class="w-full sm:w-auto p-2 bg-[var(--color-bg)] border border-[var(--color-border)] rounded-lg text-sm">
                    <button type="submit" class="w-full sm:w-auto px-4 py-2 font-bold text-center rounded-lg bg-[var(--color-accent-primary)] text-white text-sm">Применить</button>
                </form>
            </div>
        </div>

        <!-- <--- ГЛАВНЫЙ ПРИБОР -->
        <section class="bg-black/20 p-4 sm:p-6 rounded-3xl border border-[var(--color-border)] mb-8">
            <!-- Верхняя строка состояния -->
            <div class="flex justify-between items-center text-xs text-[var(--color-text-secondary)] border-b border-[var(--color-border)] pb-3 mb-3">
                <div class="flex items-center gap-4">
                    <div title="Новые реальные пользователи сегодня"><i class="fa-solid fa-user-plus text-green-400"></i> {{ main_gauge.status_bar.new_users_today }}</div>
                    <div title="Новые подписки сегодня"><i class="fa-solid fa-star text-yellow-400"></i> {{ main_gauge.status_bar.new_subs_today }}</div>
                    <div title="Ошибки оплат сегодня"><i class="fa-solid fa-triangle-exclamation text-red-400"></i> {{ main_gauge.status_bar.failed_payments_today }}</div>
                </div>
                <div class="flex items-center gap-4">
                    <div title="Вызовы API сегодня"><i class="fa-solid fa-bolt"></i> {{ main_gauge.status_bar.api_calls_today }}</div>
                    <div title="Среднее время ответа API"><i class="fa-solid fa-clock"></i> {{ main_gauge.status_bar.avg_response_time|floatformat:0 }} ms</div>
                </div>
            </div>

            <!-- Основной дисплей -->
            <div class="flex flex-col md:flex-row justify-around items-center gap-6 py-4">
                
                <!-- Левый тахометр: DAU -->
                <div class="text-center w-48">
                    <p class="text-5xl font-bold text-glow">{{ main_gauge.dau }}</p>
                    <p class="text-sm text-[var(--color-text-secondary)] tracking-widest">АКТИВНЫХ ПОЛЬЗОВАТЕЛЕЙ</p>
                </div>

                <!-- Центральный спидометр: Тестов создано -->
                <div class="relative w-52 h-52 flex items-center justify-center">
                    <!-- Дуга мощности -->
                    <div class="absolute inset-0 rounded-full gauge-glow"
                        style="background: conic-gradient(
                            rgba(79, 70, 229, 1) {{ main_gauge.active_key_load_degrees }}deg, 
                            rgba(31, 41, 55, 0.5) {{ main_gauge.active_key_load_degrees }}deg
                        );">
                    </div>
                    <!-- Внутренний круг -->
                    <div class="relative w-[85%] h-[85%] bg-[var(--color-bg)] rounded-full flex flex-col items-center justify-center text-center">
                        <p class="text-6xl font-bold text-glow">{{ main_gauge.tests_created_today }}</p>
                        <p class="text-sm text-[var(--color-text-secondary)] tracking-widest">ТЕСТОВ СЕГОДНЯ</p>
                    </div>
                </div>

                <!-- Правый навигатор: Доход -->
                <div class="text-center w-48">
                    <p class="text-5xl font-bold text-glow">{{ main_gauge.revenue_today|floatformat:2 }}<span class="text-3xl text-green-400">&nbsp;₽</span></p>
                    <p class="text-sm text-[var(--color-text-secondary)] tracking-widest">ЗАРАБОТАНО СЕГОДНЯ</p>
                </div>
            </div>

            <!-- Одометр -->
            <div class="text-center text-lg text-[var(--color-text-secondary)] border-t border-[var(--color-border)] pt-3 mt-3">
                <span class="font-mono tracking-widest">{{ main_gauge.total_tests_created }}</span>
                <span class="text-xs ml-1">ВСЕГО СОЗДАНО</span>
            </div>
        </section>

        <!-- 3 СУПЕР ВАЖНЫХ ДАТЧИКА -->
        <section class="mb-8">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 text-center">
                
                <!-- Датчик Активации -->
                <div class="bg-[var(--color-surface)] p-6 rounded-2xl border border-[var(--color-border)] flex flex-col justify-center items-center">
                    <div class="relative w-48 h-24 overflow-hidden">
                        <svg viewBox="0 0 120 65" class="w-full h-full">
                            <!-- Трек -->
                            <path d="M 10 60 A 50 50 0 0 1 110 60" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="12" stroke-linecap="round"/>
                            <!-- Прогресс -->
                            <path d="M 10 60 A 50 50 0 0 1 110 60" fill="none" stroke="#10B981" stroke-width="12" stroke-linecap="round"
                                class="gauge-ring"
                                stroke-dasharray="157"
                                stroke-dashoffset="{{ gauges.activation_dashoffset }}"/>
                        </svg>
                        <div class="absolute bottom-0 left-0 right-0">
                            <span class="text-4xl font-bold text-glow">{{ gauges.activation_percent }}%</span>
                        </div>
                    </div>
                    <p class="mt-3 text-sm font-semibold text-white">Активация в 1-й тест</p>
                    <p class="text-xs text-[var(--color-text-secondary)]">новые юзеры за месяц</p>
                </div>

                <!-- Центральный Дисплей: Доход к цели -->
                <div class="bg-[var(--color-surface)] p-6 rounded-2xl border border-[var(--color-border)] flex flex-col justify-center items-center">
                    <div class="relative w-48 h-24 overflow-hidden">
                        <svg viewBox="0 0 120 65" class="w-full h-full">
                            <!-- Трек -->
                            <path d="M 10 60 A 50 50 0 0 1 110 60" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="12" stroke-linecap="round"/>
                            <!-- Прогресс -->
                            <path d="M 10 60 A 50 50 0 0 1 110 60" fill="none" stroke="#8B5CF6" stroke-width="12" stroke-linecap="round"
                                class="gauge-ring"
                                stroke-dasharray="157"
                                stroke-dashoffset="{{ gauges.revenue_dashoffset }}"/>
                        </svg>
                        <div class="absolute bottom-0 left-0 right-0">
                            <span class="text-4xl font-bold text-glow">{{ gauges.revenue_this_month|floatformat:0 }}<span class="text-2xl opacity-80"> ₽</span></span>
                        </div>
                    </div>
                    <p class="mt-3 text-sm font-semibold text-white">Доход за месяц</p>
                    <p class="text-xs text-[var(--color-text-secondary)]">Цель: {{ gauges.monthly_goal }} ₽ ({{ gauges.revenue_goal_percent }}%)</p>
                </div>

                <!-- Датчик Мощности -->
                <div class="bg-[var(--color-surface)] p-6 rounded-2xl border border-[var(--color-border)] flex flex-col justify-center items-center">
                    <div class="relative w-48 h-24 overflow-hidden">
                        <svg viewBox="0 0 120 65" class="w-full h-full">
                            <path d="M 10 60 A 50 50 0 0 1 110 60" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="12" stroke-linecap="round"/>
                            <path d="M 10 60 A 50 50 0 0 1 110 60" fill="none" stroke="#3B82F6" stroke-width="12" stroke-linecap="round"
                                class="gauge-ring"
                                stroke-dasharray="157"
                                stroke-dashoffset="{{ gauges.tests_dashoffset }}"/>
                        </svg>
                        <div class="absolute bottom-0 left-0 right-0">
                            <span class="text-4xl font-bold text-glow">{{ gauges.tests_created_today }}</span>
                        </div>
                    </div>
                    <p class="mt-3 text-sm font-semibold text-white">Тестов создано сегодня</p>
                    <p class="text-xs text-[var(--color-text-secondary)]">нелегалами и легальными</p>
                </div>

            </div>
        </section>

        <!-- КЛЮЧЕВЫЕ ПОКАЗАТЕЛИ -->
        <section>
            <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">

                <div class="bg-[var(--color-surface)] p-6 rounded-2xl border border-[var(--color-border)] space-y-4">
                    <h2 class="font-bold text-white text-lg border-b border-b-[var(--color-border)] pb-2">Показатели</h2>
                    
                    <div class="text-center">
                        <p class="text-xs text-[var(--color-text-secondary)]">Всего реальных юзеров</p>
                        <p class="text-4xl font-bold gradient-text">{{ cockpit.total_real_users }}</p>
                    </div>

                    <div class="grid grid-cols-2 gap-4 text-center">
                        <div>
                            <p class="text-xs text-[var(--color-text-secondary)]">Новых сегодня</p>
                            <p class="text-2xl font-semibold">{{ cockpit.new_users_today }}</p>
                        </div>
                        <div>
                            <p class="text-xs text-[var(--color-text-secondary)]">Новых за месяц</p>
                            <p class="text-2xl font-semibold">{{ cockpit.new_users_month }}</p>
                        </div>
                    </div>

                    <div class="grid grid-cols-3 gap-2 text-center pt-2 border-t border-t-[var(--color-border)]">
                        <div><p class="font-bold text-lg">{{ cockpit.dau }}</p><p class="text-[10px] text-[var(--color-text-secondary)]">DAU</p></div>
                        <div><p class="font-bold text-lg">{{ cockpit.wau }}</p><p class="text-[10px] text-[var(--color-text-secondary)]">WAU</p></div>
                        <div><p class="font-bold text-lg">{{ cockpit.mau }}</p><p class="text-[10px] text-[var(--color-text-secondary)]">MAU</p></div>
                    </div>

                    <div>
                        <p class="text-xs text-[var(--color-text-secondary)]">Липкость (DAU/MAU)</p>
                        <div class="w-full bg-black/20 rounded-full h-2.5 mt-1"><div class="bg-[var(--color-accent-primary)] h-2.5 rounded-full" style="width: {{ cockpit.stickiness }}%"></div></div>
                    </div>
                    <div>
                        <p class="text-xs text-[var(--color-text-secondary)]">Активация в 1-й тест (за 30д)</p>
                        <div class="w-full bg-black/20 rounded-full h-2.5 mt-1"><div class="bg-[var(--color-accent-primary)] h-2.5 rounded-full" style="width: {{ cockpit.activation_rate_30d }}%"></div></div>
                    </div>
                </div>

                <div class="bg-[var(--color-surface)] p-6 rounded-2xl border border-[var(--color-border)] space-y-4">
                    <h2 class="font-bold text-white text-lg border-b border-b-[var(--color-border)] pb-2">Тесты</h2>
                    
                    <div class="grid grid-cols-2 gap-4 text-center">
                        <div>
                            <p class="text-xs text-[var(--color-text-secondary)]">Тестов создано сегодня</p>
                            <p class="text-3xl font-bold">{{ cockpit.tests_created_today }}</p>
                            <p class="text-xs {% if cockpit.tests_vs_yesterday >= 0 %}text-green-400{% else %}text-red-400{% endif %}">
                                {% if cockpit.tests_vs_yesterday >= 0 %}+{% endif %}{{ cockpit.tests_vs_yesterday }} к вчера
                            </p>
                        </div>
                        <div>
                            <p class="text-xs text-[var(--color-text-secondary)]">Попыток прохождения</p>
                            <p class="text-3xl font-bold">{{ cockpit.attempts_today }}</p>
                            <p class="text-xs {% if cockpit.attempts_vs_yesterday >= 0 %}text-green-400{% else %}text-red-400{% endif %}">
                                {% if cockpit.attempts_vs_yesterday >= 0 %}+{% endif %}{{ cockpit.attempts_vs_yesterday }} к вчера
                            </p>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4 text-center pt-2 border-t border-t-[var(--color-border)]">
                        <div>
                            <p class="text-xs text-[var(--color-text-secondary)]">Всего тестов</p>
                            <p class="text-xl font-semibold">{{ cockpit.tests_created_total }}</p>
                        </div>
                        <div>
                            <p class="text-xs text-[var(--color-text-secondary)]">Всего попыток</p>
                            <p class="text-xl font-semibold">{{ cockpit.attempts_total }}</p>
                        </div>
                    </div>
                    
                    <div class="text-center">
                        <p class="text-xs text-[var(--color-text-secondary)]">Средний балл за 30 дней</p>
                        <p class="text-2xl font-bold text-[var(--color-accent-secondary)]">{{ cockpit.avg_score_30d|floatformat:1 }}%</p>
                    </div>
                </div>
                
                <div class="bg-[var(--color-surface)] p-6 rounded-2xl border border-[var(--color-border)] space-y-4">
                    <h2 class="font-bold text-white text-lg border-b border-b-[var(--color-border)] pb-2">Экономика</h2>
                    
                    <div class="text-center">
                        <p class="text-xs text-[var(--color-text-secondary)]">Доход сегодня</p>
                        <p class="text-4xl font-bold text-[var(--color-accent-secondary)]">{{ cockpit.revenue_today|floatformat:2 }} ₽</p>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4 text-center">
                        <div>
                            <p class="text-xs text-[var(--color-text-secondary)]">Доход за месяц</p>
                            <p class="text-xl font-semibold">{{ cockpit.revenue_month|floatformat:2 }} ₽</p>
                        </div>
                        <div>
                            <p class="text-xs text-[var(--color-text-secondary)]">Новых подписок сегодня</p>
                            <p class="text-xl font-semibold">{{ cockpit.new_subs_today }}</p>
                        </div>
                        <div>
                            <p class="text-xs text-[var(--color-text-secondary)]">Активных подписок</p>
                            <p class="text-xl font-semibold">{{ cockpit.active_subs_total }}</p>
                        </div>
                        <div>
                            <p class="text-xs text-[var(--color-text-secondary)]">Средний чек</p>
                            <p class="text-xl font-semibold">{{ cockpit.avg_check_total|floatformat:2 }} ₽</p>
                        </div>
                    </div>
                    
                    <div class="text-center pt-2 border-t border-t-[var(--color-border)]">
                        <p class="text-xs text-[var(--color-text-secondary)]">Конверсия в оплату (общая)</p>
                        <p class="text-2xl font-bold">{{ cockpit.conversion_to_paid_total }}%</p>
                    </div>
                </div>

                <div class="bg-[var(--color-surface)] p-6 rounded-2xl border border-[var(--color-border)] space-y-4">
                    <h2 class="font-bold text-white text-lg border-b border-b-[var(--color-border)] pb-2">Поставщики</h2>

                    <div class="text-center">
                        <p class="text-xs text-[var(--color-text-secondary)]">Вызовов API сегодня</p>
                        <p class="text-4xl font-bold">{{ cockpit.api_calls_today }}</p>
                        <p class="text-xs {% if cockpit.api_calls_vs_yesterday >= 0 %}text-green-400{% else %}text-red-400{% endif %}">
                            {% if cockpit.api_calls_vs_yesterday >= 0 %}+{% endif %}{{ cockpit.api_calls_vs_yesterday }} к вчера
                        </p>
                    </div>

                    <div>
                        <p class="text-xs text-[var(--color-text-secondary)]">Загрузка активного SURVEY ключа ({{ cockpit.active_key_name }})</p>
                        <div class="w-full bg-black/20 rounded-full h-4 mt-1 flex items-center justify-center relative">
                            <div class="{{ cockpit.active_key_load_color }} h-4 rounded-full transition-all duration-500" style="width: {{ cockpit.active_key_load }}%"></div>
                            <span class="absolute text-xs font-bold text-white mix-blend-difference">{{ cockpit.active_key_load }}%</span>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4 text-center pt-2 border-t border-t-[var(--color-border)]">
                        <div>
                            <p class="text-xs text-[var(--color-text-secondary)]">Успешность API</p>
                            <p class="text-xl font-semibold text-green-400">{{ cockpit.api_success_rate_today }}%</p>
                        </div>
                        <div>
                            <p class="text-xs text-[var(--color-text-secondary)]">Ср. ответ API</p>
                            <p class="text-xl font-semibold">{{ cockpit.avg_response_time_today|floatformat:0 }} ms</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section class="space-y-8">
            <h2 class="font-bold text-white text-xl">Аналитика публичных тестов (последние 7 дней)</h2>

            <div class="grid grid-cols-1 xl:grid-cols-2 gap-8">
                <!-- Пульс Активности -->
                <div class="bg-[var(--color-surface)] p-6 rounded-2xl border border-[var(--color-border)]">
                    <h3 class="font-bold text-white mb-4">Пульс Активности</h3>
                    <div class="h-80">
                        <canvas id="dailyAttemptsChart"></canvas>
                    </div>
                </div>

                <!-- Карта Эффективности Тестов -->
                <div class="bg-[var(--color-surface)] p-6 rounded-2xl border border-[var(--color-border)]">
                    <h3 class="font-bold text-white mb-4">Карта Эффективности Тестов (Топ-20)</h3>
                    <div class="h-80">
                        <canvas id="testPerformanceChart"></canvas>
                    </div>
                </div>
            </div>
        </section>

        <section class="space-y-8">
            <h2 class="font-bold text-white text-xl">Анализ продукта и поведения пользователей</h2>

            <section class="grid grid-cols-1 xl:grid-cols-2 gap-8">
                {% if user_chart_data %}
                <div class="bg-[var(--color-surface)] p-6 rounded-2xl border border-[var(--color-border)]">
                    <h2 class="font-bold text-white mb-4">Динамика регистраций</h2>
                    <div class="h-64"><canvas id="userChart"></canvas></div>
                </div>
                {% endif %}
                
                <div class="bg-[var(--color-surface)] p-6 rounded-2xl border border-[var(--color-border)]">
                    <h2 class="font-bold text-white mb-4">Воронка активации пользователей (30 дней)</h2>
                    <div class="h-64">
                        <canvas id="userJourneyChart"></canvas>
                    </div>
                </div>

                <div class="bg-[var(--color-surface)] p-6 rounded-2xl border border-[var(--color-border)]">
                    <h3 class="font-bold text-white mb-4">Популярные темы тестов</h3>
                    <div class="h-80"><canvas id="topTopicsChart"></canvas></div>
                </div>

                <div class="bg-[var(--color-surface)] p-6 rounded-2xl border border-[var(--color-border)]">
                    <h3 class="font-bold text-white mb-4">Расход токенов</h3>
                    <div class="h-80">
                        <canvas id="dailyTokenUsageChart"></canvas>
                    </div>
                </div>
            </section>

            <section class="space-y-8">
                <h2 class="font-bold text-white text-xl">Бизнес-инсайты</h2>

                <div class="grid grid-cols-1 xl:grid-cols-2 gap-8">
                    <div class="bg-[var(--color-surface)] p-6 rounded-2xl border border-[var(--color-border)]">
                        <h3 class="font-bold text-white mb-4">Время до Первой Покупки</h3>
                        <div class="h-80">
                            <canvas id="timeToPaymentChart"></canvas>
                        </div>
                    </div>
                    <div class="bg-[var(--color-surface)] p-6 rounded-2xl border border-[var(--color-border)]">
                        <h3 class="font-bold text-white mb-4">Матрица Ценности Пользователей (Топ-100)</h3>
                        <div class="h-80 relative">
                            <canvas id="userValueMatrixChart"></canvas>
                            <div class="absolute top-2 right-2 text-xs text-yellow-400 font-bold">Звезды</div>
                            <div class="absolute bottom-2 right-2 text-xs text-green-400 font-bold">Крупные клиенты</div>
                            <div class="absolute top-2 left-2 text-xs text-blue-400 font-bold">Амбассадоры</div>
                            <div class="absolute bottom-2 left-2 text-xs text-gray-500 font-bold">Потенциал</div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Когортный анализ -->
            {% if retention_data %}
            <div class="bg-[var(--color-surface)] p-6 rounded-2xl border border-[var(--color-border)]">
                <h3 class="font-bold text-white mb-4">Удержание пользователей (Когортный анализ)</h3>
                <div class="overflow-x-auto">
                    <table class="w-full text-xs text-left">
                        <thead class="text-[var(--color-text-secondary)]">
                            <tr>
                                <th class="p-2 bg-[#111827]/50 rounded-tl-lg">Когорта</th>
                                <th class="p-2 bg-[#111827]/50">Юзеров</th>
                                {% for header in retention_data.headers %}
                                    <th class="p-2 bg-[#111827]/50 text-center {% if forloop.last %}rounded-tr-lg{% endif %}">{{ header }}</th>
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for cohort in retention_data.cohorts %}
                            <tr class="border-b border-[var(--color-border)]">
                                <td class="p-2 font-semibold">{{ cohort.cohort_name }}</td>
                                <td class="p-2">{{ cohort.size }}</td>
                                {% for cell in cohort.values %}
                                    {% if forloop.counter0 < retention_data.headers|length %}
                                    <td class="p-0 text-center">
                                        {% if cell.percentage is not None %}
                                        <div class="m-1 p-2 rounded-xl" style="background-color: rgba(16, 185, 129, {{ cell.percentage }});">
                                            {{ cell.percentage }}%
                                            <div class="text-[10px] opacity-70">{{ cell.users }}</div>
                                        </div>
                                        {% endif %}
                                    </td>
                                    {% endif %}
                                {% endfor %}
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% endif %}

            <!-- Чарты с распределением юзеров -->
            <div class="grid grid-cols-1 xl:grid-cols-2 gap-8">
                <div class="bg-[var(--color-surface)] p-6 rounded-2xl border border-[var(--color-border)]">
                    <h3 class="font-bold text-white mb-4">Распределение активности пользователей</h3>
                    <div class="h-64"><canvas id="userActivityChart"></canvas></div>
                </div>
                <div class="bg-[var(--color-surface)] p-6 rounded-2xl border border-[var(--color-border)]">
                    <h3 class="font-bold text-white mb-4">Использование продукта по тарифам</h3>
                    <div class="h-64"><canvas id="usageBySubChart"></canvas></div>
                </div>
            </div>
        </section>

        <!-- Чарты с экономикой вкратце -->
        <section id="financial-briefing" class="mb-8">
            <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
                <div class="bg-[var(--color-surface)] p-6 rounded-2xl border border-[var(--color-border)]">
                    <h3 class="text-sm font-semibold text-gray-400">Выручка за период</h3>
                    <p class="mt-2 text-4xl font-black text-white text-glow">
                        {{ financial_briefing.revenue|floatformat:0 }} <span class="text-2xl opacity-70">₽</span>
                    </p>
                </div>
                <div class="bg-[var(--color-surface)] p-6 rounded-2xl border border-[var(--color-border)]">
                    <h3 class="text-sm font-semibold text-gray-400">Текущий MRR за период</h3>
                    <p class="mt-2 text-4xl font-black text-white text-glow">
                        {{ financial_briefing.new_mrr|floatformat:0 }} <span class="text-2xl opacity-70">₽</span>
                    </p>
                </div>
                <div class="bg-[var(--color-surface)] p-6 rounded-2xl border border-[var(--color-border)]">
                    <h3 class="text-sm font-semibold text-gray-400">Средний Чек (ARPU)</h3>
                    <p class="mt-2 text-4xl font-black text-white text-glow">
                        {{ financial_briefing.arpu|floatformat:0 }} <span class="text-2xl opacity-70">₽</span>
                    </p>
                </div>

            </div>
        </section>

        <!-- Чарты с финансовым командным центром -->
        <section id="financial-command-center" class="space-y-8">
            <h2 class="font-bold text-white text-xl">Финансовый командный центр</h2>

            <div class="grid grid-cols-1 xl:grid-cols-2 gap-8">
                <div class="bg-[var(--color-surface)] p-6 rounded-2xl border border-[var(--color-border)]">
                    <h3 class="font-bold text-white mb-4">Денежный Поток (за период)</h3>
                    <div class="h-80"><canvas id="dailyRevenueChart"></canvas></div>
                </div>
                <div class="bg-[var(--color-surface)] p-6 rounded-2xl border border-[var(--color-border)]">
                    <h3 class="font-bold text-white mb-4">Динамика Среднего Чека (за период)</h3>
                    <div class="h-80"><canvas id="arpuDynamicsChart"></canvas></div>
                </div>
                <div class="bg-[var(--color-surface)] p-6 rounded-2xl border border-[var(--color-border)]">
                    <h3 class="font-bold text-white mb-4">Источник Дохода: Новые vs. Старые</h3>
                    <div class="h-80"><canvas id="revenueSourceChart"></canvas></div>
                </div>
                <div class="bg-[var(--color-surface)] p-6 rounded-2xl border border-[var(--color-border)]">
                    <h3 class="font-bold text-white mb-4">Жизненный Цикл Дохода по Когортам (LTV)</h3>
                    <div class="h-80"><canvas id="cohortRevenueChart"></canvas></div>
                </div>
            </div>
        </section>
        
        <!-- УПРАВЛЕНИЕ API -->
        <section class="bg-[var(--color-surface)] p-6 rounded-2xl border border-[var(--color-border)]">
            <h2 class="font-bold text-white mb-4 text-xl">Управление API ключами</h2>
            <section class="grid grid-cols-1 xl:grid-cols-2 gap-8">
                {% if api_chart_data %}
                <div class="bg-[var(--color-surface)] p-6 rounded-2xl border border-[var(--color-border)]">
                    <h2 class="font-bold text-white mb-4">Использование API по ключам</h2>
                    <div class="h-64"><canvas id="apiUsageChart"></canvas></div>
                </div>
                {% endif %}
                <div class="bg-[var(--color-surface)] p-6 rounded-2xl border border-[var(--color-border)]">
                    <h2 class="font-bold text-white mb-4">Общее использование API</h2>
                    <div class="h-64"><canvas id="totalApiUsageChart"></canvas></div>
                </div>
            </section>

            {% for purpose, keys in keys_by_purpose.items %}
                <h3 class="text-sm font-semibold text-gray-400 uppercase mt-4 mb-2">{{ purpose }}</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    {% for key in keys %}
                        <div class="p-4 rounded-lg border {% if key.is_active %}border-[var(--color-accent-secondary)] shadow-lg shadow-[var(--color-accent-secondary)]/20{% else %}border-[var(--color-border)]{% endif %}">
                            <div class="flex justify-between items-center"><span class="font-bold text-white">{{ key.name }}</span> <span class="text-xs px-2 py-1 bg-black/20 rounded-full">{{ key.provider }}</span></div>
                            <div class="text-xs text-gray-500 mt-1">До {{ key.expires_at|date:'d.m.Y'|default:"∞" }}</div>
                            <div class="w-full bg-black/20 rounded-full h-2.5 mt-2"><div class="progress-bar-fill bg-[var(--color-accent-secondary)] h-2.5 rounded-full" style="width: {{ key.usage_percent }}%"></div></div>
                            <div class="flex justify-between items-center mt-2">
                                <span class="text-xs text-gray-400">{{ key.today_usage_count }} / 50 сегодня</span>
                                {% if not key.is_active %}
                                    <form method="post" class="activate-key-form" data-action="{% url 'api_activate_key' %}">
                                        <input type="hidden" name="activate_api_key_id" value="{{ key.id }}">
                                        <input type="hidden" name="key_purpose" value="{{ key.purpose }}">
                                        <button type="submit" class="text-xs font-bold text-[var(--color-accent-primary)] hover:text-white">Активировать</button>
                                    </form>
                                {% endif %}
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% endfor %}
            
            <div class="mt-6 pt-6 border-t border-[var(--color-border)]">
                <h3 class="font-bold text-white mb-4">Добавить новый ключ</h3>
                <form method="post" action="{% url 'api_add_key' %}" class="space-y-4">
                    {% csrf_token %}
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <input type="text" name="new_api_key_name" class="p-2 bg-[var(--color-bg)] border border-[var(--color-border)] rounded-lg" placeholder="Название" required>
                        <input type="text" name="new_api_key_value" class="p-2 bg-[var(--color-bg)] border border-[var(--color-border)] rounded-lg" placeholder="Значение" required>
                        <select name="new_api_key_provider" class="p-2 bg-[var(--color-bg)] border border-[var(--color-border)] rounded-lg" required><option value="openrouter">OpenRouter</option><option value="azure">Azure</option></select>
                        <select name="new_api_key_purpose" class="p-2 bg-[var(--color-bg)] border border-[var(--color-border)] rounded-lg" required><option value="FEEDBACK">FEEDBACK</option><option value="SURVEY">SURVEY</option></select>
                    </div>
                    <div class="flex gap-4">
                        <input type="date" name="new_api_key_expires" class="flex-grow p-2 bg-[var(--color-bg)] border border-[var(--color-border)] rounded-lg">
                        <button type="submit" class="w-full md:w-auto flex-grow py-2 font-bold text-center rounded-lg bg-[var(--color-accent-primary)] text-white">Добавить ключ</button>
                    </div>
                </form>
            </div>

            <section class="gap-8 mt-6">
                <div class="bg-[var(--color-surface)] p-6 rounded-2xl border border-[var(--color-border)]">
                    <h2 class="font-bold text-white mb-4">Среднее время ответа API</h2>
                    <div class="h-64"><canvas id="apiPerformanceChart"></canvas></div>
                </div>
            </section>
            
        </section>

        <!-- ИСТОРИЯ ПЛАТЕЖЕЙ -->
         {% for item in payment_data %}
            <button class="js-payment-card w-full text-left bg-[var(--color-bg)] p-2 rounded-2xl border border-[var(--color-border)] 
                         transition-all duration-300"
                    data-name="{{ item.name }}"
                    data-plan-name="{{ item.plan_name }}"
                    data-amount="{{ item.amount }}"
                    data-date="{{ item.date|date:'d M Y, H:i' }}"
                    data-payment-type="{{ item.payment_type }}"
                    data-payment-status="{{ item.payment_status }}"
                    data-user-status="{{ item.user_status }}"
                    data-user-status-days="{{ item.user_status_days }}"
                    data-tests-created="{{ item.total_tests_created }}"
                    data-order-id="{{ item.order_id }}">
                
                <div class="flex flex-col sm:flex-row sm:items-center gap-4 pointer-events-none">
                    <div class="flex-shrink-0 w-full sm:w-28 text-center">
                        {% if item.payment_status == 'completed' %}
                            <p class="text-lg font-bold text-green-400"><i class="fas fa-plus-circle mr-2"></i>Успех</p>
                            <p class="text-xs font-semibold {% if item.payment_type == 'Первая' %}text-yellow-400{% else %}text-blue-400{% endif %}">
                                {{ item.payment_type }}
                            </p>
                        {% else %}
                            <p class="text-lg font-bold text-red-500"><i class="fas fa-exclamation-triangle mr-2"></i>Сбой</p>
                            <p class="text-xs text-gray-500">{{ item.payment_type }}</p>
                        {% endif %}
                    </div>

                    <!-- ОСНОВНАЯ ИНФА -->
                    <div class="flex-grow">
                        <div class="flex justify-between items-baseline">
                            <p class="font-bold text-white text-lg truncate pr-4">{{ item.name }}</p>
                            <p class="font-mono font-bold text-xl 
                                    {% if item.payment_status == 'completed' %}
                                        bg-gradient-to-r from-green-400 to-emerald-500 bg-clip-text text-transparent
                                    {% else %}text-red-500 line-through{% endif %}">
                                +{{ item.amount }}
                            </p>
                        </div>
                        <p class="text-xs text-gray-400 -mt-1">{{ item.plan_name }}</p>
                    </div>

                    <!-- ДАТА -->
                    <div class="flex-shrink-0 w-full sm:w-24 text-left sm:text-right">
                        <p class="text-sm font-medium text-white">{{ item.date|date:"d M" }}</p>
                        <p class="text-xs text-gray-500">{{ item.date|date:"H:i" }}</p>
                    </div>
                </div>
            </button>
        {% empty %}
            <p class="text-center text-gray-500 py-8">Пока нет данных о платежах.</p>
        {% endfor %}

        <!-- АДМИН-ДЕЙСТВИЯ -->
        <section class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="bg-[var(--color-surface)] p-6 rounded-2xl border border-[var(--color-border)]">
                <h2 class="font-bold text-white mb-4">Бан по IP</h2>
                <form method="post" class="ajax-form flex gap-2" data-action="{% url 'api_block_ip' %}">
                    <input type="text" name="ip_address" class="w-full p-2 bg-[var(--color-bg)] border border-[var(--color-border)] rounded-lg" placeholder="192.168.1.1">
                    <button type="submit" class="bg-red-800/80 hover:bg-red-700/80 px-4 rounded-lg font-bold">Ban</button>
                </form>
            </div>
            <div class="bg-[var(--color-surface)] p-6 rounded-2xl border border-[var(--color-border)]">
                 <h2 class="font-bold text-white mb-4">Дать права админа</h2>
                <form method="post" class="ajax-form flex gap-2" data-action="{% url 'api_promote_user' %}">
                    <input type="text" name="username" class="w-full p-2 bg-[var(--color-bg)] border border-[var(--color-border)] rounded-lg" placeholder="Имя пользователя">
                    <button type="submit" class="bg-green-800/80 hover:bg-green-700/80 px-4 rounded-lg font-bold">Promote</button>
                </form>
            </div>
        </section>

    </main>

    <div id="payment-details-modal" class="fixed inset-0 bg-black/80 z-50 hidden items-center justify-center p-4">
        <div id="payment-modal-content" class="bg-[var(--color-surface)] w-full max-w-lg p-8 rounded-3xl border border-[var(--color-border)] 
                                            transform scale-95 opacity-0 transition-all duration-300 backdrop-blur-xl">
            
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-white">Детали транзакции</h3>
                <button id="close-payment-modal-btn" class="text-gray-500 hover:text-white text-3xl">&times;</button>
            </div>
            
            <!-- Контент, который будет заполняться динамически -->
            <div id="modal-body-content" class="space-y-4">
                <!-- Сюда будет вставляться контент через JS -->
            </div>
        </div>
    </div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        $(document).ready(function() {
            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }

            const csrftoken = getCookie('csrftoken');

            // Универсальный обработчик для AJAX форм
            $('.ajax-form').on('submit', function(event) {
                event.preventDefault();
                const form = $(this);
                const submitBtn = form.find('button[type="submit"]');
                const originalBtnText = submitBtn.html();
                const actionUrl = form.data('action');

                $.ajax({
                    type: 'POST',
                    url: actionUrl,
                    headers: { 'X-CSRFToken': csrftoken },
                    data: form.serialize(),
                    beforeSend: () => submitBtn.prop('disabled', true).text('...'),
                    success: (response) => alert(response.message),
                    error: (xhr) => alert('Ошибка: ' + (xhr.responseJSON ? xhr.responseJSON.message : 'Сервер не отвечает')),
                    complete: () => {
                        submitBtn.prop('disabled', false).html(originalBtnText);
                        form.trigger('reset');
                    }
                });
            });

            // Обработчик для активации ключей
            $('.activate-key-form').on('submit', function(event) {
                event.preventDefault();
                const form = $(this);
                const actionUrl = form.data('action');
                $.ajax({
                    type: 'POST',
                    url: actionUrl,
                    headers: { 'X-CSRFToken': csrftoken },
                    data: form.serialize(),
                    beforeSend: () => form.find('button[type="submit"]').prop('disabled', true).text('...'),
                    success: (response) => {
                        if (response.status) {
                            window.location.reload();
                        } else {
                            alert('Ошибка: ' + response.message);
                        }
                    },
                    error: () => alert('Ошибка сети')
                });
            });

            // Модалка деталей платежа
            const paymentModal = $('#payment-details-modal');
            const paymentModalContent = $('#payment-modal-content');
            const closeModalPaymentBtn = $('#close-payment-modal-btn');
            const modalBody = $('#modal-body-content');

            const openPaymentModal = (data) => {
                const statusColor = data.paymentStatus === 'completed' ? 'text-green-400' : 'text-red-500';
                const typeColor = data.paymentType === 'Первая' ? 'text-yellow-400' : 'text-blue-400';

                const contentHTML = `
                    <div class="grid grid-cols-2 gap-x-6 gap-y-4">
                        <div class="col-span-2 sm:col-span-1">
                            <p class="text-sm text-gray-400">Пользователь</p>
                            <p class="text-lg font-bold text-white">${data.name}</p>
                        </div>
                        <div class="col-span-2 sm:col-span-1 sm:text-right">
                            <p class="text-sm text-gray-400">Сумма</p>
                            <p class="text-lg font-bold ${statusColor}">${data.amount}</p>
                        </div>
                    </div>
                    
                    <div class="mt-4 pt-4 border-t border-[var(--color-border)] grid grid-cols-2 sm:grid-cols-4 gap-4 text-center">
                        <div>
                            <p class="font-bold text-lg ${typeColor}">${data.paymentType}</p>
                            <p class="text-xs text-gray-500">Тип платежа</p>
                        </div>
                        <div>
                            <p class="font-bold text-lg text-white">${data.userStatus}</p>
                            <p class="text-xs text-gray-500">Статус (${data.userStatusDays} д.)</p>
                        </div>
                        <div>
                            <p class="font-bold text-lg text-white">${data.testsCreated}</p>
                            <p class="text-xs text-gray-500">Тестов создано</p>
                        </div>
                        <div>
                            <p class="font-bold text-lg text-white">#${data.orderId.slice(0, 8)}</p>
                            <p class="text-xs text-gray-500">ID Заказа</p>
                        </div>
                    </div>

                    <div class="mt-4 text-center text-xs text-gray-600">
                        ${data.date}
                    </div>
                `;
                modalBody.html(contentHTML);

                paymentModal.removeClass('hidden').addClass('flex');
                setTimeout(() => {
                    paymentModalContent.removeClass('scale-95 opacity-0').addClass('scale-100 opacity-100');
                }, 10);
            };

            const closePaymentModal = () => {
                paymentModalContent.addClass('scale-95 opacity-0').removeClass('scale-100 opacity-100');
                setTimeout(() => {
                    paymentModal.addClass('hidden').removeClass('flex');
                }, 300);
            };

            $(document).on('click', '.js-payment-card', function() {
                const card = $(this);
                const paymentData = {
                    name: card.data('name'),
                    planName: card.data('plan-name'),
                    amount: card.data('amount'),
                    date: card.data('date'),
                    paymentType: card.data('payment-type'),
                    paymentStatus: card.data('payment-status'),
                    userStatus: card.data('user-status'),
                    userStatusDays: card.data('user-status-days'),
                    testsCreated: card.data('tests-created'),
                    orderId: card.data('order-id')
                };
                openPaymentModal(paymentData);
            });

            closeModalPaymentBtn.on('click', closePaymentModal);
            paymentModal.on('click', function(e) {
                if (e.target === this) {
                    closePaymentModal();
                }
            });

            // --- ОТРИСОВКА ГРАФИКОВ ---
            const chartBorderColor = 'rgba(97, 109, 240, 0.2)';
            const chartTextColor = 'rgba(160, 160, 176, 1)';

            {% if total_api_usage_data %}
                try {
                    const totalApiData = JSON.parse('{{ total_api_usage_data|escapejs }}');
                    const totalApiCanvas = document.getElementById('totalApiUsageChart');
                    if (totalApiCanvas) {
                        const accentSecondary = 'rgba(16, 185, 129, 1)'; // Emerald Green
                        const ctx = totalApiCanvas.getContext('2d');
                        const gradient = ctx.createLinearGradient(0, 0, 0, totalApiCanvas.height);
                        gradient.addColorStop(0, accentSecondary.replace('1)', '0.5)'));
                        gradient.addColorStop(1, accentSecondary.replace('1)', '0)'));

                        new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: totalApiData.labels,
                                datasets: [{
                                    label: 'Всего вызовов API',
                                    data: totalApiData.data,
                                    borderColor: accentSecondary,
                                    backgroundColor: gradient,
                                    fill: true,
                                    tension: 0.4,
                                    pointBackgroundColor: accentSecondary,
                                    pointBorderColor: '#fff',
                                    pointHoverRadius: 6
                                }]
                            },
                            options: {
                                responsive: true, maintainAspectRatio: false,
                                plugins: { legend: { display: false } },
                                scales: {
                                    x: { ticks: { color: chartTextColor }, grid: { color: chartBorderColor } },
                                    y: { ticks: { color: chartTextColor, beginAtZero: true, precision: 0 }, grid: { color: chartBorderColor } }
                                }
                            }
                        });
                    }
                } catch (e) { console.error("Ошибка при отрисовке общего графика API:", e); }
            {% endif %}

            {% if daily_attempts_data %}
                try {
                    const dailyAttemptsData = JSON.parse('{{ daily_attempts_data|escapejs }}');
                    const dailyAttemptsCanvas = document.getElementById('dailyAttemptsChart');
                    if (dailyAttemptsCanvas) {
                        const ctx = dailyAttemptsCanvas.getContext('2d');
                        const gradient = ctx.createLinearGradient(0, 0, 0, 320);
                        gradient.addColorStop(0, 'rgba(16, 185, 129, 0.5)');
                        gradient.addColorStop(1, 'rgba(16, 185, 129, 0)');

                        new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: dailyAttemptsData.labels,
                                datasets: [{
                                    label: 'Прохождений в день',
                                    data: dailyAttemptsData.data,
                                    borderColor: '#10B981',
                                    backgroundColor: gradient,
                                    fill: true,
                                    tension: 0.4,
                                }]
                            },
                            options: {
                                responsive: true, maintainAspectRatio: false,
                                plugins: { legend: { display: false } },
                                scales: {
                                    x: { ticks: { color: chartTextColor }, grid: { color: chartBorderColor } },
                                    y: { ticks: { color: chartTextColor, beginAtZero: true, precision: 0 }, grid: { color: chartBorderColor } }
                                }
                            }
                        });
                    }
                } catch (e) { console.error("Ошибка при отрисовке графика пульса:", e); }
            {% endif %}

            {% if test_performance_data and test_performance_data != 'null' %}
                try {
                    const performanceData = JSON.parse('{{ test_performance_data|escapejs }}');
                    const performanceCanvas = document.getElementById('testPerformanceChart');
                    if (performanceCanvas) {
                        new Chart(performanceCanvas.getContext('2d'), {
                            type: 'bubble',
                            data: {
                                datasets: [{
                                    label: 'Тесты',
                                    data: performanceData,
                                    backgroundColor: 'rgba(54, 162, 235, 0.6)',
                                    borderColor: 'rgba(54, 162, 235, 1)',
                                }]
                            },
                            options: {
                                responsive: true, maintainAspectRatio: false,
                                plugins: {
                                    legend: { display: false },
                                    tooltip: {
                                        callbacks: {
                                            label: function(context) {
                                                const d = context.raw;
                                                return `${d.label}: ${d.y} попыток, ${d.x}% средний балл`;
                                            }
                                        }
                                    }
                                },
                                scales: {
                                    x: {
                                        title: { display: true, text: 'Средний балл (%)', color: chartTextColor },
                                        ticks: { color: chartTextColor },
                                        grid: { color: chartBorderColor }
                                    },
                                    y: {
                                        title: { display: true, text: 'Количество попыток', color: chartTextColor },
                                        ticks: { color: chartTextColor },
                                        grid: { color: chartBorderColor }
                                    }
                                }
                            }
                        });
                    }
                } catch (e) { console.error("Ошибка при отрисовке карты эффективности:", e); }
            {% endif %}

            {% if user_chart_data %}
                try {
                    const regData = JSON.parse('{{ user_chart_data|escapejs }}');
                    const userCanvas = document.getElementById('userChart');
                    if (userCanvas) {
                        const ctx = userCanvas.getContext('2d');
                        
                        const emailGradient = ctx.createLinearGradient(0, 0, 0, 256);
                        emailGradient.addColorStop(0, 'rgba(79, 70, 229, 0.5)');
                        emailGradient.addColorStop(1, 'rgba(79, 70, 229, 0)');

                        const telegramGradient = ctx.createLinearGradient(0, 0, 0, 256);
                        telegramGradient.addColorStop(0, 'rgba(16, 185, 129, 0.6)');
                        telegramGradient.addColorStop(1, 'rgba(16, 185, 129, 0)');

                        new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: regData.labels,
                                datasets: [
                                    {
                                        label: 'Telegram',
                                        data: regData.telegram_data,
                                        borderColor: 'rgba(16, 185, 129, 1)',
                                        backgroundColor: telegramGradient,
                                        fill: true,
                                        tension: 0.4
                                    },
                                    {
                                        label: 'Email',
                                        data: regData.email_data,
                                        borderColor: 'rgba(79, 70, 229, 1)',
                                        backgroundColor: emailGradient,
                                        fill: true,
                                        tension: 0.4
                                    }
                                ]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                interaction: { mode: 'index', intersect: false },
                                plugins: {
                                    legend: { position: 'bottom', labels: { color: chartTextColor } },
                                    tooltip: { backgroundColor: 'rgba(0, 0, 0, 0.8)', padding: 10, cornerRadius: 8 }
                                },
                                scales: {
                                    x: { grid: { display: false }, ticks: { color: chartTextColor } },
                                    y: { 
                                        grid: { color: chartBorderColor.replace('0.2', '0.1') },
                                        ticks: { color: chartTextColor, precision: 0 },
                                        beginAtZero: true
                                    }
                                }
                            }
                        });
                    }
                } catch (e) { console.error("Ошибка 'Динамика регистраций':", e); }
            {% endif %}

            {% if api_chart_data and api_chart_data != 'null' %}
                try {
                    const apiChartData = JSON.parse('{{ api_chart_data|escapejs }}');
                    const apiChartCanvas = document.getElementById('apiUsageChart');
                    if (apiChartCanvas) {
                        new Chart(apiChartCanvas.getContext('2d'), {
                            type: 'bar',
                            data: {
                                labels: apiChartData.labels,
                                datasets: apiChartData.datasets
                            },
                            options: {
                                responsive: true, maintainAspectRatio: false,
                                plugins: {
                                    legend: { position: 'bottom', labels: { color: chartTextColor, boxWidth: 15, padding: 20 } },
                                    tooltip: { mode: 'index', intersect: false }
                                },
                                scales: {
                                    x: { stacked: true, ticks: { color: chartTextColor }, grid: { display: false } },
                                    y: { stacked: true, ticks: { color: chartTextColor, beginAtZero: true, precision: 0 }, grid: { color: chartBorderColor } }
                                }
                            }
                        });
                    }
                } catch (e) { console.error("Ошибка при отрисовке графика API:", e); }
            {% endif %}
        
            {% if user_activity_data and user_activity_data != 'null' %}
            try {
                const userActivityData = JSON.parse('{{ user_activity_data|escapejs }}');
                const userActivityCanvas = document.getElementById('userActivityChart');
                if (userActivityCanvas) {
                    new Chart(userActivityCanvas.getContext('2d'), {
                        type: 'bar',
                        data: {
                            labels: userActivityData.labels,
                            datasets: [{
                                label: 'Количество пользователей',
                                data: userActivityData.data,
                                backgroundColor: 'rgba(79, 70, 229, 0.8)',
                                borderColor: 'rgba(79, 70, 229, 1)',
                                borderWidth: 1,
                                borderRadius: 4,
                            }]
                        },
                        options: {
                                responsive: true, maintainAspectRatio: false,
                                plugins: {
                                    legend: { position: 'bottom', labels: { color: chartTextColor, boxWidth: 15, padding: 20 } },
                                    tooltip: { mode: 'index', intersect: false }
                                },
                                scales: {
                                    x: { stacked: true, ticks: { color: chartTextColor }, grid: { display: false } },
                                    y: { stacked: true, ticks: { color: chartTextColor, beginAtZero: true, precision: 0 }, grid: { color: chartBorderColor } }
                                }
                            }
                    });
                }
            } catch (e) { console.error("Ошибка при отрисовке графика активности:", e); }
        {% endif %}

        // Отрисовка ФИНАНСОВОГО ЦЕНТРА
        {% if daily_revenue_data and daily_revenue_data != 'null' %}
            try {
                const revData = JSON.parse('{{ daily_revenue_data|escapejs }}');
                const revCanvas = document.getElementById('dailyRevenueChart');
                if (revCanvas) {
                    const ctx = revCanvas.getContext('2d');
                    
                    const gradient = ctx.createLinearGradient(0, 0, 0, 320);
                    gradient.addColorStop(0, 'rgba(16, 185, 129, 0.8)');
                    gradient.addColorStop(1, 'rgba(16, 185, 129, 0.1)');

                    const areaGlowPlugin = {
                        id: 'areaGlow',
                        beforeDraw: (chart) => {
                            const { ctx, chartArea: { left, right, top, bottom } } = chart;
                            ctx.save();
                            const glowGradient = ctx.createLinearGradient(0, top, 0, bottom);
                            glowGradient.addColorStop(0, 'rgba(16, 185, 129, 0.2)');
                            glowGradient.addColorStop(1, 'rgba(16, 185, 129, 0)');
                            ctx.fillStyle = glowGradient;
                            ctx.fillRect(left, top, right - left, bottom - top);
                            ctx.restore();
                        }
                    };

                    new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: revData.labels,
                            datasets: [{
                                label: 'Выручка, ₽',
                                data: revData.data,
                                backgroundColor: gradient,
                                borderColor: 'rgba(16, 185, 129, 1)',
                                borderWidth: 1,
                                borderRadius: 4,
                                hoverBackgroundColor: 'rgba(16, 185, 129, 1)',
                                pointRadius: 4,
                                pointBackgroundColor: 'rgba(16, 185, 129, 1)',
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: false },
                                tooltip: {
                                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                    titleFont: { size: 14, weight: 'bold' },
                                    bodyFont: { size: 12 },
                                    padding: 10,
                                    cornerRadius: 8,
                                    displayColors: false,
                                }
                            },
                            scales: {
                                x: {
                                    grid: { display: false },
                                    ticks: { color: chartTextColor }
                                },
                                y: {
                                    grid: { color: chartBorderColor.replace('0.2', '0.1') },
                                    ticks: { 
                                        color: chartTextColor,
                                        callback: value => `${value} ₽`
                                    },
                                    beginAtZero: true
                                }
                            }
                        },
                        plugins: [areaGlowPlugin]
                    });
                }
            } catch (e) { console.error("Ошибка 'Денежный Поток':", e); }
        {% endif %}

        {% if arpu_dynamics_data and arpu_dynamics_data != 'null' %}
            try {
                const arpuData = JSON.parse('{{ arpu_dynamics_data|escapejs }}');
                const arpuCanvas = document.getElementById('arpuDynamicsChart');
                if (arpuCanvas) {
                    new Chart(arpuCanvas.getContext('2d'), {
                        type: 'line',
                        data: { labels: arpuData.labels, datasets: [{ label: 'Средний чек, ₽', data: arpuData.data, borderColor: '#F97316', tension: 0.3 }] },
                        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
                    });
                }
            } catch (e) { console.error("Ошибка 'Динамика ARPU':", e); }
        {% endif %}

        {% if revenue_source_data and revenue_source_data != 'null' %}
            try {
                const sourceData = JSON.parse('{{ revenue_source_data|escapejs }}');
                const sourceCanvas = document.getElementById('revenueSourceChart');
                if (sourceCanvas) {
                    const ctx = sourceCanvas.getContext('2d');
                    
                    const newRevenueGradient = ctx.createLinearGradient(0, 0, 0, 320);
                    newRevenueGradient.addColorStop(0, 'rgba(59, 130, 246, 0.5)');
                    newRevenueGradient.addColorStop(1, 'rgba(59, 130, 246, 0)');

                    const expansionRevenueGradient = ctx.createLinearGradient(0, 0, 0, 320);
                    expansionRevenueGradient.addColorStop(0, 'rgba(16, 185, 129, 0.6)');
                    expansionRevenueGradient.addColorStop(1, 'rgba(16, 185, 129, 0)');

                    new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: sourceData.labels,
                            datasets: [
                                {
                                    label: 'Старые клиенты',
                                    data: sourceData.expansion_revenue,
                                    borderColor: 'rgba(16, 185, 129, 1)',
                                    backgroundColor: expansionRevenueGradient,
                                    fill: true,
                                    tension: 0.4,
                                    pointRadius: 3,
                                    pointBackgroundColor: 'rgba(16, 185, 129, 1)',
                                },
                                {
                                    label: 'Новые клиенты',
                                    data: sourceData.new_revenue,
                                    borderColor: 'rgba(59, 130, 246, 1)',
                                    backgroundColor: newRevenueGradient,
                                    fill: true,
                                    tension: 0.4,
                                    pointRadius: 3,
                                    pointBackgroundColor: 'rgba(59, 130, 246, 1)',
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            interaction: {
                                mode: 'index',
                                intersect: false,
                            },
                            plugins: {
                                legend: {
                                    position: 'bottom',
                                    labels: { color: chartTextColor }
                                },
                                tooltip: {
                                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                    padding: 10,
                                    cornerRadius: 8,
                                }
                            },
                            scales: {
                                x: {
                                    grid: { display: false },
                                    ticks: { color: chartTextColor }
                                },
                                y: {
                                    grid: { color: chartBorderColor.replace('0.2', '0.1') },
                                    ticks: { color: chartTextColor, callback: value => `${value} ₽` },
                                    beginAtZero: true
                                }
                            }
                        }
                    });
                }
            } catch (e) { console.error("Ошибка 'Источник Дохода':", e); }
        {% endif %}

        {% if cohort_revenue_data and cohort_revenue_data != 'null' %}
            try {
                const cohortData = JSON.parse('{{ cohort_revenue_data|escapejs }}');
                const cohortCanvas = document.getElementById('cohortRevenueChart');
                if (cohortCanvas) {
                    new Chart(cohortCanvas.getContext('2d'), {
                        type: 'line',
                        data: { labels: cohortData.labels, datasets: cohortData.datasets },
                        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
                    });
                }
            } catch (e) { console.error("Ошибка 'Когорты Дохода':", e); }
        {% endif %}
        // END Отрисовка ФИНАНСОВОГО ЦЕНТРА

        {% if user_journey_data and user_journey_data != 'null' %}
            try {
                const journeyData = JSON.parse('{{ user_journey_data|escapejs }}');
                const journeyCanvas = document.getElementById('userJourneyChart');
                if (journeyCanvas) {
                    new Chart(journeyCanvas.getContext('2d'), {
                        type: 'bar',
                        data: {
                            labels: journeyData.labels,
                            datasets: [{
                                data: journeyData.data,
                                backgroundColor: [
                                    'rgba(79, 70, 229, 0.8)', // Indigo
                                    'rgba(16, 185, 129, 0.8)', // Emerald
                                    'rgba(245, 158, 11, 0.8)'  // Amber
                                ],
                                borderWidth: 0,
                                borderRadius: 4,
                                barPercentage: 0.6,
                            }]
                        },
                        options: {
                            indexAxis: 'y',
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: false },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            const rawValue = journeyData.raw_counts[context.dataIndex];
                                            const percentage = context.raw;
                                            return ` ${rawValue} пользователей (${percentage}%)`;
                                        }
                                    }
                                }
                            },
                            scales: {
                                x: {
                                    grid: { color: chartBorderColor },
                                    ticks: { 
                                        color: chartTextColor,
                                        callback: value => value + '%'
                                    },
                                    max: 100,
                                    beginAtZero: true
                                },
                                y: {
                                    grid: { display: false },
                                    ticks: { color: chartTextColor }
                                }
                            }
                        }
                    });
                }
            } catch (e) { console.error("Ошибка при отрисовке воронки:", e); }
        {% endif %}

        {% if usage_by_sub_data and usage_by_sub_data != 'null' %}
            try {
                const usageBySubData = JSON.parse('{{ usage_by_sub_data|escapejs }}');
                const usageBySubCanvas = document.getElementById('usageBySubChart');
                if (usageBySubCanvas) {
                    new Chart(usageBySubCanvas.getContext('2d'), {
                        type: 'bar',
                        data: {
                            labels: usageBySubData.labels,
                            datasets: [{
                                label: 'Среднее кол-во тестов на юзера',
                                data: usageBySubData.data,
                                backgroundColor: 'rgba(16, 185, 129, 0.8)',
                                borderColor: 'rgba(16, 185, 129, 1)',
                                borderWidth: 1,
                                borderRadius: 4,
                            }]
                        },
                        options: {
                                responsive: true, maintainAspectRatio: false,
                                plugins: {
                                    legend: { position: 'bottom', labels: { color: chartTextColor, boxWidth: 15, padding: 20 } },
                                    tooltip: { mode: 'index', intersect: false }
                                },
                                scales: {
                                    x: { stacked: true, ticks: { color: chartTextColor }, grid: { display: false } },
                                    y: { stacked: true, ticks: { color: chartTextColor, beginAtZero: true, precision: 0 }, grid: { color: chartBorderColor } }
                                }
                            }
                    });
                }
            } catch (e) { console.error("Ошибка при отрисовке графика по тарифам:", e); }
        {% endif %}

        {% if time_to_payment_data and time_to_payment_data != 'null' %}
            try {
                const ttpData = JSON.parse('{{ time_to_payment_data|escapejs }}');
                const ttpCanvas = document.getElementById('timeToPaymentChart');
                if (ttpCanvas) {
                    new Chart(ttpCanvas.getContext('2d'), {
                        type: 'bar',
                        data: {
                            labels: ttpData.labels,
                            datasets: [{
                                label: 'Количество пользователей',
                                data: ttpData.data,
                                backgroundColor: 'rgba(139, 92, 246, 0.7)',
                                borderColor: 'rgba(139, 92, 246, 1)',
                                borderRadius: 4
                            }]
                        },
                        options: { /* ... стандартные options для bar chart ... */ }
                    });
                }
            } catch (e) { console.error("Ошибка при отрисовке 'Время до покупки':", e); }
        {% endif %}

        {% if user_value_matrix_data and user_value_matrix_data != 'null' %}
            try {
                const matrixData = JSON.parse('{{ user_value_matrix_data|escapejs }}');
                const matrixCanvas = document.getElementById('userValueMatrixChart');
                if (matrixCanvas) {
                    new Chart(matrixCanvas.getContext('2d'), {
                        type: 'bubble',
                        data: {
                            datasets: [{
                                label: 'Пользователи',
                                data: matrixData,
                                backgroundColor: 'rgba(255, 255, 255, 0.2)',
                                borderColor: 'rgba(255, 255, 255, 0.5)',
                            }]
                        },
                        options: {
                            responsive: true, maintainAspectRatio: false,
                            plugins: {
                                legend: { display: false },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            const d = context.raw;
                                            return `${d.label}: ${d.x} попыток, ${d.y} ₽ доход`;
                                        }
                                    }
                                }
                            },
                            scales: {
                                x: {
                                    type: 'logarithmic', // Логарифмическая шкала для лучшей визуализации
                                    title: { display: true, text: 'Влияние (кол-во попыток на тестах)', color: chartTextColor },
                                    ticks: { color: chartTextColor },
                                },
                                y: {
                                    type: 'logarithmic',
                                    title: { display: true, text: 'Доход (₽)', color: chartTextColor },
                                    ticks: { color: chartTextColor }
                                }
                            }
                        }
                    });
                }
            } catch (e) { console.error("Ошибка при отрисовке 'Матрицы ценности':", e); }
        {% endif %}

        {% if top_topics_data and top_topics_data != 'null' %}
            try {
                const topTopicsData = JSON.parse('{{ top_topics_data|escapejs }}');
                const topTopicsCanvas = document.getElementById('topTopicsChart');
                if (topTopicsCanvas) {
                    new Chart(topTopicsCanvas.getContext('2d'), {
                        type: 'bar',
                        data: {
                            labels: topTopicsData.labels,
                            datasets: [{
                                label: 'Частота упоминаний',
                                data: topTopicsData.data,
                                backgroundColor: ['#36A2EB', '#FF6384', '#4BC0C0', '#FF9F40', '#9966FF', '#FFCD56', '#C9CBCF'],
                            }]
                        },
                        options: {
                            indexAxis: 'y',
                            responsive: true, maintainAspectRatio: false,
                            plugins: { legend: { display: false } },
                            scales: { y: { ticks: { color: chartTextColor } } }
                        }
                    });
                }
            } catch (e) { console.error("Ошибка при отрисовке графика тем:", e); }
        {% endif %}

        {% if daily_token_usage_data %}
            try {
                const tokenUsageData = JSON.parse('{{ daily_token_usage_data|escapejs }}');
                const tokenUsageCanvas = document.getElementById('dailyTokenUsageChart');
                if (tokenUsageCanvas) {
                    const accentColor = 'rgba(234, 179, 8, 1)';
                    const ctx = tokenUsageCanvas.getContext('2d');
                    const gradient = ctx.createLinearGradient(0, 0, 0, 320);
                    gradient.addColorStop(0, accentColor.replace('1)', '0.5)'));
                    gradient.addColorStop(1, accentColor.replace('1)', '0)'));

                    new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: tokenUsageData.labels,
                            datasets: [{
                                label: 'Сгенерировано токенов',
                                data: tokenUsageData.data,
                                borderColor: accentColor,
                                backgroundColor: gradient,
                                fill: true,
                                tension: 0.4,
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { display: false } },
                            scales: {
                                x: { ticks: { color: chartTextColor }, grid: { color: chartBorderColor } },
                                y: { 
                                    title: { display: true, text: 'Токены', color: chartTextColor },
                                    ticks: { color: chartTextColor, beginAtZero: true }, 
                                    grid: { color: chartBorderColor }
                                }
                            }
                        }
                    });
                }
            } catch (e) { console.error("Ошибка при отрисовке графика токенов:", e); }
        {% endif %}

        {% if api_performance_data and api_performance_data != 'null' %}
            try {
                const apiPerfData = JSON.parse('{{ api_performance_data|escapejs }}');
                const apiPerfCanvas = document.getElementById('apiPerformanceChart');
                if (apiPerfCanvas) {
                    const accentColor = '#4F46E5'; // Indigo
                    const ctx = apiPerfCanvas.getContext('2d');
                    const gradient = ctx.createLinearGradient(0, 0, 0, apiPerfCanvas.height);
                    gradient.addColorStop(0, accentColor.replace('1)', '0.5)'));
                    gradient.addColorStop(1, accentColor.replace('1)', '0)'));

                    new Chart(ctx, {
                        type: 'line',
                        data: {
                           labels: apiPerfData.labels,
                           datasets: [{
                               ...apiPerfData.datasets[0],
                               borderColor: accentColor,
                               backgroundColor: gradient,
                               fill: true,
                               tension: 0.4,
                               pointBackgroundColor: accentColor,
                               pointBorderColor: '#fff',
                               pointHoverRadius: 6
                           }]
                        },
                        options: {
                            responsive: true, maintainAspectRatio: false,
                            plugins: { legend: { display: false } },
                            scales: {
                                x: { ticks: { color: chartTextColor }, grid: { color: chartBorderColor } },
                                y: { 
                                    ticks: { color: chartTextColor, beginAtZero: true, callback: value => value + ' ms' }, 
                                    grid: { color: chartBorderColor }
                                }
                            }
                        }
                    });
                }
            } catch (e) { console.error("Ошибка при отрисовке графика производительности API:", e); }
        {% endif %}
        });
    </script>
</body>
</html>
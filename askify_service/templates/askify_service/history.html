<!DOCTYPE html>
<html lang="ru">
<head>
    {% include 'components/meta_tags.html' %}
    {% load static %}
    {% include 'components/linker.html' %}

    <!-- Yandex.Metrika counter -->
    <script type="text/javascript">
        (function(m,e,t,r,i,k,a){
            m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
            m[i].l=1*new Date();
            for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}
            k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)
        })(window, document,'script','https://mc.yandex.ru/metrika/tag.js', 'ym');
        ym(98829160, 'init', {webvisor:true, clickmap:true, accurateTrackBounce:true, trackLinks:true});
    </script>
    <noscript><div><img src="https://mc.yandex.ru/watch/98829160" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
    <!-- /Yandex.Metrika counter -->

    {% if debug %}
        <script src="https://cdn.tailwindcss.com"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    {% else %}
        <script src="{% static 'vendor/tailwind.full.min.js' %}"></script>
        <script src="{% static 'vendor/jquery.min.js' %}"></script>
    {% endif %}

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <script src="{% static 'js/second-loader.js' %}"></script>
    {% include 'components/loader.html' %}

    <div id="page-container" class="fade" style="display: none;">
        {% include 'header.html' %}
        
        <div class="container question mx-auto max-w-4xl px-4 py-8">
            <div class="head-button">
                <h2 class="history-title">История</h2>
                <a class="button-medium" href="{% url 'create' %}"> 
                    <div>
                        <p>Создать новый</p>
                        <img src="{% static 'img/icon-new.png' %}" alt="">
                    </div>
                </a>
            </div>

            <div style="display: flex; flex-direction: column; margin: 12px 0">
                <p>Всего {{ total_surveys }}</p>
            </div>
            
            <div class="relative mb-8 mt-4">
                <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-gray-500"></i>
                <input type="text" id="history-search-input" placeholder="Поиск по названию..."
                    class="w-full bg-transparent border border-[var(--color-border)] rounded-2xl py-3 pl-12 pr-4 text-white focus:outline-none focus:ring-2 focus:ring-[var(--primary-color)]">
            </div>

            <div id="surveys-list-container" class="space-y-8">
                <!-- Сгруппированные тесты здесь -->
            </div>
            
            <div class="text-center mt-12" id="load-more-container">
                {% if page_obj.has_next %}
                    <button id="load-more" data-page="1" 
                            class="bg-white/10 hover:bg-white/20 text-white font-semibold py-3 px-6 rounded-full transition-colors">
                        Загрузить еще
                    </button>
                {% endif %}
            </div>
        </div>

        <!-- {% include 'ui_components/bottom_menu.html' %} -->
    </div>
    {% include 'footer-s.html' %}

    <div id="delete-modal" class="modal-overlay hidden" onclick="closeDeleteModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-icon">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <h3>Подтвердите удаление</h3>
            <p>Вы уверены, что хотите удалить тест <br> «<strong id="modal-survey-title"></strong>»? <br>Это действие необратимо.</p>
            <div class="modal-actions">
                <button onclick="closeDeleteModal()" class="button-medium">
                    <div>
                        <p>Отмена</p>
                    </div>
                </button>
                <a id="confirm-delete-link" href="#" class="button-medium button-red">
                    <div>
                        <p>Удалить безвозвратно</p>
                    </div>
                </a>
            </div>
        </div>
    </div>

    <script>
        const modal = document.getElementById('delete-modal');
        const modalTitle = document.getElementById('modal-survey-title');
        const confirmLink = document.getElementById('confirm-delete-link');

        function openDeleteModal(surveyId, surveyTitle) {
            console.log('Открываю модалку для:', surveyTitle);
            if (!modal || !modalTitle || !confirmLink) {
                console.error('Элементы модального окна не найдены!');
                return;
            }
            
            modalTitle.textContent = surveyTitle;
            const deleteUrl = `/drop-survey/${surveyId}/`;
            confirmLink.setAttribute('href', deleteUrl);
            
            modal.classList.remove('hidden');
        }

        function closeDeleteModal() {
            console.log('Закрываю модалку');
            if (modal) {
                modal.classList.add('hidden');
            }
        }

        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape' && modal && !modal.classList.contains('hidden')) {
                closeDeleteModal();
            }
        });
    </script>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const searchInput = document.getElementById('history-search-input');
            const loadMoreBtn = document.getElementById('load-more');
            const surveysContainer = document.getElementById('surveys-list-container');
            
            const initialDataElement = document.getElementById('initial-surveys-data');
            let allSurveys = initialDataElement ? JSON.parse(initialDataElement.textContent) : {};
            
            const groupSurveysByMonth = (surveys) => {
                const grouped = {};
                for (const [id, data] of Object.entries(surveys)) {
                    const [day, month, year] = (data.create || data.update).split('.');
                    const dateObj = new Date(year, month - 1);
                    const monthKey = dateObj.toLocaleString('ru-RU', { month: 'long', year: 'numeric' });
                    const sortKey = `${year}-${String(month - 1).padStart(2, '0')}`;
                    
                    if (!grouped[sortKey]) {
                        grouped[sortKey] = { monthName: monthKey.charAt(0).toUpperCase() + monthKey.slice(1), surveys: [] };
                    }
                    grouped[sortKey].surveys.push({ id, ...data });
                }
                return Object.entries(grouped).sort((a, b) => b[0].localeCompare(a[0]));
            };

            const renderSurveys = (groupedSurveys) => {
                let html = '';
                if (groupedSurveys.length === 0) {
                    html = '<p style="text-align: center; color: var(--color-text-secondary);">Ничего не найдено.</p>';
                } else {
                    for (const [sortKey, group] of groupedSurveys) {
                        html += `<div class="month-group"><h3>${group.monthName}</h3><div class="space-y-2" style="display: flex; flex-direction: column; gap: 12px;">`;
                        group.surveys.forEach(survey => {
                            const titleForModal = survey.title.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                            const displayDate = survey.create;
                            html += `
                                <div class="survey-card">
                                    <a href="/result/${survey.id}" class="flex-grow min-w-0" style="color: inherit; text-decoration: none;">
                                        <p class="font-semibold truncate" style="color: var(--light-color); margin: 0 0 4px 0; font-weight: 600;">${survey.title}</p>
                                        <div class="flex items-center gap-4 text-xs" style="color: var(--color-text-secondary); font-size: 12px;">
                                            <span>${displayDate}</span>
                                        </div>
                                    </a>
                                    <div class="survey-card__actions" style="display: flex; align-items: center; gap: 8px; margin-left: 16px;">
                                        <div class="button-medium button-red" style="padding: 8px; width: 36px; height: 36px;" onclick="openDeleteModal('${survey.id}', '${titleForModal}')">
                                            <div><img src="{% static 'img/icon-delete.png' %}" alt="Удалить" style="width: 16px; height: 16px;"></div>
                                        </div>
                                    </div>
                                </div>
                            `;
                        });
                        html += `</div></div>`;
                    }
                }
                if (surveysContainer) {
                    surveysContainer.innerHTML = html;
                }
            };

            // --- Поиск ---
            if (searchInput) {
                let searchTimeout;
                searchInput.addEventListener('input', (e) => {
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(() => {
                        const query = e.target.value.toLowerCase();
                        const filteredSurveys = {};
                        for (const [id, data] of Object.entries(allSurveys)) {
                            if (data.title.toLowerCase().includes(query)) {
                                filteredSurveys[id] = data;
                            }
                        }
                        renderSurveys(groupSurveysByMonth(filteredSurveys));
                    }, 300);
                });
            }
            
            // --- Загрузить больше ---
            if (loadMoreBtn) {
                loadMoreBtn.addEventListener('click', function() {
                    var button = this;
                    var page_to_request = parseInt(button.getAttribute('data-page')) + 1;

                    button.disabled = true;
                    button.textContent = 'Загрузка...';

                    fetch(`/load-more-surveys/?page=${page_to_request}`, {
                        method: 'GET',
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest',
                        },
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.surveys && data.surveys.length > 0) {
                            data.surveys.forEach(s => {
                                allSurveys[s.survey_id] = { 
                                    title: s.title, 
                                    create: s.create,
                                };
                            });

                            // button.textContent = `Показать еще ${data.total_surveys}`;
                            
                            const currentQuery = searchInput ? searchInput.value.toLowerCase() : '';
                            const filtered = {};
                            for (const [id, s_data] of Object.entries(allSurveys)) {
                                if (s_data.title.toLowerCase().includes(currentQuery)) {
                                    filtered[id] = s_data;
                                }
                            }
                            renderSurveys(groupSurveysByMonth(filtered));

                            if (data.has_next) {
                                button.setAttribute('data-page', page_to_request);
                            } else {
                                button.parentElement.style.display = 'none';
                            }
                        } else {
                            button.parentElement.style.display = 'none';
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        button.textContent = 'Ошибка загрузки';
                    })
                    .finally(() => {
                        const loadMoreContainer = document.getElementById('load-more-container');
                        if (loadMoreContainer && loadMoreContainer.style.display !== 'none') {
                            button.disabled = false;
                            button.textContent = 'Загрузить еще';
                        }
                    });
                });
            }

            renderSurveys(groupSurveysByMonth(allSurveys));
        });
    </script>
    {{ surveys_data|json_script:"initial-surveys-data" }}
</body>

</html>

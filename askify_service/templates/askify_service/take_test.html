<!DOCTYPE html>
<html lang="ru">
<head>
    {% include 'components/meta_tags.html' %} 
    <meta name="csrf-token" content="{{ csrf_token }}">
    {% load static %}
    <link rel="icon" href="{% static 'img/favicon.ico' %}" type="image/ico">
    
    {% if debug %}
        <script src="https://cdn.tailwindcss.com"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    {% else %}
        <script src="{% static 'vendor/tailwind.full.min.js' %}"></script>
        <script src="{% static 'vendor/jquery.min.js' %}"></script>
    {% endif %}

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&family=Unbounded:wght@500;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --color-bg: #0F0818;
            --color-surface: rgba(30, 24, 48, 0.5);
            --color-border: rgba(97, 109, 240, 0.2);
            --color-text-primary: #f0f0f0;
            --color-text-secondary: #a0a0b0;
            --color-accent-primary: #616DF0;
            --color-accent-secondary: #79EF66;
        }
        body { background-color: var(--color-bg); font-family: 'Inter', sans-serif; }
        h1, h2, h3 { font-family: 'Unbounded', sans-serif; }
        .gradient-text {
            background: linear-gradient(45deg, var(--color-accent-primary), var(--color-accent-secondary));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fadeIn {
            animation: fadeIn 0.5s cubic-bezier(0.16, 1, 0.3, 1) both;
        }
    </style>
</head>
<body class="text-[var(--color-text-primary)]">

    <main class="min-h-screen flex flex-col items-center justify-center p-4">
        
        <div id="landing-view" class="w-full max-w-lg text-center">
            <div class="bg-[var(--color-surface)] p-8 rounded-3xl border border-[var(--color-border)] animate-fadeIn shadow-2xl shadow-black/50">

                <div class="flex justify-center my-4">
                    <a href="/">
                        <img src="{% static 'img/logo-header.webp' %}" alt="Летучка Логотип" class="w-40 h-auto">
                    </a>
                </div>

                <p class="text-sm text-[var(--color-text-secondary)]">Тест от {{ author }}</p>
                <h1 class="mt-2 text-2xl font-bold text-white">{{ survey.title }}</h1>
                <p class="mt-4 text-[var(--color-text-secondary)] max-w-md mx-auto">
                    Вам предстоит ответить на <strong>{{ survey.get_questions|length }}</strong> вопросов.
                </p>
                
                <form id="start-test-form" class="mt-8 flex flex-col">
                    <input 
                        type="text" 
                        id="student-name" 
                        class="flex-grow w-full p-4 bg-[var(--color-bg)] border-2 border-[var(--color-border)] rounded-full text-center text-lg text-white focus:outline-none focus:ring-2 focus:ring-[var(--color-accent-primary)] placeholder:text-gray-600 transition-colors" 
                        placeholder="Имя" 
                        required
                    >
                    <span class="text-xs mt-2 text-gray-400">Его увидит автор, гадости не пишите :)</span>
                    <button 
                        type="submit" 
                        id="start-button"  
                        disabled 
                        class="w-full sm:w-auto bg-gray-500 text-white px-8 py-4 mt-6 font-bold rounded-full text-lg 
                            transition-all 
                            disabled:opacity-50 disabled:bg-gray-500 disabled:shadow-none 
                            
                            // Активные стили (будут применены JS при удалении disabled)
                            enabled:bg-[var(--color-accent-primary)] 
                            enabled:hover:scale-105 
                            enabled:shadow-lg enabled:shadow-[var(--color-accent-primary)]/20"
                    >
                        Начать
                    </button>
                </form>
            </div>
        </div>

        <div id="questions-view" class="w-full max-w-2xl hidden">
            <div class="mb-4 px-2">
                <div class="w-full bg-black/30 rounded-full h-2.5">
                    <div id="progress-bar" class="bg-[var(--color-accent-primary)] h-2.5 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
                <div class="text-center text-sm text-[var(--color-text-secondary)] mt-2">Вопрос <span id="current-question-number">1</span> из {{ survey.get_questions|length }}</div>
            </div>
            
            <form id="test-form" class="space-y-6">
                <!-- Вопросы будут вставлены сюда через JS -->
            </form>
        </div>

        <div id="result-view" class="w-full max-w-lg text-center hidden">
             <div class="bg-[var(--color-surface)] p-8 rounded-3xl border border-[var(--color-border)] animate-fadeIn shadow-2xl shadow-black/50">
                <h1 class="text-4xl font-bold text-white">Ваш результат:</h1>
                <p class="text-8xl font-black gradient-text my-4"><span id="score-value"></span>/<span id="total-value"></span></p>
                <p class="text-lg text-[var(--color-text-secondary)]">Отлично! Результат отправлен автору.</p>
                <a href="{% url 'preview_test' survey.survey_id %}" class="mt-8 inline-block bg-[var(--color-accent-primary)] text-white px-10 py-4 font-bold rounded-full transition-transform hover:scale-105 shadow-lg shadow-[var(--color-accent-primary)]/20">
                    Посмотреть вопросы
                </a>
            </div>
        </div>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const nameInput = document.getElementById('student-name');
            const startButton = document.getElementById('start-button');

            function toggleButtonState() {
                if (nameInput.value.trim().length > 0) {
                    startButton.removeAttribute('disabled');
                } else {
                    startButton.setAttribute('disabled', true);
                }
            }

            nameInput.addEventListener('input', toggleButtonState);
            nameInput.addEventListener('blur', toggleButtonState);

            toggleButtonState(); 
        });
    </script>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script>
        $(document).ready(function() {
            const landingView = $('#landing-view');
            const questionsView = $('#questions-view');
            const resultView = $('#result-view');
            const testForm = $('#test-form');
            const studentNameInput = $('#student-name');
            const currentQuestionSpan = $('#current-question-number');

            let studentName = '';
            const questions = JSON.parse('{{ questions_json|escapejs }}');
            let currentQuestionIndex = 0;
            let studentAnswers = {};

            function showQuestion(index) {
                testForm.empty();
                if (index >= questions.length) {
                    submitTest();
                    return;
                }

                currentQuestionSpan.text(index + 1);
                const q = questions[index];
                
                const questionBlock = $(`
                    <div class="bg-[var(--color-surface)] rounded-3xl border border-[var(--color-border)] p-6 animate-fadeIn shadow-2xl shadow-black/50">
                        <p class="text-xl font-semibold text-white mb-5">${q.question}</p>
                        <div class="space-y-3"></div>
                    </div>
                `);

                const optionsContainer = questionBlock.find('.space-y-3');
                q.options.forEach((option, i) => {
                    // FIX: Генерируем гарантированно уникальный ID, чтобы избежать коллизий
                    const optionId = `q${index}_option${i}_${Math.random().toString(36).substring(2, 9)}`;
                    
                    const optionLabel = $(`
                        <label for="${optionId}" class="block p-4 bg-[var(--color-bg)] hover:bg-black/50 rounded-xl cursor-pointer border-2 border-[var(--color-border)] has-[:checked]:border-[var(--color-accent-primary)] has-[:checked]:bg-[var(--color-accent-primary)]/10 transition-all duration-200">
                            <input type="radio" id="${optionId}" name="question_${index}" value="${option}" class="hidden">
                            <span class="text-base text-white">${option}</span>
                        </label>
                    `);
                    optionsContainer.append(optionLabel);
                });

                testForm.append(questionBlock);
                testForm.append('<button type="submit" class="w-full mt-4 inline-block bg-[var(--color-accent-primary)] text-white px-10 py-4 font-bold rounded-full transition-transform hover:scale-105 shadow-lg shadow-[var(--color-accent-primary)]/20">Ответить</button>');
            }
            
            $('#start-test-form').on('submit', function(e) {
                e.preventDefault();
                studentName = studentNameInput.val();
                if (studentName.trim() === '') {
                    studentNameInput.css('border-color', 'red');
                    return;
                }
                landingView.addClass('hidden');
                questionsView.removeClass('hidden');
                showQuestion(currentQuestionIndex);
            });

            testForm.on('submit', async function(e) {
                e.preventDefault();
                const selectedOption = $(`input[name="question_${currentQuestionIndex}"]:checked`).val();
                if (!selectedOption) {
                    alert('Пожалуйста, выберите вариант ответа.'); 
                    return;
                }
                studentAnswers[questions[currentQuestionIndex].question] = selectedOption;
                currentQuestionIndex++;
                showQuestion(currentQuestionIndex);
            });

            async function submitTest() {
                questionsView.addClass('hidden');
                // Здесь можно добавить красивый прелоадер
                
                try {
                    const response = await fetch(`/api/t/{{ survey.survey_id }}/submit/`, {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ student_name: studentName, answers: studentAnswers })
                    });
                    const data = await response.json();
                    
                    if (data.success) {
                        $('#score-value').text(data.score);
                        $('#total-value').text(data.total);
                        resultView.removeClass('hidden');
                    } else { 
                        throw new Error(data.error || 'Unknown error'); 
                    }
                } catch (err) {
                    alert('Произошла ошибка при отправке результатов: ' + err.message);
                }
            }
        });
    </script>
</body>
</html>
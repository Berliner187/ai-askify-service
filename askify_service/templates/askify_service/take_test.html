<!DOCTYPE html>
<html lang="ru">
<head>
    {% include 'components/meta_tags.html' %} 
    <meta name="csrf-token" content="{{ csrf_token }}">
    {% load static %}
    <link rel="icon" href="{% static 'img/favicon.ico' %}" type="image/ico">
    
    {% if debug %}
        <script src="https://cdn.tailwindcss.com"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    {% else %}
        <script src="{% static 'vendor/tailwind.full.min.js' %}"></script>
        <script src="{% static 'vendor/jquery.min.js' %}"></script>
    {% endif %}

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&family=Unbounded:wght@500;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --color-bg: #0F0818;
            --color-surface: rgba(30, 24, 48, 0.5);
            --color-border: rgba(97, 109, 240, 0.2);
            --color-text-primary: #f0f0f0;
            --color-text-secondary: #a0a0b0;
            --color-accent-primary: #616DF0;
            --color-accent-secondary: #79EF66;
        }
        body { background-color: var(--color-bg); font-family: 'Inter', sans-serif; }
        h1, h2, h3 { font-family: 'Unbounded', sans-serif; }
        .gradient-text {
            background: linear-gradient(45deg, var(--color-accent-primary), var(--color-accent-secondary));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fadeIn {
            animation: fadeIn 0.5s cubic-bezier(0.16, 1, 0.3, 1) both;
        }
        .loader-animation {
            display: flex;
            gap: 8px;
            align-items: center;
            justify-content: center;
            height: 50px;
        }
        .loader-animation .bar {
            width: 12px;
            height: 100%;
            background-color: var(--color-accent-primary);
            border-radius: 6px;
            animation: bar-pulse 1.2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        .loader-animation .bar:nth-child(1) {
            animation-delay: -0.24s;
        }
        .loader-animation .bar:nth-child(2) {
            animation-delay: -0.12s;
        }
        .loader-animation .bar:nth-child(3) {
            animation-delay: 0s;
        }
        @keyframes bar-pulse {
            50% {
                transform: scaleY(0.3);
                background-color: var(--color-accent-secondary);
            }
        }
        #loader-text {
            transition: opacity 0.3s ease-in-out;
        }
    </style>
</head>
<body class="text-[var(--color-text-primary)]">

    <main class="min-h-screen flex flex-col items-center justify-center p-4">
        
        <div id="landing-view" class="w-full max-w-lg text-center">
            <div class="bg-[var(--color-surface)] p-8 rounded-3xl border border-[var(--color-border)] animate-fadeIn shadow-2xl shadow-black/50">

                <div class="flex justify-center my-4">
                    <a href="/">
                        <img src="{% static 'img/logo-header.webp' %}" alt="–õ–µ—Ç—É—á–∫–∞ –õ–æ–≥–æ—Ç–∏–ø" class="w-40 h-auto">
                    </a>
                </div>

                <p class="text-sm text-[var(--color-text-secondary)]">–¢–µ—Å—Ç –æ—Ç {{ author }}</p>
                <h1 class="mt-2 text-2xl font-bold text-white">{{ survey.title }}</h1>
                <p class="mt-4 text-[var(--color-text-secondary)] max-w-md mx-auto">
                    –í–∞–º –ø—Ä–µ–¥—Å—Ç–æ–∏—Ç –æ—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ <strong>{{ survey.get_questions|length }}</strong> –≤–æ–ø—Ä–æ—Å–æ–≤.
                </p>
                
                <form id="start-test-form" class="mt-8 flex flex-col">
                    <input 
                        type="text" 
                        id="student-name" 
                        class="flex-grow w-full p-4 bg-[var(--color-bg)] border-2 border-[var(--color-border)] rounded-full text-center text-lg text-white focus:outline-none focus:ring-2 focus:ring-[var(--color-accent-primary)] placeholder:text-gray-600 transition-colors" 
                        placeholder="–ò–º—è" 
                        required
                    >
                    <span class="text-xs mt-2 text-gray-400">–ï–≥–æ —É–≤–∏–¥–∏—Ç –∞–≤—Ç–æ—Ä (–≥–∞–¥–æ—Å—Ç–∏ –Ω–µ –ø–∏—à–∏—Ç–µ)</span>
                    <button 
                        type="submit" 
                        id="start-button"  
                        disabled 
                        class="w-full sm:w-auto bg-gray-500 text-white px-8 py-4 mt-6 font-bold rounded-full text-lg 
                            transition-all 
                            disabled:opacity-50 disabled:bg-gray-500 disabled:shadow-none 
                            enabled:bg-[var(--color-accent-primary)] 
                            enabled:hover:scale-[1.03] enabled:active:scale-[.97] 
                            enabled:shadow-lg enabled:shadow-[var(--color-accent-primary)]/20"
                    >
                        –ù–∞—á–∞—Ç—å
                    </button>
                </form>
            </div>
        </div>

        <div id="questions-view" class="w-full max-w-2xl hidden">
            <div class="mb-4 px-2">
                <div class="w-full bg-black/30 rounded-full h-2.5">
                    <div id="progress-bar" class="bg-[var(--color-accent-primary)] h-2.5 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
                <div class="text-center text-sm text-[var(--color-text-secondary)] mt-2">–í–æ–ø—Ä–æ—Å <span id="current-question-number">1</span> –∏–∑ {{ survey.get_questions|length }}</div>
            </div>
            
            <form id="test-form" class="space-y-6">
                <!-- –í–æ–ø—Ä–æ—Å—ã –±—É–¥—É—Ç –≤—Å—Ç–∞–≤–ª–µ–Ω—ã —Å—é–¥–∞ —á–µ—Ä–µ–∑ JS -->
            </form>
        </div>

        <div id="loader-view" class="fixed inset-0 bg-black/80 z-50 hidden items-center justify-center p-4 flex-col text-center" style="backdrop-filter: blur(10px);">
            <div class="loader-animation">
                <div class="bar"></div>
                <div class="bar"></div>
                <div class="bar"></div>
            </div>
            <h2 class="text-2xl font-bold text-white mt-6">–ü–æ–¥–≤–æ–¥–∏–º –∏—Ç–æ–≥–∏...</h2>
            <p class="text-gray-400 mt-2" id="loader-text">–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –≤–∞—à–∏ –æ—Ç–≤–µ—Ç—ã</p>
        </div>
            
        <div id="result-view" class="w-full max-w-lg text-center hidden">
            <div class="bg-[var(--color-surface)] p-8 rounded-3xl border border-[var(--color-border)] animate-fadeIn shadow-2xl shadow-black/50">
            <div class="flex justify-center my-4">
                <a href="/">
                    <img src="{% static 'img/logo-header.webp' %}" alt="–õ–µ—Ç—É—á–∫–∞ –õ–æ–≥–æ—Ç–∏–ø" class="w-40 h-auto">
                </a>
            </div>

            <p class="text-sm text-[var(--color-text-secondary)]">–¢–µ—Å—Ç –æ—Ç {{ author }}</p>
            <h1 class="mt-2 text-2xl font-bold text-white">{{ survey.title }}</h1>

            <p class="text-8xl font-black gradient-text my-4">
                <span id="score-value"></span>/<span id="total-value"></span>
            </p>
            <p class="text-lg text-[var(--color-text-secondary)]">–û—Ç–ª–∏—á–Ω–æ! –†–µ–∑—É–ª—å—Ç–∞—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –∞–≤—Ç–æ—Ä—É.</p>

            <button 
                id="challenge-friend-button"
                class="mt-8 w-full bg-[var(--color-accent-secondary)] text-black px-10 py-4 text-lg font-bold rounded-full transition-transform hover:scale-[1.03] active:scale-[.97] shadow-lg shadow-[var(--color-accent-secondary)]/20"
                data-base-text="–¢–µ—Å—Ç –≤ –õ–µ—Ç—É—á–∫–µ –ø–æ —Ç–µ–º–µ ¬´{{ survey.title|escapejs }}¬ª.

–ú–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: %score%/%total% üî•

–°–ª–∞–±–æ –ø–µ—Ä–µ–±–∏—Ç—å? –î–µ—Ä–∂–∏ —Å—Å—ã–ª–∫—É üëá
"
                data-share-url="{% url 'take_test' survey.survey_id %}"
            >
                <i class="fas fa-fist-raised"></i> –ë—Ä–æ—Å–∏—Ç—å –≤—ã–∑–æ–≤ –¥—Ä—É–≥—É
            </button>

            <a href="{% url 'take_test' survey.survey_id %}" class="mt-4 inline-block text-[var(--color-text-secondary)] hover:text-white text-sm">
                –ü—Ä–æ–π—Ç–∏ –∑–∞–Ω–æ–≤–æ
            </a>
            
            <p class="mt-4 text-s">–ü–æ–Ω—Ä–∞–≤–∏–ª–æ—Å—å? –°–æ–∑–¥–∞–π—Ç–µ —Å–≤–æ–π —Ç–µ—Å—Ç!</p>
            <a href="{% url 'register' %}" class="mt-2 inline-block text-[var(--color-text-secondary)] hover:text-white text-sm">
                –°–æ–∑–¥–∞—Ç—å —Å–≤–æ–π —Ç–µ—Å—Ç –≤ –õ–µ—Ç—É—á–∫–µ
            </a>
            </div>
        </div>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const nameInput = document.getElementById('student-name');
            const startButton = document.getElementById('start-button');

            function toggleButtonState() {
                if (nameInput.value.trim().length > 0) {
                    startButton.removeAttribute('disabled');
                } else {
                    startButton.setAttribute('disabled', true);
                }
            }

            nameInput.addEventListener('input', toggleButtonState);
            nameInput.addEventListener('blur', toggleButtonState);

            toggleButtonState(); 
        });
    </script>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script>
        $(document).ready(function() {
            const landingView = $('#landing-view');
            const questionsView = $('#questions-view');
            const resultView = $('#result-view');
            const testForm = $('#test-form');
            const studentNameInput = $('#student-name');
            const currentQuestionSpan = $('#current-question-number');

            let studentName = '';
            const questions = JSON.parse('{{ questions_json|escapejs }}');
            let currentQuestionIndex = 0;
            let studentAnswers = {};

            function showQuestion(index) {
                testForm.empty();
                if (index >= questions.length) {
                    submitTest();
                    return;
                }

                currentQuestionSpan.text(index + 1);
                const q = questions[index];
                
                const questionBlock = $(`
                    <div class="bg-[var(--color-surface)] rounded-3xl border border-[var(--color-border)] p-6 animate-fadeIn shadow-2xl shadow-black/50">
                        <p class="text-xl font-semibold text-white mb-5">${q.question}</p>
                        <div class="space-y-3"></div>
                    </div>
                `);

                const optionsContainer = questionBlock.find('.space-y-3');
                q.options.forEach((option, i) => {
                    const optionId = `q${index}_option${i}_${Math.random().toString(36).substring(2, 9)}`;
                    
                    const optionLabel = $(`
                        <label for="${optionId}" class="block p-4 bg-[var(--color-bg)] hover:bg-black/50 rounded-2xl cursor-pointer border-2 border-[var(--color-border)] has-[:checked]:border-[var(--color-accent-primary)] has-[:checked]:bg-[var(--color-accent-primary)]/10 transition-all duration-200">
                            <input type="radio" id="${optionId}" name="question_${index}" value="${option}" class="hidden">
                            <span class="text-base text-white">${option}</span>
                        </label>
                    `);
                    optionsContainer.append(optionLabel);
                });

                testForm.append(questionBlock);
                testForm.append('<button type="submit" class="w-full mt-4 inline-block bg-[var(--color-accent-primary)] text-white px-10 py-4 font-bold rounded-full transition-transform hover:scale-[1.03] active:scale-[.97] shadow-lg shadow-[var(--color-accent-primary)]/20">–û—Ç–≤–µ—Ç–∏—Ç—å</button>');
            }
            
            $('#start-test-form').on('submit', function(e) {
                e.preventDefault();
                studentName = studentNameInput.val();
                if (studentName.trim() === '') {
                    studentNameInput.css('border-color', 'red');
                    return;
                }
                landingView.addClass('hidden');
                questionsView.removeClass('hidden');
                showQuestion(currentQuestionIndex);
            });

            testForm.on('submit', async function(e) {
                e.preventDefault();
                const selectedOption = $(`input[name="question_${currentQuestionIndex}"]:checked`).val();
                if (!selectedOption) {
                    alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –≤–∞—Ä–∏–∞–Ω—Ç –æ—Ç–≤–µ—Ç–∞.'); 
                    return;
                }
                studentAnswers[questions[currentQuestionIndex].question] = selectedOption;
                currentQuestionIndex++;
                showQuestion(currentQuestionIndex);
            });

            async function submitTest() {
                questionsView.addClass('hidden');
                
                const loaderView = $('#loader-view');
                const loaderText = $('#loader-text');
                let textInterval;

                try {
                    loaderView.removeClass('hidden').addClass('flex');

                    const loadingPhrases = [
                        "–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –≤–∞—à–∏ –æ—Ç–≤–µ—Ç—ã...",
                        "–°—Ä–∞–≤–Ω–∏–≤–∞–µ–º —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ —Ä–µ—à–µ–Ω–∏—è–º–∏...",
                        "–ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º –∏—Ç–æ–≥–æ–≤—ã–π –±–∞–ª–ª...",
                        "AI –≥–æ—Ç–æ–≤–∏—Ç –≤–∞—à –≤–µ—Ä–¥–∏–∫—Ç...",
                        "–ü–æ—á—Ç–∏ –≥–æ—Ç–æ–≤–æ!"
                    ];
                    let phraseIndex = 0;
                    loaderText.text(loadingPhrases[phraseIndex]);

                    textInterval = setInterval(() => {
                        phraseIndex = (phraseIndex + 1) % loadingPhrases.length;
                        loaderText.css('opacity', 0);
                        setTimeout(() => {
                            loaderText.text(loadingPhrases[phraseIndex]);
                            loaderText.css('opacity', 1);
                        }, 300);
                    }, 2000);

                    const response = await fetch(`/api/t/{{ survey.survey_id }}/submit/`, {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json',
                            'X-CSRFToken': $('meta[name="csrf-token"]').attr('content')
                        },
                        body: JSON.stringify({ student_name: studentName, answers: studentAnswers })
                    });
                    const data = await response.json();
                    
                    if (data.success) {
                        $('#score-value').text(data.score);
                        $('#total-value').text(data.total);
                        resultView.removeClass('hidden');
                    } else { 
                        throw new Error(data.error || 'Unknown error'); 
                    }

                } catch (err) {
                    alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤: ' + err.message);
                    window.location.reload(); 
                } finally {
                    clearInterval(textInterval);
                    loaderView.addClass('hidden').removeClass('flex');
                }
            }

            const challengeButton = $('#challenge-friend-button');

            if (challengeButton.length) {
                challengeButton.on('click', function() {
                    const baseTextTemplate = $(this).data('base-text');
                    const shareUrl = $(this).data('share-url');
                    const score = $('#score-value').text();
                    const total = $('#total-value').text();

                    let challengeText = baseTextTemplate
                        .replace('%score%', score)
                        .replace('%total%', total);
                    
                    challengeText += '\n\n' + new URL(shareUrl, window.location.origin).href;

                    function dedent(text) {
                        const lines = text.split('\n');
                        
                        const minIndent = lines.reduce((min, line) => {
                            if (line.trim() === '') return min;
                            const indent = line.match(/^\s*/)[0].length;
                            return Math.min(min, indent);
                        }, Infinity);

                        if (minIndent === Infinity) return text;
                        
                        return lines.map(line => line.substring(minIndent)).join('\n').trim();
                    }

                    const cleanedText = dedent(challengeText);
                    
                    navigator.clipboard.writeText(cleanedText).then(() => {
                        const originalText = $(this).html();
                        $(this).html('<i class="fas fa-check-circle"></i> –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ! –û—Ç–ø—Ä–∞–≤—å –¥—Ä—É–≥—É');

                        setTimeout(() => {
                            $(this).html(originalText);
                        }, 3000);

                    }).catch(err => {
                        console.error('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –≤—ã–∑–æ–≤–∞:', err);
                    });
                });
            }

        });
    </script>
</body>
</html>
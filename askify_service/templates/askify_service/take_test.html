<!DOCTYPE html>
<html lang="ru">
<head>
    {% include 'components/meta_tags.html' %} 
    <meta name="csrf-token" content="{{ csrf_token }}">
    {% load static %}
    <link rel="icon" href="{% static 'img/favicon.ico' %}" type="image/ico">
    
    {% if debug %}
        <script src="https://cdn.tailwindcss.com"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    {% else %}
        <script src="{% static 'vendor/tailwind.full.min.js' %}"></script>
        <script src="{% static 'vendor/jquery.min.js' %}"></script>
    {% endif %}

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&family=Unbounded:wght@500;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --color-bg: #0F0818;
            --color-surface: rgba(30, 24, 48, 0.5);
            --color-border: rgba(97, 109, 240, 0.2);
            --color-text-primary: #f0f0f0;
            --color-text-secondary: #a0a0b0;
            --color-accent-primary: #616DF0;
            --color-accent-secondary: #79EF66;
        }
        body { background-color: var(--color-bg); font-family: 'Inter', sans-serif; }
        h1, h2, h3 { font-family: 'Unbounded', sans-serif; }
        .gradient-text {
            background: linear-gradient(45deg, var(--color-accent-primary), var(--color-accent-secondary));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fadeIn {
            animation: fadeIn 0.5s cubic-bezier(0.16, 1, 0.3, 1) both;
        }
    </style>
</head>
<body class="text-[var(--color-text-primary)]">

    <main class="min-h-screen flex flex-col items-center justify-center p-4">
        
        <div id="landing-view" class="w-full max-w-lg text-center">
            <div class="bg-[var(--color-surface)] p-8 rounded-3xl border border-[var(--color-border)] animate-fadeIn shadow-2xl shadow-black/50">

                <div class="flex justify-center my-4">
                    <a href="/">
                        <img src="{% static 'img/logo-header.webp' %}" alt="–õ–µ—Ç—É—á–∫–∞ –õ–æ–≥–æ—Ç–∏–ø" class="w-40 h-auto">
                    </a>
                </div>

                <p class="text-sm text-[var(--color-text-secondary)]">–¢–µ—Å—Ç –æ—Ç {{ author }}</p>
                <h1 class="mt-2 text-2xl font-bold text-white">{{ survey.title }}</h1>
                <p class="mt-4 text-[var(--color-text-secondary)] max-w-md mx-auto">
                    –í–∞–º –ø—Ä–µ–¥—Å—Ç–æ–∏—Ç –æ—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ <strong>{{ survey.get_questions|length }}</strong> –≤–æ–ø—Ä–æ—Å–æ–≤.
                </p>
                
                <form id="start-test-form" class="mt-8 flex flex-col">
                    <input 
                        type="text" 
                        id="student-name" 
                        class="flex-grow w-full p-4 bg-[var(--color-bg)] border-2 border-[var(--color-border)] rounded-full text-center text-lg text-white focus:outline-none focus:ring-2 focus:ring-[var(--color-accent-primary)] placeholder:text-gray-600 transition-colors" 
                        placeholder="–ò–º—è" 
                        required
                    >
                    <span class="text-xs mt-2 text-gray-400">–ï–≥–æ —É–≤–∏–¥–∏—Ç –∞–≤—Ç–æ—Ä (–≥–∞–¥–æ—Å—Ç–∏ –Ω–µ –ø–∏—à–∏—Ç–µ)</span>
                    <button 
                        type="submit" 
                        id="start-button"  
                        disabled 
                        class="w-full sm:w-auto bg-gray-500 text-white px-8 py-4 mt-6 font-bold rounded-full text-lg 
                            transition-all 
                            disabled:opacity-50 disabled:bg-gray-500 disabled:shadow-none 
                            enabled:bg-[var(--color-accent-primary)] 
                            enabled:hover:scale-105 
                            enabled:active:scale-0.95 
                            enabled:shadow-lg enabled:shadow-[var(--color-accent-primary)]/20"
                    >
                        –ù–∞—á–∞—Ç—å
                    </button>
                </form>
            </div>
        </div>

        <div id="questions-view" class="w-full max-w-2xl hidden">
            <div class="mb-4 px-2">
                <div class="w-full bg-black/30 rounded-full h-2.5">
                    <div id="progress-bar" class="bg-[var(--color-accent-primary)] h-2.5 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
                <div class="text-center text-sm text-[var(--color-text-secondary)] mt-2">–í–æ–ø—Ä–æ—Å <span id="current-question-number">1</span> –∏–∑ {{ survey.get_questions|length }}</div>
            </div>
            
            <form id="test-form" class="space-y-6">
                <!-- –í–æ–ø—Ä–æ—Å—ã –±—É–¥—É—Ç –≤—Å—Ç–∞–≤–ª–µ–Ω—ã —Å—é–¥–∞ —á–µ—Ä–µ–∑ JS -->
            </form>
        </div>

        <div id="result-view" class="w-full max-w-lg text-center hidden">
            <div class="bg-[var(--color-surface)] p-8 rounded-3xl border border-[var(--color-border)] animate-fadeIn shadow-2xl shadow-black/50">
            <h1 class="text-4xl font-bold text-white">–í–∞—à —Ä–µ–∑—É–ª—å—Ç–∞—Ç:</h1>
            <p class="text-8xl font-black gradient-text my-4">
                <span id="score-value"></span>/<span id="total-value"></span>
            </p>
            <p class="text-lg text-[var(--color-text-secondary)]">–û—Ç–ª–∏—á–Ω–æ! –†–µ–∑—É–ª—å—Ç–∞—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –∞–≤—Ç–æ—Ä—É.</p>

            <button 
                id="challenge-friend-button"
                class="mt-8 w-full bg-[var(--color-accent-secondary)] text-black px-10 py-4 text-lg font-bold rounded-full transition-transform hover:scale-105 shadow-lg shadow-[var(--color-accent-secondary)]/20"
                data-base-text="–ü—Ä–æ–≤–µ—Ä–∏–ª(–∞) –∑–Ω–∞–Ω–∏—è –ø–æ —Ç–µ–º–µ ¬´{{ survey.title|escapejs }}¬ª.

–ú–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: %score%/%total% üî•

–°–º–æ–∂–µ—à—å –ª—É—á—à–µ? –ë—Ä–æ—Å–∞—é –≤—ã–∑–æ–≤ üëá
"
                data-share-url="{% url 'take_test' survey.survey_id %}"
            >
                <i class="fas fa-fist-raised"></i> –ë—Ä–æ—Å–∏—Ç—å –≤—ã–∑–æ–≤ –¥—Ä—É–≥—É
            </button>
            
            <a href="/" class="mt-4 inline-block text-[var(--color-text-secondary)] hover:text-white text-sm">
                –°–æ–∑–¥–∞—Ç—å —Å–≤–æ–π —Ç–µ—Å—Ç –Ω–∞ –õ–µ—Ç—É—á–∫–µ
            </a>
            </div>
        </div>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const nameInput = document.getElementById('student-name');
            const startButton = document.getElementById('start-button');

            function toggleButtonState() {
                if (nameInput.value.trim().length > 0) {
                    startButton.removeAttribute('disabled');
                } else {
                    startButton.setAttribute('disabled', true);
                }
            }

            nameInput.addEventListener('input', toggleButtonState);
            nameInput.addEventListener('blur', toggleButtonState);

            toggleButtonState(); 
        });
    </script>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script>
        $(document).ready(function() {
            const landingView = $('#landing-view');
            const questionsView = $('#questions-view');
            const resultView = $('#result-view');
            const testForm = $('#test-form');
            const studentNameInput = $('#student-name');
            const currentQuestionSpan = $('#current-question-number');

            let studentName = '';
            const questions = JSON.parse('{{ questions_json|escapejs }}');
            let currentQuestionIndex = 0;
            let studentAnswers = {};

            function showQuestion(index) {
                testForm.empty();
                if (index >= questions.length) {
                    submitTest();
                    return;
                }

                currentQuestionSpan.text(index + 1);
                const q = questions[index];
                
                const questionBlock = $(`
                    <div class="bg-[var(--color-surface)] rounded-3xl border border-[var(--color-border)] p-6 animate-fadeIn shadow-2xl shadow-black/50">
                        <p class="text-xl font-semibold text-white mb-5">${q.question}</p>
                        <div class="space-y-3"></div>
                    </div>
                `);

                const optionsContainer = questionBlock.find('.space-y-3');
                q.options.forEach((option, i) => {
                    const optionId = `q${index}_option${i}_${Math.random().toString(36).substring(2, 9)}`;
                    
                    const optionLabel = $(`
                        <label for="${optionId}" class="block p-4 bg-[var(--color-bg)] hover:bg-black/50 rounded-2xl cursor-pointer border-2 border-[var(--color-border)] has-[:checked]:border-[var(--color-accent-primary)] has-[:checked]:bg-[var(--color-accent-primary)]/10 transition-all duration-200">
                            <input type="radio" id="${optionId}" name="question_${index}" value="${option}" class="hidden">
                            <span class="text-base text-white">${option}</span>
                        </label>
                    `);
                    optionsContainer.append(optionLabel);
                });

                testForm.append(questionBlock);
                testForm.append('<button type="submit" class="w-full mt-4 inline-block bg-[var(--color-accent-primary)] text-white px-10 py-4 font-bold rounded-full transition-transform hover:scale-105 shadow-lg shadow-[var(--color-accent-primary)]/20">–û—Ç–≤–µ—Ç–∏—Ç—å</button>');
            }
            
            $('#start-test-form').on('submit', function(e) {
                e.preventDefault();
                studentName = studentNameInput.val();
                if (studentName.trim() === '') {
                    studentNameInput.css('border-color', 'red');
                    return;
                }
                landingView.addClass('hidden');
                questionsView.removeClass('hidden');
                showQuestion(currentQuestionIndex);
            });

            testForm.on('submit', async function(e) {
                e.preventDefault();
                const selectedOption = $(`input[name="question_${currentQuestionIndex}"]:checked`).val();
                if (!selectedOption) {
                    alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –≤–∞—Ä–∏–∞–Ω—Ç –æ—Ç–≤–µ—Ç–∞.'); 
                    return;
                }
                studentAnswers[questions[currentQuestionIndex].question] = selectedOption;
                currentQuestionIndex++;
                showQuestion(currentQuestionIndex);
            });

            async function submitTest() {
                questionsView.addClass('hidden');
                // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∫—Ä–∞—Å–∏–≤—ã–π –ø—Ä–µ–ª–æ–∞–¥–µ—Ä
                
                try {
                    const response = await fetch(`/api/t/{{ survey.survey_id }}/submit/`, {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ student_name: studentName, answers: studentAnswers })
                    });
                    const data = await response.json();
                    
                    if (data.success) {
                        $('#score-value').text(data.score);
                        $('#total-value').text(data.total);
                        resultView.removeClass('hidden');
                    } else { 
                        throw new Error(data.error || 'Unknown error'); 
                    }
                } catch (err) {
                    alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤: ' + err.message);
                }
            }

            const challengeButton = $('#challenge-friend-button');

            if (challengeButton.length) {
                challengeButton.on('click', function() {
                    const baseTextTemplate = $(this).data('base-text');
                    const shareUrl = $(this).data('share-url');
                    const score = $('#score-value').text();
                    const total = $('#total-value').text();

                    // 1. –§–æ—Ä–º–∏—Ä—É–µ–º —Å—ã—Ä–æ–π —Ç–µ–∫—Å—Ç
                    let challengeText = baseTextTemplate
                        .replace('%score%', score)
                        .replace('%total%', total);
                    
                    challengeText += '\n\n' + new URL(shareUrl, window.location.origin).href;

                    // 2. –§–ò–ù–ê–õ–¨–ù–û–ï –†–ï–®–ï–ù–ò–ï: –§—É–Ω–∫—Ü–∏—è "–¥–µ–¥–µ–Ω—Ç–∞—Ü–∏–∏"
                    function dedent(text) {
                        const lines = text.split('\n');
                        
                        // –ù–∞—Ö–æ–¥–∏–º –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –æ—Ç—Å—Ç—É–ø —Å—Ä–µ–¥–∏ –≤—Å–µ—Ö –ù–ï–ü–£–°–¢–´–• —Å—Ç—Ä–æ–∫
                        const minIndent = lines.reduce((min, line) => {
                            if (line.trim() === '') return min; // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏
                            const indent = line.match(/^\s*/)[0].length;
                            return Math.min(min, indent);
                        }, Infinity);

                        // –ï—Å–ª–∏ –æ—Ç—Å—Ç—É–ø –Ω–∞–π–¥–µ–Ω, —É–±–∏—Ä–∞–µ–º –µ–≥–æ —Å –∫–∞–∂–¥–æ–π —Å—Ç—Ä–æ–∫–∏
                        if (minIndent === Infinity) return text; // –ù–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ –≤—Å–µ —Å—Ç—Ä–æ–∫–∏ –ø—É—Å—Ç—ã–µ
                        
                        return lines.map(line => line.substring(minIndent)).join('\n').trim();
                    }

                    // 3. –ü—Ä–∏–º–µ–Ω—è–µ–º –Ω–∞—à—É –º–∞–≥–∏—é
                    const cleanedText = dedent(challengeText);
                    
                    // 4. –ö–æ–ø–∏—Ä—É–µ–º –∏–¥–µ–∞–ª—å–Ω–æ —á–∏—Å—Ç—ã–π —Ç–µ–∫—Å—Ç
                    navigator.clipboard.writeText(cleanedText).then(() => {
                        const originalText = $(this).html();
                        $(this).html('<i class="fas fa-check-circle"></i> –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ! –û—Ç–ø—Ä–∞–≤—å –¥—Ä—É–≥—É');

                        setTimeout(() => {
                            $(this).html(originalText);
                        }, 3000);

                    }).catch(err => {
                        console.error('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –≤—ã–∑–æ–≤–∞:', err);
                    });
                });
            }

        });
    </script>
</body>
</html>